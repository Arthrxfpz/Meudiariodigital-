<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Diário Digital</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Poppins', sans-serif;
    background: #0a0a0a;
    background-image: radial-gradient(at 20% 30%, rgba(19,19,19,0.8) 0px, transparent 50%),
                      radial-gradient(at 80% 70%, rgba(30,30,30,0.6) 0px, transparent 50%);
    color: #ffffff;
    min-height: 100vh;
    padding: 20px;
    animation: fadeIn 0.5s ease;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes scaleIn { from { transform: scale(0.95) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
.container { max-width: 900px; margin: 0 auto; }
header { text-align: center; padding: 40px 0 20px; animation: slideDown 0.6s ease; }
h1 { font-size: 3em; margin-bottom: 10px; background: linear-gradient(135deg, #ffffff 0%, #b8b8b8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700; letter-spacing: -1px; }
.subtitle { color: #888; font-size: 1.2em; font-weight: 300; letter-spacing: 0.5px; }
.controls { display: flex; gap: 15px; margin: 30px 0; flex-wrap: wrap; animation: slideUp 0.6s ease; }
.search-box { flex: 1; min-width: 250px; position: relative; }
.search-box input { width: 100%; padding: 14px 45px 14px 20px; background: rgba(26,26,26,0.8); backdrop-filter: blur(10px); border: 2px solid #2a2a2a; border-radius: 12px; color: #fff; font-size: 1em; transition: all 0.3s ease; font-weight: 400; font-family: 'Poppins', sans-serif; }
.search-box input:focus { outline: none; border-color: #444; background: rgba(26,26,26,1); box-shadow: 0 0 20px rgba(255,255,255,0.05); }
.search-box i { position: absolute; right: 18px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none; }
.controls-group { display: flex; gap: 10px; flex-wrap: wrap; }
.btn { padding: 14px 28px; background: rgba(42,42,42,0.8); backdrop-filter: blur(10px); border: 1px solid #2a2a2a; border-radius: 12px; color: #fff; cursor: pointer; font-size: 0.95em; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; font-family: 'Poppins', sans-serif; }
.btn:hover { background: rgba(51,51,51,0.9); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); border-color: #3a3a3a; }
.btn:active { transform: translateY(0); }
.btn-primary { background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
.btn-primary:hover { background: linear-gradient(135deg, #3a3a3a 0%, #4a4a4a 100%); }
.filter-tags-wrap { margin-bottom: 20px; animation: slideUp 0.7s ease; }
.filter-tags { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; padding-bottom: 4px; flex-wrap: nowrap; }
.filter-tags::-webkit-scrollbar { display: none; }
.filter-tags.expanded { flex-wrap: wrap; overflow-x: visible; }
.filter-tags-toggle { display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; font-size: 0.8em; color: #555; cursor: pointer; transition: color 0.2s; }
.filter-tags-toggle:hover { color: #999; }
.filter-tag { padding: 8px 15px; background: #1a1a1a; border: 2px solid #2a2a2a; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; }
.filter-tag:hover { border-color: #444; transform: scale(1.05); }
.filter-tag.active { background: #3a3a3a; border-color: #555; }
/* === MODAL PUBLICAÇÃO REDESIGN === */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 1000; animation: fadeIn 0.3s ease; overflow-y: auto; padding: 20px; }
.modal.show { display: flex; align-items: center; justify-content: center; }
.modal-content { background:rgba(18,18,18,0.99); backdrop-filter:blur(30px); padding:0; border-radius:24px; max-width:660px; width:100%; max-height:92vh; overflow-y:auto; animation: scaleIn 0.3s ease; border:1px solid rgba(255,255,255,0.06); box-shadow:0 30px 80px rgba(0,0,0,0.9); }
.modal-top-bar { display:flex; justify-content:space-between; align-items:center; padding:22px 28px 16px; border-bottom:1px solid rgba(255,255,255,0.05); position:sticky; top:0; background:rgba(18,18,18,0.98); backdrop-filter:blur(20px); z-index:10; border-radius:24px 24px 0 0; }
.modal-top-bar h2 { font-size:1.25em; font-weight:600; letter-spacing:-0.3px; display:flex; align-items:center; gap:10px; }
.modal-top-bar h2 .modal-icon { width:34px; height:34px; border-radius:10px; background:rgba(255,255,255,0.07); display:flex; align-items:center; justify-content:center; font-size:0.95em; }
.form-body { padding:24px 28px; display:flex; flex-direction:column; gap:20px; }
.form-field { display:flex; flex-direction:column; gap:8px; }
.form-field-label { display:flex; align-items:center; gap:8px; font-size:0.78em; font-weight:600; color:#555; text-transform:uppercase; letter-spacing:0.8px; }
.form-field-label i { font-size:0.95em; }
.form-field input, .form-field textarea { width:100%; padding:14px 16px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:12px; color:#fff; font-size:1em; transition:all 0.25s ease; font-family:'Poppins',sans-serif; font-weight:400; }
.form-field input:focus, .form-field textarea:focus { outline:none; border-color:rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); box-shadow:0 0 0 3px rgba(255,255,255,0.03); }
.form-field input::placeholder, .form-field textarea::placeholder { color:#333; }
.form-field textarea { resize:vertical; min-height:130px; line-height:1.7; }
.title-field-wrap { position:relative; }
.title-field-wrap input { font-size:1.05em; font-weight:500; }
.char-badge { position:absolute; right:14px; bottom:12px; font-size:0.7em; color:#333; background:rgba(0,0,0,0.4); padding:2px 8px; border-radius:8px; pointer-events:none; transition:color 0.2s; }
.char-badge.warning { color:#ffaa00; }
/* Mood strip */
.mood-strip { display:flex; gap:6px; overflow-x:auto; scrollbar-width:none; padding:4px 2px 6px; }
.mood-strip::-webkit-scrollbar { display:none; }
.mood-pill { padding:8px 14px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.07); border-radius:30px; cursor:pointer; transition:all 0.25s ease; font-size:1.1em; flex-shrink:0; display:flex; align-items:center; gap:6px; }
.mood-pill:hover { background:rgba(255,255,255,0.08); border-color:rgba(255,255,255,0.14); transform:scale(1.05); }
.mood-pill.selected { background:rgba(255,255,255,0.1); border-color:rgba(255,255,255,0.25); box-shadow:0 2px 10px rgba(0,0,0,0.4); }
.mood-pill-label { font-size:0.65em; color:#666; font-weight:600; letter-spacing:0.3px; text-transform:uppercase; display:none; }
.mood-pill.selected .mood-pill-label { display:inline; color:#aaa; }
/* Media upload zone */
.media-section { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.upload-zone { border:1.5px dashed rgba(255,255,255,0.1); border-radius:14px; padding:18px 12px; text-align:center; cursor:pointer; transition:all 0.25s ease; background:rgba(255,255,255,0.02); }
.upload-zone:hover { border-color:rgba(255,255,255,0.2); background:rgba(255,255,255,0.04); }
.upload-zone input[type=file] { position:absolute; left:-9999px; }
.upload-zone-icon { font-size:1.6em; color:#333; margin-bottom:6px; display:block; transition:color 0.25s; }
.upload-zone:hover .upload-zone-icon { color:#555; }
.upload-zone-label { font-size:0.75em; color:#444; font-weight:500; }
.upload-zone-sub { font-size:0.68em; color:#333; margin-top:3px; }
/* Images grid in form */
.images-preview-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:6px; margin-top:10px; }
.img-preview-item { position:relative; border-radius:8px; overflow:hidden; aspect-ratio:1; }
.img-preview-item img { width:100%; height:100%; object-fit:cover; display:block; }
.img-preview-item .rm-img-btn { position:absolute; top:4px; right:4px; background:rgba(244,67,54,0.85); border:none; color:#fff; width:20px; height:20px; border-radius:50%; cursor:pointer; font-size:0.7em; display:flex; align-items:center; justify-content:center; }
/* Hashtag */
.hashtag-input-wrapper { position:relative; }
.hashtag-suggestions { position:absolute; top:100%; left:0; right:0; background:#0d0d0d; border:1px solid #2a2a2a; border-top:none; border-radius:0 0 10px 10px; max-height:180px; overflow-y:auto; z-index:100; display:none; }
.hashtag-suggestions.show { display:block; }
.hashtag-suggestion { padding:10px 14px; cursor:pointer; transition:background 0.15s; display:flex; align-items:center; gap:8px; font-size:0.9em; }
.hashtag-suggestion:hover { background:#1a1a1a; }
.selected-hashtags { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
.hashtag-chip { padding:5px 12px; background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.1); border-radius:20px; display:flex; align-items:center; gap:7px; font-size:0.82em; animation:scaleIn 0.2s ease; }
.hashtag-chip button { background:none; border:none; color:#666; cursor:pointer; padding:0; font-size:1em; transition:color 0.2s; }
.hashtag-chip button:hover { color:#ff4444; }
/* Lock toggle */
.lock-toggle-row { display:flex; align-items:center; gap:12px; padding:14px 16px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.07); border-radius:12px; cursor:pointer; transition:all 0.2s; }
.lock-toggle-row:hover { border-color:rgba(255,255,255,0.12); background:rgba(255,255,255,0.05); }
.lock-toggle-row input[type=checkbox] { width:16px; height:16px; cursor:pointer; accent-color:#888; }
.lock-toggle-row label { cursor:pointer; color:#888; font-size:0.88em; margin:0; display:flex; align-items:center; gap:8px; }
.post-pw-field { display:none; margin-top:10px; }
.post-pw-field.show { display:block; }
/* Form footer */
.form-footer { padding:16px 28px 24px; border-top:1px solid rgba(255,255,255,0.05); display:flex; gap:10px; position:sticky; bottom:0; background:rgba(18,18,18,0.97); backdrop-filter:blur(20px); border-radius:0 0 24px 24px; }
.form-footer .btn { flex:1; justify-content:center; padding:14px; border-radius:14px; font-size:0.95em; }
.form-footer .btn-primary { background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.06)); border:1px solid rgba(255,255,255,0.15); color:#fff; }
.form-footer .btn-primary:hover { background:linear-gradient(135deg,rgba(255,255,255,0.15),rgba(255,255,255,0.1)); }
/* OLD form-group kept for non-post modals */
.form-group { margin-bottom: 20px; }
.form-group label { display: flex; margin-bottom: 8px; color: #bbb; font-size: 0.9em; font-weight: 500; align-items: center; gap: 8px; }
.form-group input, .form-group textarea { width: 100%; padding: 13px 15px; background: rgba(10,10,10,0.6); border: 1px solid #2a2a2a; border-radius: 12px; color: #fff; font-size: 1em; transition: all 0.3s ease; font-family: 'Poppins', sans-serif; }
.form-group input:focus, .form-group textarea:focus { outline: none; border-color: #444; background: rgba(10,10,10,0.8); }
.form-group textarea { resize: vertical; min-height: 100px; line-height: 1.6; }
.char-counter { margin-left: auto; font-size: 0.82em; color: #666; font-weight: 400; }
.char-counter.warning { color: #ffaa00; }
/* OLD file label */
.file-input-wrapper { position: relative; display: block; width: 100%; }
.file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
.file-input-label { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; background: #0a0a0a; border: 2px dashed #2a2a2a; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; color: #aaa; }
.file-input-label:hover { border-color: #444; background: #131313; }
.file-preview { margin-top: 12px; padding: 12px; background: #0a0a0a; border-radius: 8px; display: none; }
.file-preview.show { display: block; }
.remove-file-btn { background: rgba(244,67,54,0.15); border: 1px solid rgba(244,67,54,0.3); color: #f44336; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.82em; margin-top: 8px; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s ease; font-family: 'Poppins', sans-serif; }
.remove-file-btn:hover { background: rgba(244,67,54,0.25); }
/* OLD modal-header kept for stats/gallery/etc modals */
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 26px; padding-bottom: 18px; border-bottom: 1px solid #2a2a2a; }
.modal-header h2 { font-size: 1.7em; font-weight: 600; letter-spacing: -0.5px; }
.close-btn { background: rgba(42,42,42,0.5); border: 1px solid #3a3a3a; color: #fff; font-size: 1.3em; cursor: pointer; transition: all 0.3s ease; width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
.close-btn:hover { background: rgba(51,51,51,0.8); transform: rotate(90deg); border-color: #4a4a4a; }
/* Posts */
.posts-container { display: flex; flex-direction: column; gap: 16px; }
.post { background: rgba(18,18,18,0.95); backdrop-filter: blur(10px); border-radius: 16px; border: 1px solid rgba(255,255,255,0.06); transition: all 0.3s cubic-bezier(0.4,0,0.2,1); animation: slideUp 0.5s ease; position: relative; overflow: hidden; }
.post::after { content:''; position:absolute; top:0; left:0; width:3px; height:100%; background:rgba(255,255,255,0.07); transition: background 0.3s; }
.post:hover { border-color: rgba(255,255,255,0.1); box-shadow: 0 12px 36px rgba(0,0,0,0.5); transform: translateY(-2px); }
.post:hover::after { background:rgba(255,255,255,0.14); }
.post.pinned { border-color: rgba(200,200,200,0.12); background: rgba(22,22,22,0.98); }
.post.pinned::after { background: rgba(255,255,255,0.22); }
.post.draft { border-style: dashed; border-color: rgba(255,193,7,0.2); }
.post.draft::after { background: rgba(255,255,255,0.07); }
/* Post inner layout */
.post-inner { padding: 20px 20px 0 24px; }
.post-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 10px; }
.post-title-section { flex: 1; min-width: 0; }
.post-actions { display: flex; gap: 5px; flex-shrink: 0; opacity: 0.45; transition: opacity 0.2s; }
.post:hover .post-actions { opacity: 1; }
.post-action-btn { background: rgba(42,42,42,0.5); border: 1px solid rgba(255,255,255,0.07); color: #666; width: 34px; height: 34px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; font-size: 0.82em; }
.post-action-btn:hover { background: rgba(55,55,55,0.8); color: #ccc; border-color: rgba(255,255,255,0.12); }
.post-action-btn.active { color: #ffaa00; border-color: rgba(255,170,0,0.3); background: rgba(255,170,0,0.08); }
.post-badges { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
.badge { padding: 3px 10px; border-radius: 6px; font-size: 0.72em; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; letter-spacing: 0.2px; }
.badge-pinned { background: rgba(100,100,100,0.15); color: #999; border: 1px solid rgba(255,255,255,0.08); }
.badge-draft { background: rgba(255,193,7,0.08); color: #ffc107; border: 1px solid rgba(255,193,7,0.15); }
.badge-favorite { background: rgba(255,170,0,0.08); color: #ffaa00; border: 1px solid rgba(255,170,0,0.15); }
.badge-edited { background: rgba(33,150,243,0.08); color: #64b5f6; border: 1px solid rgba(33,150,243,0.12); }
.badge-locked { background: rgba(156,39,176,0.08); color: #ce93d8; border: 1px solid rgba(156,39,176,0.15); }
.post-mood-display { display: inline-flex; align-items: center; gap: 6px; margin-bottom: 6px; font-size: 0.82em; color: #666; }
.post-mood-display .mood-emoji { font-size: 1.05em; }
.post-title { font-size: 1.3em; font-weight: 600; color: #f0f0f0; letter-spacing: -0.2px; margin-bottom: 5px; line-height: 1.3; }
.post-time { display: flex; align-items: center; gap: 6px; color: #444; font-size: 0.78em; flex-wrap: wrap; }
.separator { color: #333; }
.edited-info { color: #444; font-style: italic; }
/* Post body */
.post-body { padding: 12px 20px 12px 24px; }
.post-description { line-height: 1.72; color: #bbb; font-weight: 400; font-size: 0.95em; }
.post-description a.ext-link { color: #7bb3ff; text-decoration: underline; cursor: pointer; }
.post-description a.ext-link:hover { color: #a8cbff; }
/* Post footer */
.post-footer-bar { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 10px 20px 14px 24px; border-top: 1px solid rgba(255,255,255,0.04); margin-top: 10px; }
.post-hashtags-row { display: flex; gap: 6px; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; flex: 1; align-items: center; }
.post-hashtags-row::-webkit-scrollbar { display: none; }
.post-hashtag { padding: 4px 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); border-radius: 10px; font-size: 0.76em; color: #666; cursor: pointer; transition: all 0.2s ease; font-weight: 500; flex-shrink: 0; white-space: nowrap; display: flex; align-items: center; gap: 4px; }
.post-hashtag:hover { background: rgba(255,255,255,0.08); color: #ccc; border-color: rgba(255,255,255,0.12); }
.post-media { margin: 0 0 0 0; border-radius: 0; overflow: hidden; }
.post-media img { width: 100%; display: block; max-height: 440px; object-fit: cover; }
.post-wordcount { font-size: 0.73em; color: #3a3a3a; padding: 6px 0 0; }
.empty-state { text-align: center; padding: 60px 20px; color: #666; }
.empty-state i { font-size: 4em; margin-bottom: 20px; opacity: 0.3; display: block; }
.empty-state h3 { font-size: 1.5em; margin-bottom: 10px; }
/* Custom Popup */
.custom-popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999999; align-items: center; justify-content: center; }
.custom-popup.show { display: flex; }
.popup-content { background: rgba(26,26,26,0.98); backdrop-filter: blur(20px); padding: 30px; border-radius: 20px; max-width: 420px; width: 90%; border: 1px solid #2a2a2a; box-shadow: 0 20px 60px rgba(0,0,0,0.8); animation: scaleIn 0.3s ease; text-align: center; }
.popup-icon { font-size: 3em; margin-bottom: 20px; }
.popup-icon.warning { color: #ff9800; }
.popup-icon.success { color: #4caf50; }
.popup-icon.error { color: #f44336; }
.popup-icon.info { color: #2196f3; }
.popup-title { font-size: 1.5em; font-weight: 600; margin-bottom: 15px; color: #fff; }
.popup-message { font-size: 1em; color: #aaa; margin-bottom: 25px; line-height: 1.5; word-break: break-all; }
.popup-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
.popup-btn { padding: 12px 28px; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: 500; transition: all 0.3s ease; font-family: 'Poppins', sans-serif; }
.popup-btn-confirm { background: linear-gradient(135deg, #f44336, #d32f2f); color: #fff; }
.popup-btn-confirm:hover { transform: translateY(-2px); }
.popup-btn-cancel { background: rgba(42,42,42,0.8); color: #fff; border: 1px solid #3a3a3a; }
.popup-btn-cancel:hover { background: rgba(51,51,51,0.9); }
.popup-btn-ok { background: linear-gradient(135deg, #4caf50, #388e3c); color: #fff; }
.popup-btn-ok:hover { transform: translateY(-2px); }
.popup-btn-link { background: linear-gradient(135deg, #1565c0, #0d47a1); color: #fff; }
.popup-btn-link:hover { transform: translateY(-2px); }
/* Mobile Menu */
.mobile-menu-btn { display: none; position: fixed; bottom: 20px; left: 20px; width: 56px; height: 56px; background: rgba(30,30,30,0.95); border: 1px solid #3a3a3a; border-radius: 50%; color: #fff; font-size: 1.4em; cursor: pointer; z-index: 999; box-shadow: 0 8px 25px rgba(0,0,0,0.5); transition: all 0.3s ease; }
.mobile-menu-btn:active { transform: scale(0.95); }
.mobile-fab { display: flex; position: fixed; bottom: 28px; right: 28px; left: auto; transform: none; width: 60px; height: 60px; background: linear-gradient(135deg, #3a3a3a, #555); border: 1px solid #555; border-radius: 50%; color: #fff; font-size: 1.6em; cursor: pointer; z-index: 999; box-shadow: 0 8px 30px rgba(0,0,0,0.6); transition: all 0.3s ease; align-items: center; justify-content: center; }
.mobile-fab:hover { background: linear-gradient(135deg, #555, #666); transform: scale(1.08); box-shadow: 0 12px 35px rgba(0,0,0,0.7); }
.mobile-fab:active { transform: scale(0.94); }
/* Lightbox */
.lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.96); z-index: 50000; align-items: center; justify-content: center; }
.lightbox.show { display: flex; }
.lightbox-img { max-width: 95vw; max-height: 92vh; object-fit: contain; border-radius: 4px; animation: scaleIn 0.25s ease; }
.lightbox-close { position: absolute; top: 18px; right: 22px; background: rgba(40,40,40,0.8); border: 1px solid #444; color: #fff; width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2em; transition: all 0.2s ease; z-index: 10; }
.lightbox-close:hover { background: rgba(60,60,60,0.9); }
.lightbox-prev, .lightbox-next { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(40,40,40,0.7); border: 1px solid #444; color: #fff; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2em; transition: all 0.2s ease; z-index: 10; }
.lightbox-prev { left: 16px; }
.lightbox-next { right: 16px; }
.lightbox-prev:hover, .lightbox-next:hover { background: rgba(70,70,70,0.9); }
.lightbox-counter { position: absolute; bottom: 18px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: #ccc; font-size: 0.82em; padding: 5px 14px; border-radius: 20px; }
.mobile-menu { display: none; position: fixed; bottom: 86px; left: 20px; background: rgba(26,26,26,0.98); backdrop-filter: blur(20px); border: 1px solid #2a2a2a; border-radius: 15px; padding: 10px; z-index: 998; box-shadow: 0 10px 40px rgba(0,0,0,0.6); animation: slideUp 0.3s ease; min-width: 220px; }
.mobile-menu.show { display: block; }
.mobile-menu-item { padding: 15px 20px; cursor: pointer; transition: all 0.2s ease; border-radius: 10px; display: flex; align-items: center; gap: 12px; color: #ccc; font-size: 0.95em; white-space: nowrap; }
.mobile-menu-item:hover { background: rgba(42,42,42,0.8); color: #fff; }
.mobile-menu-item i { width: 20px; text-align: center; }
.mobile-divider { height: 1px; background: #2a2a2a; margin: 5px 0; }
/* Section Headers */
.section-header { display: flex; align-items: center; justify-content: space-between; margin: 30px 0 20px 0; padding-bottom: 15px; border-bottom: 2px solid #2a2a2a; }
.section-title { font-size: 1.4em; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 10px; }
/* View Mode Toggle */
.view-mode-toggle { display: flex; gap: 5px; background: rgba(26,26,26,0.8); padding: 5px; border-radius: 12px; border: 1px solid #2a2a2a; }
.view-mode-btn { padding: 10px 16px; background: transparent; border: none; color: #666; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; font-size: 1.1em; }
.view-mode-btn.active { background: rgba(42,42,42,0.8); color: #fff; }
.view-mode-btn:hover:not(.active) { color: #aaa; }
/* Grid View */
.posts-container.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
.posts-container.grid-view .post { height: 100%; display: flex; flex-direction: column; }
.posts-container.grid-view .post-body { flex: 1; }
.posts-container.grid-view .post-description { overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
/* Dropdown */
.dropdown { position: relative; display: inline-block; }
.dropdown-content { display: none; position: absolute; right: 0; background: rgba(26,26,26,0.98); backdrop-filter: blur(10px); min-width: 200px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); border-radius: 12px; z-index: 1000; border: 1px solid #2a2a2a; overflow: hidden; margin-top: 5px; }
.dropdown-content.show { display: block; }
.dropdown-item { padding: 12px 18px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 12px; color: #ccc; font-size: 0.95em; }
.dropdown-item:hover { background: rgba(42,42,42,0.8); color: #fff; }
.dropdown-item i { width: 18px; text-align: center; }
.dropdown-divider { height: 1px; background: #2a2a2a; margin: 5px 0; }
/* Mood */
.mood-selector { display: flex; gap: 10px; flex-wrap: wrap; }
.mood-option { padding: 10px 16px; background: rgba(26,26,26,0.6); border: 1px solid #2a2a2a; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 1.4em; display: flex; align-items: center; justify-content: center; min-width: 50px; min-height: 50px; }
.mood-option:hover { border-color: #3a3a3a; transform: scale(1.05); }
.mood-option.selected { background: rgba(42,42,42,0.8); border-color: #555; box-shadow: 0 0 0 2px #555; }
/* Scrollbar */
::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: #0a0a0a; }
::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: #3a3a3a; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
/* Carousel */
.carousel-wrapper { position: relative; border-radius: 0; overflow: hidden; margin: 0; user-select: none; }
.carousel-track { display: flex; transition: transform 0.35s ease; will-change: transform; }
.carousel-slide { min-width: 100%; flex-shrink: 0; }
.carousel-slide img { width: 100%; max-height: 440px; object-fit: cover; display: block; }
.carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.55); border: none; color: #fff; width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; font-size: 1.1em; transition: all 0.2s ease; }
.carousel-btn:hover { background: rgba(0,0,0,0.8); }
.carousel-prev { left: 10px; }
.carousel-next { right: 10px; }
.carousel-counter { position: absolute; top: 10px; right: 12px; background: rgba(0,0,0,0.55); color: #fff; font-size: 0.78em; padding: 4px 10px; border-radius: 20px; z-index: 5; }
.carousel-dots { display: flex; justify-content: center; gap: 7px; padding: 10px 0 2px; }
.carousel-dot { width: 8px; height: 8px; border-radius: 50%; background: #333; cursor: pointer; transition: all 0.25s ease; border: none; }
.carousel-dot.active { background: #aaa; transform: scale(1.2); }
/* Images preview grid in form */
.images-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 12px; }
.img-preview-item { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; }
.img-preview-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
.img-preview-item .rm-img-btn { position: absolute; top: 4px; right: 4px; background: rgba(244,67,54,0.8); border: none; color: #fff; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; font-size: 0.75em; display: flex; align-items: center; justify-content: center; }
.img-preview-item .rm-img-btn:hover { background: #f44336; transform: scale(1.1); }
/* Custom Audio Player */
.audio-player { background: linear-gradient(135deg, rgba(20,20,20,0.95), rgba(30,30,30,0.95)); border: 1px solid #2a2a2a; border-radius: 16px; padding: 16px 20px; display: flex; align-items: center; gap: 16px; margin: 12px 0; }
.audio-play-btn { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #3a3a3a, #555); border: none; color: #fff; font-size: 1.1em; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.25s ease; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
.audio-play-btn:hover { background: linear-gradient(135deg, #555, #777); transform: scale(1.05); }
.audio-info { flex: 1; min-width: 0; }
.audio-title-text { font-size: 0.8em; color: #888; margin-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.audio-progress-row { display: flex; align-items: center; gap: 10px; }
.audio-progress-bar-wrap { flex: 1; height: 4px; background: #2a2a2a; border-radius: 2px; cursor: pointer; position: relative; }
.audio-progress-fill { height: 100%; background: linear-gradient(90deg, #888, #bbb); border-radius: 2px; pointer-events: none; transition: width 0.1s linear; }
.audio-time-display { font-size: 0.75em; color: #666; white-space: nowrap; min-width: 85px; text-align: right; }
/* Lock Screen */
.lock-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #080808; z-index: 99999; flex-direction: column; align-items: center; justify-content: center; }
.lock-screen.show { display: flex; }
.lock-box { text-align: center; max-width: 380px; width: 90%; padding: 40px 35px; background: rgba(22,22,22,0.98); border: 1px solid #2a2a2a; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); animation: scaleIn 0.4s ease; }
.lock-icon-big { font-size: 4em; margin-bottom: 20px; }
.lock-box-title { font-size: 1.9em; font-weight: 700; margin-bottom: 8px; }
.lock-box-sub { color: #666; font-size: 0.9em; margin-bottom: 28px; line-height: 1.5; }
.lock-input-wrap { position: relative; margin-bottom: 14px; }
.lock-input-wrap input { width: 100%; padding: 14px 50px 14px 18px; background: rgba(10,10,10,0.7); border: 1px solid #2a2a2a; border-radius: 12px; color: #fff; font-size: 1.1em; font-family: 'Poppins', sans-serif; letter-spacing: 3px; text-align: center; transition: border-color 0.2s; }
.lock-input-wrap input:focus { outline: none; border-color: #444; }
.toggle-vis-btn { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #555; cursor: pointer; font-size: 1em; }
.lock-err { font-size: 0.83em; color: #f44336; margin-bottom: 14px; min-height: 18px; }
.lock-reset-link { font-size: 0.8em; color: #444; cursor: pointer; margin-top: 18px; text-decoration: underline; transition: color 0.2s; }
.lock-reset-link:hover { color: #888; }
/* Password Manager Modal */
.pw-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20000; align-items: center; justify-content: center; padding: 20px; }
.pw-modal.show { display: flex; }
.pw-modal-box { background: rgba(26,26,26,0.98); backdrop-filter: blur(20px); padding: 35px; border-radius: 20px; max-width: 430px; width: 100%; border: 1px solid #2a2a2a; box-shadow: 0 20px 60px rgba(0,0,0,0.8); animation: scaleIn 0.3s ease; max-height: 90vh; overflow-y: auto; }
.pw-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.pw-modal-title { font-size: 1.4em; font-weight: 600; display: flex; align-items: center; gap: 10px; }
.pw-opt-btn { width: 100%; padding: 14px 18px; background: rgba(42,42,42,0.5); border: 1px solid #2a2a2a; border-radius: 12px; color: #ccc; font-size: 0.93em; text-align: left; cursor: pointer; transition: all 0.25s ease; display: flex; align-items: center; gap: 12px; margin-bottom: 10px; font-family: 'Poppins', sans-serif; }
.pw-opt-btn:hover { background: rgba(55,55,55,0.7); color: #fff; border-color: #3a3a3a; transform: translateX(4px); }
.pw-opt-btn i { width: 20px; text-align: center; }
.pw-opt-btn.danger { color: #ef5350; border-color: rgba(244,67,54,0.18); }
.pw-opt-btn.danger:hover { background: rgba(244,67,54,0.1); }
.pw-err { font-size: 0.83em; color: #f44336; margin-bottom: 12px; min-height: 18px; }
/* Post lock overlay */
.post-lock-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 18px; z-index: 5; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; cursor: pointer; transition: all 0.2s ease; }
.post-lock-overlay:hover .lock-lbl { color: #aaa; }
.post-lock-overlay .lock-ico { font-size: 2.6em; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.8)); }
.post-lock-overlay .lock-lbl { color: #888; font-size: 0.92em; font-weight: 500; }
.post-lock-overlay .lock-hint { color: #555; font-size: 0.78em; }
.post-blur-content { filter: blur(12px); pointer-events: none; user-select: none; }
/* Toggle field for post password */
.toggle-row { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: rgba(10,10,10,0.4); border: 1px solid #2a2a2a; border-radius: 10px; cursor: pointer; margin-bottom: 10px; }
.toggle-row:hover { border-color: #3a3a3a; }
.toggle-row input[type=checkbox] { width: 16px; height: 16px; cursor: pointer; accent-color: #666; }
.toggle-row label { cursor: pointer; color: #bbb; font-size: 0.9em; margin: 0; }
.post-pw-field { display: none; }
.post-pw-field.show { display: block; }
/* === NOVAS FUNCIONALIDADES === */

/* === STAT CARDS (Streak) === */
.stat-cards { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:16px; }
.stat-card { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; padding:14px 20px; background:rgba(22,22,22,0.9); border:1px solid #2a2a2a; border-radius:16px; cursor:pointer; transition:all 0.3s ease; min-width:110px; position:relative; overflow:hidden; }
.stat-card::before { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(255,255,255,0.02),transparent); }
.stat-card:hover { border-color:#3a3a3a; transform:translateY(-3px); box-shadow:0 10px 30px rgba(0,0,0,0.5); }
.stat-card-icon { font-size:1.4em; margin-bottom:2px; }
.stat-card-value { font-size:1.6em; font-weight:700; line-height:1; }
.stat-card-label { font-size:0.7em; color:#555; font-weight:500; text-transform:uppercase; letter-spacing:0.8px; text-align:center; margin-top:2px; }
.stat-card.streak-active { border-color:rgba(255,130,0,0.3); background:rgba(255,130,0,0.07); }
.stat-card.streak-active .stat-card-value { color:#ff8200; }
.stat-card.today-done { border-color:rgba(74,222,128,0.3); background:rgba(74,222,128,0.06); }
.stat-card.today-done .stat-card-value { color:#4ade80; font-size:1.3em; }
.stat-card.days-total .stat-card-value { color:#60a5fa; }

/* Color Themes */
:root { --accent-color:#fff; --accent-bg:rgba(255,255,255,0.08); --accent-border:rgba(255,255,255,0.2); }
body.theme-purple { --accent-color:#c084fc; --accent-bg:rgba(192,132,252,0.08); --accent-border:rgba(192,132,252,0.2); }
body.theme-blue { --accent-color:#60a5fa; --accent-bg:rgba(96,165,250,0.08); --accent-border:rgba(96,165,250,0.2); }
body.theme-green { --accent-color:#4ade80; --accent-bg:rgba(74,222,128,0.08); --accent-border:rgba(74,222,128,0.2); }
body.theme-rose { --accent-color:#fb7185; --accent-bg:rgba(251,113,133,0.08); --accent-border:rgba(251,113,133,0.2); }
body.theme-amber { --accent-color:#fbbf24; --accent-bg:rgba(251,191,36,0.08); --accent-border:rgba(251,191,36,0.2); }
body.theme-cyan { --accent-color:#22d3ee; --accent-bg:rgba(34,211,238,0.08); --accent-border:rgba(34,211,238,0.2); }
.btn-primary, .btn-primary:hover { box-shadow: 0 0 0 0 transparent; }
body:not(.theme-white) .btn.btn-primary { background:linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.12)); border-color: var(--accent-border); color: var(--accent-color); }
body:not(.theme-white) .post::before { background: linear-gradient(90deg, transparent, var(--accent-color), transparent); opacity:0; }
body:not(.theme-white) .post:hover::before { opacity:0.15; }
body:not(.theme-white) .filter-tag.active { border-color: var(--accent-color); color: var(--accent-color); background: var(--accent-bg); }
body:not(.theme-white) .streak-badge { color: var(--accent-color); border-color: var(--accent-border); background: var(--accent-bg); }
body:not(.theme-white) .sort-btn.active { color: var(--accent-color); border-color: var(--accent-border); background: var(--accent-bg); }
body:not(.theme-white) .post-action-btn.active { color: var(--accent-color); border-color: var(--accent-border); background: var(--accent-bg); }
body:not(.theme-white) .mood-option.selected { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color); }
body:not(.theme-white) h1 { background: linear-gradient(135deg, var(--accent-color) 0%, #ffffff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

/* Theme Picker */
.theme-picker { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
.theme-dot { width:30px; height:30px; border-radius:50%; cursor:pointer; border:2px solid transparent; transition:all 0.25s ease; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.theme-dot:hover, .theme-dot.active { border-color:#fff; transform:scale(1.15); }
.theme-dot i { color:#fff; font-size:0.7em; opacity:0; transition:opacity 0.2s; }
.theme-dot.active i { opacity:1; }



/* Timeline View */
.timeline-wrap { max-height:70vh; overflow-y:auto; padding-right:4px; }
.timeline-year-group { margin-bottom:28px; }
.timeline-year-label { font-size:1.5em; font-weight:700; color:#555; margin-bottom:16px; padding-bottom:8px; border-bottom:1px solid #1e1e1e; }
.timeline-month-group { display:flex; gap:16px; margin-bottom:18px; align-items:flex-start; }
.timeline-month-label { min-width:55px; padding-top:4px; text-align:right; color:#555; font-size:0.82em; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
.timeline-line { display:flex; flex-direction:column; align-items:center; margin-top:8px; gap:4px; flex-shrink:0; }
.timeline-dot { width:10px; height:10px; border-radius:50%; background:var(--accent-color,#444); border:2px solid #0a0a0a; flex-shrink:0; }
.timeline-vert { width:2px; flex:1; min-height:20px; background:linear-gradient(to bottom,#2a2a2a,transparent); }
.timeline-posts { flex:1; display:flex; flex-direction:column; gap:10px; }
.timeline-post-card { background:rgba(26,26,26,0.8); border:1px solid #2a2a2a; border-radius:12px; padding:14px 16px; cursor:pointer; transition:all 0.25s ease; }
.timeline-post-card:hover { border-color:#3a3a3a; transform:translateX(4px); background:rgba(36,36,36,0.9); }
.timeline-post-title { font-size:0.95em; font-weight:600; margin-bottom:4px; }
.timeline-post-meta { font-size:0.78em; color:#555; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.timeline-post-preview { font-size:0.82em; color:#777; margin-top:6px; line-height:1.5; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }



/* Mood Filter Row */
.mood-filter-row { display:flex; gap:8px; overflow-x:auto; scrollbar-width:none; padding-bottom:4px; margin-bottom:10px; align-items:center; flex-wrap:nowrap; }
.mood-filter-row::-webkit-scrollbar { display:none; }
.mood-filter-chip { padding:6px 14px; border:1px solid #2a2a2a; border-radius:20px; cursor:pointer; transition:all 0.25s ease; font-size:0.88em; background:rgba(26,26,26,0.6); white-space:nowrap; flex-shrink:0; }
.mood-filter-chip:hover { border-color:#3a3a3a; transform:scale(1.05); }
.mood-filter-chip.active { border-color:var(--accent-border,#555); background:var(--accent-bg,rgba(42,42,42,0.8)); color:var(--accent-color,#fff); }
.mood-filter-label { font-size:0.78em; color:#444; margin-right:2px; white-space:nowrap; flex-shrink:0; }

/* Export TXT */
.export-options { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:6px; }
.export-opt-card { padding:18px 16px; background:rgba(42,42,42,0.4); border:1px solid #2a2a2a; border-radius:14px; cursor:pointer; transition:all 0.25s ease; text-align:center; }
.export-opt-card:hover { border-color:#3a3a3a; background:rgba(55,55,55,0.5); transform:translateY(-2px); }
.export-opt-icon { font-size:2em; margin-bottom:10px; }
.export-opt-label { font-size:0.9em; font-weight:600; margin-bottom:4px; }
.export-opt-sub { font-size:0.76em; color:#666; }

/* Activity Heatmap */
.heatmap-wrap { margin-top:16px; }
.heatmap-title { font-size:0.82em; color:#666; margin-bottom:10px; display:flex; align-items:center; gap:6px; }
.heatmap-grid { display:flex; gap:3px; flex-wrap:wrap; }
.heatmap-cell { width:12px; height:12px; border-radius:2px; background:#1a1a1a; flex-shrink:0; transition:all 0.15s ease; cursor:default; }
.heatmap-cell:hover { transform:scale(1.4); z-index:10; }
.heatmap-cell.l1 { background:rgba(128,128,128,0.3); }
.heatmap-cell.l2 { background:rgba(160,160,160,0.5); }
.heatmap-cell.l3 { background:rgba(200,200,200,0.7); }
.heatmap-cell.l4 { background:#ccc; }
.heatmap-months { display:flex; gap:3px; flex-wrap:wrap; margin-top:6px; }
.heatmap-month-label { font-size:0.68em; color:#444; }

/* Responsive */
@media (max-width: 768px) {
    body { padding: 10px; padding-bottom: 90px; }
    h1 { font-size: 2em; }
    .subtitle { font-size: 1em; }
    .controls { display: none !important; }
    .mobile-menu-btn { display: flex; align-items: center; justify-content: center; }
    .mobile-fab { display: flex; }
    .filter-tags { gap: 8px; }
    .filter-tag { padding: 8px 12px; font-size: 0.85em; }
    .view-mode-toggle { display: none; }
    .modal-content { border-radius: 20px; margin: 10px; max-height: 90vh; }
    .modal-top-bar { padding: 18px 20px 14px; border-radius: 20px 20px 0 0; }
    .modal-top-bar h2 { font-size: 1.1em; }
    .form-body { padding: 14px 14px; gap: 12px; }
    .form-footer { padding: 12px 14px 16px; border-radius: 0 0 20px 20px; }
    .media-section { grid-template-columns: 1fr 1fr; }
    .mood-pill-label { display: none !important; }
    .mood-pill { padding: 8px 10px; }
    .post { padding: 0; }
    .post-inner { padding: 12px 12px 0 14px; }
    .post-body { padding: 8px 12px 8px 14px; }
    .post-footer-bar { padding: 8px 12px 10px 14px; }
    .posts-container { gap: 10px; }
    .post-header { flex-direction: column; gap: 8px; }
    .post-actions { width: 100%; justify-content: flex-start; overflow-x: auto; padding-bottom: 5px; }
    .post-action-btn { flex-shrink: 0; }
    .post-footer-bar { flex-wrap: wrap; }
    .post-title { font-size: 1.1em; }
    .post-time { font-size: 0.76em; flex-wrap: wrap; }
    .badge { font-size: 0.68em; padding: 3px 8px; }
    .section-header { flex-direction: column; align-items: flex-start; gap: 10px; }
    .section-title { font-size: 1.2em; }
    .popup-content { padding: 25px 20px; }
    .popup-title { font-size: 1.3em; }
    .popup-buttons { flex-direction: column; }
    .popup-btn { width: 100%; }
    .dropdown-content { right: auto; left: 50%; transform: translateX(-50%); }
    .stat-cards { gap: 8px; }
    .stat-card { padding: 12px 14px; min-width: 90px; }
    .stat-card-value { font-size: 1.4em; }
    .stat-card-label { font-size: 0.65em; }
}
.posts-container.compact-view .post-inner { padding: 14px 16px 0 18px; }
.posts-container.compact-view .post-body { padding: 8px 16px 8px 18px; }
.posts-container.compact-view .post-footer-bar { padding: 8px 16px 12px 18px; }
.posts-container.compact-view .post-description { font-size: 0.88em; line-height: 1.5; }

@media (max-width: 480px) {
    h1 { font-size: 1.7em; }
    .post { padding: 18px 15px; }
    .post-title { font-size: 1.2em; }
    .post-description { font-size: 0.95em; }
}


/* ── Name Popup ── */
.name-popup-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.96); z-index:200000; align-items:center; justify-content:center; }
.name-popup-overlay.show { display:flex; }
.name-popup-box { background:rgba(22,22,22,0.99); border:1px solid #2a2a2a; border-radius:24px; padding:44px 40px; max-width:420px; width:90%; text-align:center; animation:scaleIn 0.4s ease; box-shadow:0 20px 60px rgba(0,0,0,0.9); }
.name-popup-emoji { font-size:3.5em; margin-bottom:18px; }
.name-popup-title { font-size:1.7em; font-weight:700; margin-bottom:8px; }
.name-popup-sub { color:#666; font-size:0.92em; margin-bottom:28px; line-height:1.5; }
.name-popup-input { width:100%; padding:15px 18px; background:rgba(10,10,10,0.7); border:1px solid #2a2a2a; border-radius:12px; color:#fff; font-size:1.05em; font-family:'Poppins',sans-serif; text-align:center; transition:border-color 0.2s; margin-bottom:18px; }
.name-popup-input:focus { outline:none; border-color:#555; }
/* ── Greeting ── */
.greeting-bar { text-align:center; margin-bottom:10px; }
.greeting-text { font-size:1.05em; color:#777; font-weight:300; }
.greeting-text strong { color:#bbb; font-weight:500; }
/* ── Settings Modal ── */
.settings-section { margin-bottom:28px; }
.settings-section-title { font-size:0.8em; font-weight:600; color:#555; text-transform:uppercase; letter-spacing:1.5px; margin-bottom:14px; display:flex; align-items:center; gap:8px; }
.settings-row { display:flex; align-items:center; justify-content:space-between; padding:13px 0; border-bottom:1px solid #1e1e1e; gap:15px; }
.settings-row:last-child { border-bottom:none; }
.settings-row-label { font-size:0.93em; color:#ccc; }
.settings-row-sub { font-size:0.78em; color:#555; margin-top:2px; }
/* Toggle switch */
.toggle-switch { position:relative; width:46px; height:26px; flex-shrink:0; }
.toggle-switch input { opacity:0; width:0; height:0; }
.toggle-slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#2a2a2a; border-radius:26px; transition:0.3s; border:1px solid #333; }
.toggle-slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:#666; border-radius:50%; transition:0.3s; }
input:checked + .toggle-slider { background:#3a3a3a; border-color:#555; }
input:checked + .toggle-slider:before { transform:translateX(20px); background:#ddd; }
/* Select dropdown in settings */
.settings-select { background:rgba(10,10,10,0.7); border:1px solid #2a2a2a; border-radius:8px; color:#ccc; padding:7px 12px; font-family:'Poppins',sans-serif; font-size:0.88em; cursor:pointer; }
.settings-select:focus { outline:none; border-color:#444; }
/* Copy button on post — desktop only */
.post-copy-btn { background:rgba(30,30,30,0.8); border:1px solid rgba(255,255,255,0.06); color:#444; padding:6px 12px; border-radius:9px; display:inline-flex; align-items:center; gap:6px; cursor:pointer; font-size:0.73em; font-family:'Poppins',sans-serif; transition:all 0.2s ease; flex-shrink:0; }
.post-copy-btn:hover { background:rgba(50,50,50,0.9); color:#aaa; border-color:rgba(255,255,255,0.1); }
@media (max-width: 768px) { .post-copy-btn { display:none !important; } }
/* Reading time badge */
.reading-time { font-size:0.78em; color:#555; display:inline-flex; align-items:center; gap:4px; }
/* Word count in post */
.post-wordcount { font-size:0.75em; color:#444; margin-top:4px; }
/* Sort bar */
.sort-bar { display:flex; align-items:center; gap:10px; margin-bottom:16px; }
.sort-bar-label { font-size:0.82em; color:#555; }
.sort-btn { padding:5px 12px; background:transparent; border:1px solid #2a2a2a; border-radius:8px; color:#666; font-size:0.82em; cursor:pointer; transition:all 0.2s; font-family:'Poppins',sans-serif; }
.sort-btn.active { background:#2a2a2a; color:#ccc; border-color:#3a3a3a; }
.sort-btn:hover:not(.active) { border-color:#3a3a3a; color:#aaa; }


/* Gallery photo menu */
.gallery-action-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:60000; align-items:flex-end; justify-content:center; }
.gallery-action-overlay.show { display:flex; animation:fadeIn 0.2s ease; }
.gallery-action-sheet { background:rgba(20,20,20,0.99); border:1px solid #2a2a2a; border-radius:20px 20px 0 0; padding:12px 12px 28px; width:100%; max-width:480px; animation:slideUp 0.25s ease; }
@media(min-width:600px){ .gallery-action-sheet { border-radius:16px; margin-bottom:40px; } }
.gallery-action-handle { width:40px; height:4px; background:#333; border-radius:4px; margin:0 auto 16px; }
.gallery-action-title { font-size:0.82em; color:#555; text-align:center; margin-bottom:12px; font-weight:500; padding-bottom:10px; border-bottom:1px solid #1e1e1e; }
.gallery-action-item { display:flex; align-items:center; gap:16px; padding:14px 16px; border-radius:12px; cursor:pointer; transition:background 0.15s; color:#ccc; margin-bottom:4px; }
.gallery-action-item:hover, .gallery-action-item:active { background:rgba(42,42,42,0.7); color:#fff; }
.gallery-action-item i { font-size:1.15em; color:#777; width:22px; text-align:center; flex-shrink:0; }
.gallery-action-item .gai-label { font-weight:500; font-size:0.95em; }
.gallery-action-item .gai-sub { font-size:0.78em; color:#555; margin-top:2px; }
.gallery-action-cancel { display:flex; align-items:center; justify-content:center; padding:14px; border-radius:12px; cursor:pointer; color:#666; font-size:0.9em; transition:all 0.15s; margin-top:6px; border:1px solid #1e1e1e; }
.gallery-action-cancel:hover { background:rgba(30,30,30,0.6); color:#aaa; }
/* Highlight favorites */
.highlight-favs .post.favorite-post { border-color:rgba(255,193,7,0.18); box-shadow:0 0 0 1px rgba(255,193,7,0.07), 0 6px 24px rgba(0,0,0,0.4); }
.highlight-favs .post.favorite-post::after { background:rgba(255,193,7,0.4) !important; }
/* No animation */
.no-anim .post { animation:none !important; }


/* Month filter picker */
.month-filter-wrap { position:relative; }
.month-picker { position:absolute; top:calc(100% + 8px); left:0; background:rgba(18,18,18,0.99); border:1px solid #2a2a2a; border-radius:16px; padding:16px; z-index:500; min-width:260px; box-shadow:0 12px 40px rgba(0,0,0,0.7); animation:scaleIn 0.18s ease; }
.month-picker-header { font-size:0.8em; color:#555; text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; }
.month-picker-year { display:flex; align-items:center; gap:8px; }
.month-picker-year-btn { background:none; border:1px solid #2a2a2a; color:#777; width:26px; height:26px; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.15s; font-size:0.9em; }
.month-picker-year-btn:hover { background:#2a2a2a; color:#ccc; }
.month-picker-year-label { color:#ccc; font-size:0.92em; font-weight:500; min-width:38px; text-align:center; }
.month-picker-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; }
.month-cell { padding:8px 4px; text-align:center; font-size:0.82em; border-radius:8px; cursor:pointer; transition:all 0.15s; color:#777; border:1px solid transparent; position:relative; }
.month-cell:hover { background:rgba(42,42,42,0.6); color:#ccc; }
.month-cell.active { background:rgba(42,42,42,0.8); border-color:#444; color:#fff; font-weight:500; }
.month-cell.has-posts::after { content:''; position:absolute; bottom:4px; left:50%; transform:translateX(-50%); width:4px; height:4px; border-radius:50%; background:#555; }
.month-cell.active.has-posts::after { background:#999; }
.month-picker-clear { margin-top:10px; padding:8px; text-align:center; font-size:0.8em; color:#555; cursor:pointer; border-radius:8px; transition:all 0.15s; border-top:1px solid #1e1e1e; padding-top:12px; }
.month-picker-clear:hover { color:#999; }
@media(max-width:768px){ .month-picker { left:auto; right:0; } }

/* === INLINE SEARCH BAR === */
.inline-search { margin: 14px 0 6px; position:relative; animation:slideDown 0.4s ease; }
.inline-search input { width:100%; padding:13px 46px 13px 18px; background:rgba(22,22,22,0.85); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.07); border-radius:14px; color:#fff; font-size:0.95em; font-family:'Poppins',sans-serif; transition:all 0.25s ease; }
.inline-search input:focus { outline:none; border-color:rgba(255,255,255,0.15); background:rgba(28,28,28,0.95); box-shadow:0 0 0 3px rgba(255,255,255,0.03); }
.inline-search input::placeholder { color:#333; }
.inline-search .search-icon { position:absolute; right:18px; top:50%; transform:translateY(-50%); color:#333; pointer-events:none; font-size:0.9em; transition:color 0.2s; }
.inline-search input:focus ~ .search-icon { color:#555; }

/* === LIXEIRA === */
.trash-modal-content { background:rgba(18,18,18,0.99); backdrop-filter:blur(30px); padding:0; border-radius:24px; max-width:680px; width:100%; max-height:90vh; display:flex; flex-direction:column; border:1px solid rgba(255,255,255,0.06); box-shadow:0 30px 80px rgba(0,0,0,0.9); animation:scaleIn 0.3s ease; }
.trash-top-bar { display:flex; justify-content:space-between; align-items:center; padding:22px 28px 18px; border-bottom:1px solid rgba(255,255,255,0.05); flex-shrink:0; }
.trash-top-bar h2 { font-size:1.2em; font-weight:600; display:flex; align-items:center; gap:10px; }
.trash-top-bar h2 .trash-icon-wrap { width:34px; height:34px; border-radius:10px; background:rgba(244,67,54,0.1); border:1px solid rgba(244,67,54,0.2); display:flex; align-items:center; justify-content:center; color:#ef5350; font-size:0.95em; }
.trash-actions-bar { display:flex; align-items:center; justify-content:space-between; padding:12px 28px; border-bottom:1px solid rgba(255,255,255,0.04); flex-shrink:0; gap:10px; }
.trash-count-badge { font-size:0.8em; color:#555; background:rgba(42,42,42,0.5); padding:5px 12px; border-radius:20px; border:1px solid #2a2a2a; white-space:nowrap; }
.trash-empty-all-btn { padding:8px 16px; background:rgba(244,67,54,0.08); border:1px solid rgba(244,67,54,0.2); color:#ef5350; border-radius:10px; cursor:pointer; font-size:0.8em; font-family:'Poppins',sans-serif; transition:all 0.2s ease; display:flex; align-items:center; gap:7px; }
.trash-empty-all-btn:hover { background:rgba(244,67,54,0.15); }
.trash-list { overflow-y:auto; padding:16px 20px; flex:1; display:flex; flex-direction:column; gap:10px; }
.trash-item { background:rgba(26,26,26,0.8); border:1px solid rgba(255,255,255,0.06); border-radius:14px; padding:16px 18px; display:flex; align-items:flex-start; gap:14px; transition:all 0.25s ease; }
.trash-item:hover { border-color:#2a2a2a; background:rgba(32,32,32,0.9); }
.trash-item-info { flex:1; min-width:0; }
.trash-item-title { font-size:0.95em; font-weight:600; color:#ddd; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.trash-item-meta { font-size:0.75em; color:#555; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.trash-item-countdown { font-size:0.72em; color:#7a3030; background:rgba(244,67,54,0.08); padding:2px 9px; border-radius:6px; border:1px solid rgba(244,67,54,0.15); white-space:nowrap; }
.trash-item-actions { display:flex; gap:6px; flex-shrink:0; }
.trash-action-btn { padding:7px 13px; border-radius:9px; cursor:pointer; font-size:0.75em; font-family:'Poppins',sans-serif; transition:all 0.2s ease; display:flex; align-items:center; gap:5px; border:1px solid transparent; }
.trash-restore-btn { background:rgba(74,222,128,0.07); border-color:rgba(74,222,128,0.2); color:#4ade80; }
.trash-restore-btn:hover { background:rgba(74,222,128,0.15); }
.trash-perm-btn { background:rgba(244,67,54,0.07); border-color:rgba(244,67,54,0.2); color:#ef5350; }
.trash-perm-btn:hover { background:rgba(244,67,54,0.15); }
.trash-empty-state { text-align:center; padding:48px 20px; color:#444; }
.trash-empty-state i { font-size:3em; display:block; margin-bottom:16px; opacity:0.3; }
.trash-empty-state h3 { font-size:1.1em; color:#555; }
.trash-empty-state p { font-size:0.82em; margin-top:6px; color:#3a3a3a; }
.trash-footer-note { padding:12px 28px 20px; font-size:0.74em; color:#333; text-align:center; flex-shrink:0; }

/* === MOBILE BADGE NOTIFICATION === */
.mobile-menu-item { position:relative; }
.menu-badge { position:absolute; right:16px; top:50%; transform:translateY(-50%); background:linear-gradient(135deg,#ff6b6b,#ee5a24); color:#fff; font-size:0.65em; font-weight:700; padding:2px 7px; border-radius:20px; min-width:20px; text-align:center; animation:badgePop 0.4s cubic-bezier(0.175,0.885,0.32,1.275); pointer-events:none; box-shadow:0 2px 8px rgba(238,90,36,0.4); }
.menu-badge.badge-trash { background:linear-gradient(135deg,#ef5350,#c62828); box-shadow:0 2px 8px rgba(239,83,80,0.4); }
@keyframes badgePop { from { transform:translateY(-50%) scale(0); opacity:0; } to { transform:translateY(-50%) scale(1); opacity:1; } }

/* === LOGIN OVERLAY === */
#loginOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#0a0a0a; z-index:999999; display:flex; align-items:center; justify-content:center; padding:20px; }
#loginOverlay.hide { display:none; }
.login-box { background:rgba(18,18,18,0.99); border:1px solid rgba(255,255,255,0.08); border-radius:28px; padding:52px 44px; max-width:420px; width:100%; text-align:center; animation:scaleIn 0.4s ease; box-shadow:0 30px 80px rgba(0,0,0,0.9); }
.login-logo { font-size:3.5em; margin-bottom:18px; display:block; }
.login-title { font-size:1.8em; font-weight:700; margin-bottom:8px; background:linear-gradient(135deg,#fff 0%,#aaa 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
.login-sub { color:#555; font-size:0.92em; margin-bottom:36px; line-height:1.6; }
.google-btn { display:flex; align-items:center; justify-content:center; gap:12px; width:100%; padding:15px 24px; background:#fff; border:none; border-radius:14px; cursor:pointer; font-size:1em; font-weight:600; color:#1a1a1a; font-family:'Poppins',sans-serif; transition:all 0.25s ease; box-shadow:0 4px 20px rgba(0,0,0,0.3); }
.google-btn:hover { background:#f5f5f5; transform:translateY(-2px); box-shadow:0 8px 30px rgba(0,0,0,0.4); }
.google-btn:active { transform:translateY(0); }
.google-btn img { width:22px; height:22px; }
.google-btn.loading { opacity:0.7; pointer-events:none; }
.login-footer { margin-top:24px; font-size:0.74em; color:#333; line-height:1.6; }
/* === USER BAR === */
#userBar { display:none; align-items:center; justify-content:flex-end; gap:10px; padding:10px 0; margin-bottom:4px; }
#userBar.show { display:flex; }
.user-bar-avatar { width:32px; height:32px; border-radius:50%; border:2px solid rgba(255,255,255,0.1); object-fit:cover; }
.user-bar-name { font-size:0.82em; color:#666; }
.signout-btn { padding:6px 14px; background:rgba(42,42,42,0.6); border:1px solid #2a2a2a; border-radius:8px; color:#666; font-size:0.78em; cursor:pointer; font-family:'Poppins',sans-serif; transition:all 0.2s ease; display:flex; align-items:center; gap:6px; }
.signout-btn:hover { border-color:#3a3a3a; color:#aaa; }
/* Sync indicator */
#syncIndicator { position:fixed; bottom:20px; right:20px; background:rgba(18,18,18,0.95); border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:8px 14px; font-size:0.78em; color:#666; display:none; align-items:center; gap:8px; z-index:9999; animation:slideUp 0.3s ease; }
#syncIndicator.show { display:flex; }
#syncIndicator.error { color:#ef5350; border-color:rgba(239,83,80,0.2); }
@keyframes spin { to { transform:rotate(360deg); } }
.sync-spin { animation:spin 1s linear infinite; display:inline-block; }

    </style>
</head>
<body>

    <!-- Login Overlay -->
    <div id="loginOverlay">
        <div class="login-box">
            <span class="login-logo">📖</span>
            <div class="login-title">Meu Diário Digital</div>
            <div class="login-sub">Entre com o Google para acessar e sincronizar seu diário em qualquer dispositivo.</div>
            <button class="google-btn" id="googleSignInBtn" onclick="signInWithGoogle()" disabled>
                <span class="sync-spin" style="display:inline-block;color:#999;">↻</span>
                Carregando...
            </button>
            <div class="login-footer">🔒 Seus dados ficam salvos em segurança na sua conta Google.<br>Acesse de qualquer dispositivo a qualquer hora.</div>
        </div>
    </div>

    <!-- Sync indicator -->
    <div id="syncIndicator"><span class="sync-spin">↻</span> <span id="syncMsg">Sincronizando...</span></div>

    <div class="container">
        <!-- User bar -->
        <div id="userBar">
            <img class="user-bar-avatar" id="userAvatar" src="" alt="">
            <span class="user-bar-name" id="userBarName"></span>
            <button class="signout-btn" onclick="signOutUser()"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>

        <header>
            <h1><i class="fas fa-book"></i> Meu Diário Digital</h1>
            <p class="subtitle">Registre seus momentos especiais</p>
            <div class="greeting-bar"><p class="greeting-text" id="greetingText"></p></div>
            <div class="stat-cards" id="streakBadgeWrap"></div>
        </header>

        <div class="controls">
            <button class="btn btn-primary" onclick="openModal('new')">
                <i class="fas fa-plus"></i> Nova Publicação
            </button>
            <div class="controls-group">
                <button class="btn" onclick="showAllPosts()"><i class="fas fa-th-list"></i> Todas</button>
                <button class="btn" onclick="showDrafts()"><i class="fas fa-file-alt"></i> Rascunhos</button>
                <button class="btn" onclick="showFavorites()"><i class="fas fa-star"></i> Favoritos</button>
                <button class="btn" onclick="openPasswordManager()"><i class="fas fa-lock"></i> Senha</button>
                <div class="dropdown">
                    <button class="btn" onclick="toggleDropdown()"><i class="fas fa-ellipsis-v"></i> Mais</button>
                    <div class="dropdown-content" id="moreDropdown">
                        <div class="dropdown-item" onclick="showGallery()"><i class="fas fa-images"></i> Galeria</div>
                        <div class="dropdown-item" onclick="showTimeline()"><i class="fas fa-stream"></i> Linha do Tempo</div>
                        <div class="dropdown-item" onclick="showStats()"><i class="fas fa-chart-bar"></i> Estatísticas</div>
                        <div class="dropdown-item" onclick="showTrash()" id="trashDropdownItem"><i class="fas fa-trash-alt"></i> Lixeira</div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" onclick="openSettings()"><i class="fas fa-sliders-h"></i> Configurações</div>
                        <div class="dropdown-item" onclick="openProfileEdit()"><i class="fas fa-user"></i> Meu Perfil</div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" onclick="showExportOptions()"><i class="fas fa-download"></i> Exportar</div>
                        <div class="dropdown-item" onclick="importData()"><i class="fas fa-upload"></i> Importar</div>
                    </div>
                </div>
                <div class="view-mode-toggle">
                    <button class="view-mode-btn active" id="listModeBtn" onclick="setViewMode('list')" title="Lista"><i class="fas fa-list"></i></button>
                    <button class="view-mode-btn" id="gridModeBtn" onclick="setViewMode('grid')" title="Grade"><i class="fas fa-th"></i></button>
                </div>
            </div>
        </div>

        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>
        <button class="mobile-fab" onclick="openModal('new')"><i class="fas fa-plus"></i></button>

        <div class="mobile-menu" id="mobileMenu">
            <div style="padding:8px 10px 12px;border-bottom:1px solid #1e1e1e;margin-bottom:6px;">
                <div style="position:relative;">
                    <input type="text" id="mobileSearchInput" placeholder="Pesquisar publicações..." style="width:100%;padding:11px 40px 11px 14px;background:rgba(10,10,10,0.6);border:1px solid #2a2a2a;border-radius:10px;color:#fff;font-family:'Poppins',sans-serif;font-size:0.88em;" oninput="filterPosts(this.value)">
                    <i class="fas fa-search" style="position:absolute;right:14px;top:50%;transform:translateY(-50%);color:#444;font-size:0.85em;pointer-events:none;"></i>
                </div>
            </div>
            <div class="mobile-menu-item" id="mmi-all" onclick="showAllPosts();clearMenuBadge('all');closeMobileMenu()"><i class="fas fa-th-list"></i> Todas as Publicações</div>
            <div class="mobile-menu-item" id="mmi-drafts" onclick="showDrafts();clearMenuBadge('drafts');closeMobileMenu()"><i class="fas fa-file-alt"></i> Rascunhos</div>
            <div class="mobile-menu-item" id="mmi-favorites" onclick="showFavorites();clearMenuBadge('favorites');closeMobileMenu()"><i class="fas fa-star"></i> Favoritos</div>
            <div class="mobile-divider"></div>
            <div class="mobile-menu-item" onclick="openPasswordManager();closeMobileMenu()"><i class="fas fa-lock"></i> Senha do Diário</div>
            <div class="mobile-menu-item" id="mmi-gallery" onclick="showGallery();clearMenuBadge('gallery');closeMobileMenu()"><i class="fas fa-images"></i> Galeria</div>
            <div class="mobile-menu-item" onclick="showTimeline();closeMobileMenu()"><i class="fas fa-stream"></i> Linha do Tempo</div>
            <div class="mobile-menu-item" onclick="showStats();closeMobileMenu()"><i class="fas fa-chart-bar"></i> Estatísticas</div>
            <div class="mobile-menu-item" id="mmi-trash" onclick="showTrash();clearMenuBadge('trash');closeMobileMenu()"><i class="fas fa-trash-alt"></i> Lixeira</div>
            <div class="mobile-divider"></div>
            <div class="mobile-menu-item" onclick="openSettings();closeMobileMenu()"><i class="fas fa-sliders-h"></i> Configurações</div>
            <div class="mobile-menu-item" onclick="openProfileEdit();closeMobileMenu()"><i class="fas fa-user"></i> Meu Perfil</div>
            <div class="mobile-divider"></div>
            <div class="mobile-menu-item" onclick="showExportOptions();closeMobileMenu()"><i class="fas fa-download"></i> Exportar</div>
            <div class="mobile-menu-item" onclick="importData();closeMobileMenu()"><i class="fas fa-upload"></i> Importar</div>
        </div>

        <input type="file" id="importFileInput" accept=".json" style="display:none;" onchange="handleImportFile(event)">

        <!-- Inline Search -->
        <div class="inline-search">
            <input type="text" id="searchInput" placeholder="Pesquisar publicações..." oninput="filterPosts(this.value)">
            <i class="fas fa-search search-icon"></i>
        </div>

        <div class="filter-tags-wrap" id="filterTagsWrap" style="display:none;">
            <div class="filter-tags" id="filterTags"></div>
            <div class="filter-tags-toggle" id="filterTagsToggle" onclick="toggleFilterExpand()">
                <i class="fas fa-chevron-down" id="filterToggleIcon"></i>
                <span id="filterToggleText">Ver todas as tags</span>
            </div>
        </div>

        <div id="moodFilterWrap" style="display:none;margin-bottom:10px;">
            <div class="mood-filter-row" id="moodFilterRow"></div>
        </div>

        <div class="section-header">
            <div class="section-title"><i class="fas fa-th-list" id="sectionIcon"></i><span id="sectionTitleText">Todas as Publicações</span></div>
        </div>
        <div class="sort-bar" id="sortBar">
            <span class="sort-bar-label"><i class="fas fa-sort"></i> Ordenar:</span>
            <button class="sort-btn active" id="sortNewest" onclick="setSortOrder('newest')">Mais recentes</button>
            <button class="sort-btn" id="sortOldest" onclick="setSortOrder('oldest')">Mais antigas</button>
            <button class="sort-btn" id="sortAlpha" onclick="setSortOrder('alpha')">A–Z</button>
            <div class="month-filter-wrap">
                <button class="sort-btn" id="sortMonth" onclick="toggleMonthPicker(event)"><i class="fas fa-calendar-alt"></i> Por mês</button>
                <div class="month-picker" id="monthPicker" style="display:none;"></div>
            </div>
        </div>

        <div class="posts-container" id="postsContainer">
            <div class="empty-state"><i class="fas fa-pen-fancy"></i><h3>Nenhuma publicação ainda</h3><p>Comece criando sua primeira publicação!</p></div>
        </div>

        <!-- Generic Confirm Popup -->
        <div class="custom-popup" id="customPopup">
            <div class="popup-content">
                <div class="popup-icon" id="popupIcon"><i class="fas fa-question-circle"></i></div>
                <div class="popup-title" id="popupTitle">Confirmar</div>
                <div class="popup-message" id="popupMessage">Tem certeza?</div>
                <div class="popup-buttons" id="popupButtons"></div>
            </div>
        </div>

        <!-- Lightbox -->
        <div class="lightbox" id="lightbox" onclick="if(event.target===this)closeLightbox()">
            <img class="lightbox-img" id="lightboxImg" src="" alt="">
            <button class="lightbox-close" onclick="closeLightbox()"><i class="fas fa-times"></i></button>
            <button class="lightbox-prev" id="lightboxPrev" onclick="lightboxNav(-1)"><i class="fas fa-chevron-left"></i></button>
            <button class="lightbox-next" id="lightboxNext" onclick="lightboxNav(1)"><i class="fas fa-chevron-right"></i></button>
            <div class="lightbox-counter" id="lightboxCounter"></div>
        </div>

        <!-- Name Popup (first visit) -->
        <div class="name-popup-overlay" id="namePopup">
            <div class="name-popup-box">
                <div class="name-popup-emoji"><i class="fas fa-book-open" style="font-size:0.85em;color:#888;"></i></div>
                <div class="name-popup-title">Bem-vindo ao seu Diário!</div>
                <div class="name-popup-sub">Como você se chama? Isso vai personalizar sua experiência.</div>
                <input class="name-popup-input" id="namePopupInput" type="text" placeholder="Seu nome..." maxlength="60" onkeydown="if(event.key==='Enter')saveNameFromPopup()">
                <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="saveNameFromPopup()">
                    <i class="fas fa-arrow-right"></i> Começar
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="pw-modal" id="settingsModal">
            <div class="pw-modal-box" style="max-width:520px;">
                <div class="pw-modal-header">
                    <div class="pw-modal-title"><i class="fas fa-sliders-h" style="color:#888;"></i> Configurações</div>
                    <button class="close-btn" onclick="closeSettings()"><i class="fas fa-times"></i></button>
                </div>
                <div id="settingsContent"></div>
            </div>
        </div>

        <!-- Profile Edit Modal -->
        <div class="pw-modal" id="profileModal">
            <div class="pw-modal-box">
                <div class="pw-modal-header">
                    <div class="pw-modal-title"><i class="fas fa-user" style="color:#888;"></i> Meu Perfil</div>
                    <button class="close-btn" onclick="closeProfileEdit()"><i class="fas fa-times"></i></button>
                </div>
                <div id="profileContent"></div>
            </div>
        </div>

        <!-- Gallery Action Sheet -->
        <div class="gallery-action-overlay" id="galleryActionOverlay" onclick="if(event.target===this)closeGalleryAction()">
            <div class="gallery-action-sheet">
                <div class="gallery-action-handle"></div>
                <div class="gallery-action-title" id="galleryActionTitle">O que deseja fazer?</div>
                <div class="gallery-action-item" id="galleryActionView" onclick="">
                    <i class="fas fa-file-alt"></i>
                    <div><div class="gai-label">Ver publicação</div><div class="gai-sub">Abrir o post desta foto</div></div>
                </div>
                <div class="gallery-action-item" id="galleryActionPhoto" onclick="">
                    <i class="fas fa-expand-alt"></i>
                    <div><div class="gai-label">Ver foto</div><div class="gai-sub">Abrir em tela cheia</div></div>
                </div>
                <div class="gallery-action-cancel" onclick="closeGalleryAction()"><i class="fas fa-times" style="margin-right:8px;"></i> Cancelar</div>
            </div>
        </div>

        <!-- Link Navigation Popup -->
        <div class="custom-popup" id="linkPopup">
            <div class="popup-content">
                <div class="popup-icon info"><i class="fas fa-external-link-alt"></i></div>
                <div class="popup-title">Abrir Link Externo?</div>
                <div class="popup-message" id="linkPopupMsg">Você está saindo do diário.</div>
                <div class="popup-buttons">
                    <button class="popup-btn popup-btn-cancel" onclick="closeLinkPopup()">Cancelar</button>
                    <button class="popup-btn popup-btn-link" onclick="confirmLinkNav()"><i class="fas fa-external-link-alt"></i> Abrir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Post Modal -->
    <div class="modal" id="postModal">
        <div class="modal-content">
            <div class="modal-top-bar">
                <h2 id="modalTitle"><span class="modal-icon"><i class="fas fa-plus"></i></span> Nova Publicação</h2>
                <button class="close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <form id="postForm">
                <div class="form-body">
                    <!-- Título -->
                    <div class="form-field">
                        <div class="form-field-label"><i class="fas fa-heading"></i> Título</div>
                        <div class="title-field-wrap">
                            <input type="text" id="postTitle" required placeholder="O que aconteceu?" maxlength="100" autocomplete="off">
                            <span class="char-badge" id="titleCounter">0/100</span>
                        </div>
                    </div>

                    <!-- Conteúdo -->
                    <div class="form-field">
                        <div class="form-field-label" style="justify-content:space-between;"><span><i class="fas fa-pen-nib"></i> Conte sua história</span><span class="char-badge" style="position:static;font-size:0.75em;" id="descCounter">0/5000</span></div>
                        <textarea id="postDescription" required placeholder="Escreva sobre o seu dia, seus pensamentos, sentimentos..." maxlength="5000"></textarea>
                    </div>

                    <!-- Humor -->
                    <div class="form-field">
                        <div class="form-field-label"><i class="fas fa-smile"></i> Como você está?</div>
                        <div class="mood-strip" id="moodSelector">
                            <div class="mood-pill" data-mood="apaixonado" onclick="selectMood('apaixonado','😍','Está se sentindo apaixonado')">😍<span class="mood-pill-label">Apaixonado</span></div>
                            <div class="mood-pill" data-mood="grato" onclick="selectMood('grato','☺️','Está se sentindo grato')">☺️<span class="mood-pill-label">Grato</span></div>
                            <div class="mood-pill" data-mood="animado" onclick="selectMood('animado','😃','Está se sentindo animado')">😃<span class="mood-pill-label">Animado</span></div>
                            <div class="mood-pill" data-mood="comemorativo" onclick="selectMood('comemorativo','🥳','Está se sentindo comemorativo')">🥳<span class="mood-pill-label">Comemorativo</span></div>
                            <div class="mood-pill" data-mood="com-risadas" onclick="selectMood('com-risadas','😂','Está se sentindo com risadas')">😂<span class="mood-pill-label">Risos</span></div>
                            <div class="mood-pill" data-mood="brincalhao" onclick="selectMood('brincalhao','🤪','Está se sentindo brincalhão')">🤪<span class="mood-pill-label">Brincalhão</span></div>
                            <div class="mood-pill" data-mood="confuso" onclick="selectMood('confuso','🤔','Está se sentindo confuso')">🤔<span class="mood-pill-label">Confuso</span></div>
                            <div class="mood-pill" data-mood="surpreso" onclick="selectMood('surpreso','😲','Está se sentindo surpreso')">😲<span class="mood-pill-label">Surpreso</span></div>
                            <div class="mood-pill" data-mood="triste" onclick="selectMood('triste','🥺','Está se sentindo triste')">🥺<span class="mood-pill-label">Triste</span></div>
                            <div class="mood-pill" data-mood="muito-triste" onclick="selectMood('muito-triste','😭','Está se sentindo muito triste')">😭<span class="mood-pill-label">Muito triste</span></div>
                            <div class="mood-pill" data-mood="com-raiva" onclick="selectMood('com-raiva','😡','Está se sentindo com raiva')">😡<span class="mood-pill-label">Com raiva</span></div>
                            <div class="mood-pill" data-mood="desapontado" onclick="selectMood('desapontado','🫤','Está se sentindo desapontado')">🫤<span class="mood-pill-label">Desapontado</span></div>
                            <div class="mood-pill" data-mood="com-sono" onclick="selectMood('com-sono','🥱','Está se sentindo com sono')">🥱<span class="mood-pill-label">Com sono</span></div>
                            <div class="mood-pill" data-mood="doente" onclick="selectMood('doente','🤒','Está se sentindo doente')">🤒<span class="mood-pill-label">Doente</span></div>
                            <div class="mood-pill" data-mood="com-fome" onclick="selectMood('com-fome','😋','Está se sentindo com fome')">😋<span class="mood-pill-label">Com fome</span></div>
                            <div class="mood-pill" data-mood="enjoado" onclick="selectMood('enjoado','🤢','Está se sentindo enjoado')">🤢<span class="mood-pill-label">Enjoado</span></div>
                            <div class="mood-pill" data-mood="malicioso" onclick="selectMood('malicioso','😈','Está se sentindo malicioso')">😈<span class="mood-pill-label">Malicioso</span></div>
                            <div class="mood-pill" data-mood="com-vergonha" onclick="selectMood('com-vergonha','😳','Está se sentindo com vergonha')">😳<span class="mood-pill-label">Com vergonha</span></div>
                            <div class="mood-pill" data-mood="com-calor" onclick="selectMood('com-calor','🥵','Está se sentindo com calor')">🥵<span class="mood-pill-label">Com calor</span></div>
                            <div class="mood-pill" data-mood="com-frio" onclick="selectMood('com-frio','🥶','Está se sentindo com frio')">🥶<span class="mood-pill-label">Com frio</span></div>
                        </div>
                    </div>

                    <!-- Hashtags -->
                    <div class="form-field">
                        <div class="form-field-label"><i class="fas fa-hashtag"></i> Hashtags</div>
                        <div class="hashtag-input-wrapper">
                            <input type="text" id="hashtagInput" placeholder="Ex: #viagem, #reflexão..." style="width:100%;padding:12px 14px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:12px;color:#fff;font-family:'Poppins',sans-serif;font-size:0.92em;">
                            <div class="hashtag-suggestions" id="hashtagSuggestions"></div>
                        </div>
                        <div class="selected-hashtags" id="selectedHashtags"></div>
                    </div>

                    <!-- Mídia -->
                    <div class="form-field">
                        <div class="form-field-label"><i class="fas fa-photo-video"></i> Mídia</div>
                        <div class="media-section">
                            <div class="upload-zone" onclick="document.getElementById('imageInput').click()">
                                <input type="file" id="imageInput" accept="image/*" multiple>
                                <span class="upload-zone-icon"><i class="fas fa-image"></i></span>
                                <div class="upload-zone-label">Imagens</div>
                                <div class="upload-zone-sub">JPG, PNG, GIF...</div>
                            </div>
                            <div class="upload-zone" onclick="document.getElementById('audioInput').click()">
                                <input type="file" id="audioInput" accept="audio/*">
                                <span class="upload-zone-icon"><i class="fas fa-music"></i></span>
                                <div class="upload-zone-label">Áudio</div>
                                <div class="upload-zone-sub">MP3, WAV, M4A...</div>
                            </div>
                        </div>
                        <div class="images-preview-grid" id="imagesPreviewGrid" style="display:none;margin-top:10px;"></div>
                        <div class="file-preview" id="audioPreview"></div>
                    </div>

                    <!-- Senha -->
                    <div class="form-field">
                        <div class="lock-toggle-row" onclick="togglePostPwField()">
                            <input type="checkbox" id="postPwCheck">
                            <label for="postPwCheck"><i class="fas fa-lock" style="color:#555;"></i> Proteger esta publicação com senha</label>
                        </div>
                        <div class="post-pw-field" id="postPwField">
                            <input type="password" id="postPasswordInput" placeholder="Defina a senha..." style="width:100%;padding:12px 14px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:12px;color:#fff;font-family:'Poppins',sans-serif;font-size:0.92em;">
                        </div>
                    </div>
                </div>

                <!-- Footer fixo -->
                <div class="form-footer">
                    <button type="button" class="btn" onclick="saveDraft()"><i class="fas fa-clock"></i> Rascunho</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> Publicar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lock Screen -->
    <div class="lock-screen" id="lockScreen">
        <div class="lock-box">
            <div class="lock-icon-big"><i class="fas fa-lock" style="font-size:0.7em;color:#555;"></i></div>
            <div class="lock-box-title">Diário Bloqueado</div>
            <div class="lock-box-sub" id="lockBoxSub">Digite sua senha para acessar</div>
            <div class="lock-input-wrap">
                <input type="password" id="lockPwInput" placeholder="Senha..." onkeydown="if(event.key==='Enter')checkAppPw()">
                <button class="toggle-vis-btn" onclick="toggleLockVis()" type="button"><i class="fas fa-eye" id="lockEyeIco"></i></button>
            </div>
            <div class="lock-err" id="lockErrMsg"></div>
            <button class="btn btn-primary" style="width:100%;" onclick="checkAppPw()"><i class="fas fa-unlock"></i> Desbloquear</button>
            <div class="lock-reset-link" onclick="doReset()">Esqueceu a senha? Redefinir (apaga tudo)</div>
        </div>
    </div>

    <!-- Password Manager -->
    <div class="pw-modal" id="pwManagerModal">
        <div class="pw-modal-box">
            <div class="pw-modal-header">
                <div class="pw-modal-title"><i class="fas fa-shield-alt" style="color:#9c27b0;"></i> Senha do Diário</div>
                <button class="close-btn" onclick="closePwManager()"><i class="fas fa-times"></i></button>
            </div>
            <div id="pwManagerContent"></div>
        </div>
    </div>

    <!-- Post Unlock Modal -->
    <div class="pw-modal" id="postUnlockModal">
        <div class="pw-modal-box">
            <div class="pw-modal-header">
                <div class="pw-modal-title"><i class="fas fa-lock" style="color:#9c27b0;"></i> Publicação Protegida</div>
                <button class="close-btn" onclick="closePostUnlock()"><i class="fas fa-times"></i></button>
            </div>
            <p style="color:#999;margin-bottom:18px;font-size:0.92em;">Digite a senha para visualizar esta publicação.</p>
            <div class="lock-input-wrap" style="margin-bottom:12px;">
                <input type="password" id="postUnlockInput" placeholder="Senha..." onkeydown="if(event.key==='Enter')checkPostPw()">
                <button class="toggle-vis-btn" onclick="togglePostUnlockVis()" type="button"><i class="fas fa-eye" id="postUnlockEye"></i></button>
            </div>
            <div class="lock-err" id="postUnlockErr"></div>
            <button class="btn btn-primary" style="width:100%;margin-bottom:10px;" onclick="checkPostPw()"><i class="fas fa-unlock"></i> Ver publicação</button>
            <button class="btn" style="width:100%;justify-content:center;font-size:0.85em;color:#666;border-color:#1e1e1e;" onclick="forgotPostPassword()"><i class="fas fa-question-circle"></i> Não lembro a senha</button>
        </div>
    </div>

    <!-- Trash Modal -->
    <div class="modal" id="trashModal">
        <div class="trash-modal-content">
            <div class="trash-top-bar">
                <h2><span class="trash-icon-wrap"><i class="fas fa-trash-alt"></i></span> Lixeira</h2>
                <button class="close-btn" onclick="closeTrash()"><i class="fas fa-times"></i></button>
            </div>
            <div class="trash-actions-bar">
                <span class="trash-count-badge" id="trashCountBadge">0 itens</span>
                <button class="trash-empty-all-btn" onclick="emptyTrashAll()"><i class="fas fa-fire-alt"></i> Esvaziar lixeira</button>
            </div>
            <div class="trash-list" id="trashList"></div>
            <div class="trash-footer-note"><i class="fas fa-clock"></i> Publicações ficam na lixeira por 7 dias e são removidas automaticamente</div>
        </div>
    </div>

    <script>

        // === STATE ===
        let posts = JSON.parse(localStorage.getItem('diaryPosts')) || [];
        let userName = localStorage.getItem('userName') || '';
        let sortOrder = localStorage.getItem('sortOrder') || 'newest';
        let monthFilter = null;
        let monthPickerYear = new Date().getFullYear();
        let trash = JSON.parse(localStorage.getItem('diaryTrash')) || [];
        let menuBadges = JSON.parse(localStorage.getItem('menuBadges')) || { drafts:0, favorites:0, gallery:0, trash:0 };
        let prefs = Object.assign({
            showWordCount: false,
            compactView: false,
            showMood: true,
            confirmDelete: true,
            autoGreeting: true,
            fontSize: 'normal',
            showEditedBadge: true,
            animatePosts: true,
            showDateFull: true,
            autoSaveDraft: false,
            autoSaveDraftOnLeave: false,
            showHashtagFilter: false,
            highlightFavorites: true,
            showHashtagsCount: true,
            galleryColumns: 'auto',
            trashEnabled: true
        }, JSON.parse(localStorage.getItem('userPrefs')) || {});
        let usedHashtags = JSON.parse(localStorage.getItem('usedHashtags')) || [];
        let currentFilter = null;
        let currentView = 'all';
        let editingPostId = null;
        let selectedHashtags = [];
        let selectedMood = null;
        let selectedMoodEmoji = null;
        let selectedMoodText = null;
        let viewMode = localStorage.getItem('viewMode') || 'list';
        let pendingImages = []; // [{data, name}]
        let existingImages = []; // [data_url]
        let pendingLinkUrl = null;
        let pendingPostPwId = null;
        let unlockedPosts = new Set();
        let appPassword = localStorage.getItem('appPassword') || null;
        let appUnlocked = !appPassword;
        let lockSt = JSON.parse(localStorage.getItem('lockState')) || {attempts:0,lockUntil:null,cooldowns:0,dayLockUntil:null};
        const carouselIdx = {};

        // === INIT ===
        document.addEventListener('DOMContentLoaded', () => {
            if (viewMode === 'grid') {
                document.getElementById('postsContainer').classList.add('grid-view');
                document.getElementById('gridModeBtn').classList.add('active');
                document.getElementById('listModeBtn').classList.remove('active');
            }
            setupEventListeners();
            // Firebase auth will call launchApp() after login
        });

        function launchApp() {
            if (appPassword && !appUnlocked) {
                document.getElementById('lockScreen').classList.add('show');
                updateLockUI();
            } else {
                appUnlocked = true;
                if (!userName) {
                    document.getElementById('namePopup').classList.add('show');
                    setTimeout(()=>document.getElementById('namePopupInput').focus(), 300);
                } else {
                    initApp();
                }
            }
        }

        function initApp() {
            purgeOldTrash();
            applyPrefs();
            updateGreeting();
            renderPosts();
            renderFilterTags();
            renderStreakBadge();
            renderMoodFilter();
            loadTheme();
            updateTrashDropdownBadge();
            renderAllMenuBadges();
            updateTrashVisibility();
        }

        function updateGreeting() {
            const el = document.getElementById('greetingText');
            if (!el || !prefs.autoGreeting) { if(el) el.parentElement.style.display='none'; return; }
            if (!userName) { el.parentElement.style.display='none'; return; }
            el.parentElement.style.display='block';
            const first = userName.split(' ')[0];
            const h = new Date().getHours();
            let msg;
            if (h >= 5 && h < 12) msg = `Olá, <strong>${first}</strong>! Bom dia! <i class="fas fa-sun" style="color:#f9c74f;"></i>`;
            else if (h >= 12 && h < 19) msg = `Olá, <strong>${first}</strong>! Boa tarde! <i class="fas fa-cloud-sun" style="color:#f9c74f;"></i>`;
            else if (h >= 19) msg = `Olá, <strong>${first}</strong>! Boa noite! <i class="fas fa-moon" style="color:#aab4d4;"></i>`;
            else msg = `Olá, <strong>${first}</strong>! Boa madrugada! <i class="fas fa-star" style="color:#aab4d4;"></i>`;
            el.innerHTML = msg;
        }

        function applyPrefs() {
            ['newest','oldest','alpha'].forEach(o=>{ const b=document.getElementById('sort'+o.charAt(0).toUpperCase()+o.slice(1)); if(b){b.classList.toggle('active',o===sortOrder);} });
            document.body.style.fontSize = prefs.fontSize === 'large' ? '17px' : prefs.fontSize === 'small' ? '14px' : '';
            const pc = document.getElementById('postsContainer');
            if(pc) {
                pc.classList.toggle('compact-view', !!prefs.compactView);
                pc.classList.toggle('no-anim', !prefs.animatePosts);
                pc.classList.toggle('highlight-favs', !!prefs.highlightFavorites);
            }
        }

        function checkNameOnLoad() {
            if (!userName) {
                document.getElementById('namePopup').classList.add('show');
                setTimeout(()=>document.getElementById('namePopupInput').focus(), 300);
            } else {
                initApp();
            }
        }

        function saveNameFromPopup() {
            const val = document.getElementById('namePopupInput').value.trim();
            if (!val) { document.getElementById('namePopupInput').style.borderColor='#f44336'; setTimeout(()=>{document.getElementById('namePopupInput').style.borderColor='#2a2a2a';},700); return; }
            userName = val;
            localStorage.setItem('userName', val);
            document.getElementById('namePopup').classList.remove('show');
            initApp();
        }

        // === PROFILE ===
        function openProfileEdit() {
            document.getElementById('profileModal').classList.add('show');
            renderProfileContent();
        }
        function closeProfileEdit() { document.getElementById('profileModal').classList.remove('show'); }

        function renderProfileContent() {
            const first = userName ? userName.split(' ')[0] : '—';
            const totalPosts = posts.filter(p=>!p.isDraft).length;
            const totalDrafts = posts.filter(p=>p.isDraft).length;
            const totalFavs = posts.filter(p=>p.isFavorite).length;
            const totalWords = posts.filter(p=>!p.isDraft).reduce((s,p)=>s+(p.description?p.description.split(/\s+/).filter(w=>w).length:0),0);
            const totalImages = posts.filter(p=>p.images&&p.images.length>0||p.image).length;
            const memberSince = posts.length ? new Date(Math.min(...posts.map(p=>p.timestamp))).toLocaleDateString('pt-BR',{day:'2-digit',month:'long',year:'numeric'}) : 'Ainda sem posts';
            const bio = localStorage.getItem('userBio') || '';
            const writingGoal = localStorage.getItem('writingGoal') || '';
            const moodCount = {}; posts.forEach(p=>{ if(p.moodEmoji){moodCount[p.moodEmoji]=(moodCount[p.moodEmoji]||0)+1;} });
            const topMood = Object.entries(moodCount).sort((a,b)=>b[1]-a[1])[0];

            document.getElementById('profileContent').innerHTML = `
                <div style="text-align:center;padding:8px 0 22px;">
                    <div style="width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,#2a2a2a,#444);display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:2em;border:2px solid rgba(255,255,255,0.08);">
                        <i class="fas fa-user" style="color:#666;font-size:0.8em;"></i>
                    </div>
                    <div style="font-size:1.2em;font-weight:600;color:#fff;">${userName || '—'}</div>
                    ${topMood?`<div style="margin-top:6px;font-size:0.82em;color:#555;">Humor mais frequente: ${topMood[0]} <span style="color:#444;">(${topMood[1]}x)</span></div>`:''}
                </div>

                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:22px;">
                    ${[
                        ['fas fa-pen-nib','#7bb3ff',totalPosts,'Posts'],
                        ['fas fa-file-alt','#ffc107',totalDrafts,'Rascunhos'],
                        ['fas fa-star','#ffaa00',totalFavs,'Favoritos'],
                        ['fas fa-font','#4ade80',totalWords.toLocaleString(),'Palavras'],
                        ['fas fa-image','#ce93d8',totalImages,'Com fotos'],
                        ['fas fa-calendar-alt','#64b5f6',memberSince.split(' ').slice(0,2).join(' '),'Primeiro post'],
                    ].map(([ic,col,val,lbl])=>`
                        <div style="padding:14px 10px;background:rgba(42,42,42,0.3);border:1px solid rgba(255,255,255,0.05);border-radius:12px;text-align:center;">
                            <i class="${ic}" style="color:${col};font-size:1.1em;display:block;margin-bottom:6px;opacity:0.85;"></i>
                            <div style="font-size:1em;font-weight:700;color:#ddd;">${val}</div>
                            <div style="font-size:0.68em;color:#555;margin-top:2px;">${lbl}</div>
                        </div>`).join('')}
                </div>

                <div style="margin-bottom:16px;">
                    <label style="font-size:0.78em;color:#555;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;display:flex;align-items:center;gap:6px;margin-bottom:8px;"><i class="fas fa-user"></i> Nome completo</label>
                    <input type="text" id="profileNameInput" value="${userName}" placeholder="Seu nome..." style="width:100%;padding:13px 15px;background:rgba(10,10,10,0.6);border:1px solid #2a2a2a;border-radius:12px;color:#fff;font-family:Poppins,sans-serif;font-size:0.95em;" maxlength="60">
                </div>

                <div style="margin-bottom:16px;">
                    <label style="font-size:0.78em;color:#555;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;display:flex;align-items:center;gap:6px;margin-bottom:8px;"><i class="fas fa-quote-left"></i> Bio / Sobre mim</label>
                    <textarea id="profileBioInput" placeholder="Escreva algo sobre você..." style="width:100%;padding:13px 15px;background:rgba(10,10,10,0.6);border:1px solid #2a2a2a;border-radius:12px;color:#fff;font-family:Poppins,sans-serif;font-size:0.92em;resize:vertical;min-height:80px;line-height:1.6;" maxlength="200">${bio}</textarea>
                </div>

                <div style="margin-bottom:20px;">
                    <label style="font-size:0.78em;color:#555;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;display:flex;align-items:center;gap:6px;margin-bottom:8px;"><i class="fas fa-bullseye"></i> Meta de escrita</label>
                    <select id="profileGoalInput" style="width:100%;padding:13px 15px;background:rgba(10,10,10,0.6);border:1px solid #2a2a2a;border-radius:12px;color:#fff;font-family:Poppins,sans-serif;font-size:0.92em;">
                        <option value="" ${!writingGoal?'selected':''}>Sem meta definida</option>
                        <option value="1" ${'1'===writingGoal?'selected':''}>1 post por semana</option>
                        <option value="3" ${'3'===writingGoal?'selected':''}>3 posts por semana</option>
                        <option value="5" ${'5'===writingGoal?'selected':''}>5 posts por semana</option>
                        <option value="7" ${'7'===writingGoal?'selected':''}>1 post por dia</option>
                    </select>
                </div>

                <div class="pw-err" id="profileErr"></div>
                <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="saveProfile()"><i class="fas fa-save"></i> Salvar Perfil</button>
                <button class="btn" style="width:100%;justify-content:center;margin-top:10px;background:rgba(99,102,241,0.12);border-color:rgba(99,102,241,0.3);color:#a5b4fc;" onclick="shareProfile()"><i class="fas fa-share-alt"></i> Compartilhar Perfil</button>

                <div style="margin-top:14px;padding:14px 15px;background:rgba(42,42,42,0.2);border-radius:12px;font-size:0.78em;color:#444;line-height:1.7;">
                    <i class="fas fa-info-circle" style="margin-right:6px;"></i> Membro desde: <span style="color:#555;">${memberSince}</span>
                </div>`;
        }

        function saveProfile() {
            const val = document.getElementById('profileNameInput').value.trim();
            const err = document.getElementById('profileErr');
            if (!val) { err.textContent='Digite um nome'; return; }
            userName = val; localStorage.setItem('userName', val);
            const bio = document.getElementById('profileBioInput')?.value || '';
            localStorage.setItem('userBio', bio);
            const goal = document.getElementById('profileGoalInput')?.value || '';
            localStorage.setItem('writingGoal', goal);
            closeProfileEdit();
            updateGreeting();
            showNotification('Perfil atualizado!', 'success');
        }

        function shareProfile() {
            const totalPosts = posts.filter(p=>!p.isDraft).length;
            const totalWords = posts.filter(p=>!p.isDraft).reduce((s,p)=>s+(p.description?p.description.split(/\s+/).filter(w=>w).length:0),0);
            const totalFavs = posts.filter(p=>p.isFavorite).length;
            const { streak } = calculateStreak();
            const bio = localStorage.getItem('userBio') || '';
            const moodCount = {}; posts.forEach(p=>{ if(p.moodEmoji){moodCount[p.moodEmoji]=(moodCount[p.moodEmoji]||0)+1;} });
            const topMood = Object.entries(moodCount).sort((a,b)=>b[1]-a[1])[0];
            const memberSince = posts.length ? new Date(Math.min(...posts.map(p=>p.timestamp))).toLocaleDateString('pt-BR',{day:'2-digit',month:'long',year:'numeric'}) : null;
            const now = new Date();
            const takenAt = now.toLocaleDateString('pt-BR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'}) + ' às ' + now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});

            const canvas = document.createElement('canvas');
            const W = 800, H = 520;
            canvas.width = W; canvas.height = H;
            const ctx = canvas.getContext('2d');

            // Background
            const bg = ctx.createLinearGradient(0,0,W,H);
            bg.addColorStop(0,'#0d0d0d');
            bg.addColorStop(1,'#1a1a2e');
            ctx.fillStyle = bg;
            ctx.fillRect(0,0,W,H);

            // Subtle grid texture
            ctx.strokeStyle = 'rgba(255,255,255,0.02)';
            ctx.lineWidth = 1;
            for(let x=0;x<W;x+=40){ ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke(); }
            for(let y=0;y<H;y+=40){ ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke(); }

            // Top accent bar
            const accentGrad = ctx.createLinearGradient(0,0,W,0);
            accentGrad.addColorStop(0,'#6366f1');
            accentGrad.addColorStop(0.5,'#a855f7');
            accentGrad.addColorStop(1,'#6366f1');
            ctx.fillStyle = accentGrad;
            ctx.fillRect(0,0,W,4);

            // "Foto tirada em" label at top
            ctx.fillStyle = 'rgba(255,255,255,0.25)';
            ctx.font = '500 13px system-ui,sans-serif';
            ctx.fillText('Foto tirada em ' + takenAt, 24, 28);

            // Avatar circle
            const cx = 100, cy = 160;
            ctx.save();
            const avatarGrad = ctx.createRadialGradient(cx,cy,10,cx,cy,60);
            avatarGrad.addColorStop(0,'#3a3a5c');
            avatarGrad.addColorStop(1,'#1e1e3a');
            ctx.beginPath();ctx.arc(cx,cy,58,0,Math.PI*2);
            ctx.fillStyle=avatarGrad; ctx.fill();
            ctx.strokeStyle='rgba(99,102,241,0.4)'; ctx.lineWidth=2; ctx.stroke();
            ctx.restore();

            // Person icon in avatar
            ctx.fillStyle='rgba(165,180,252,0.7)';
            ctx.font='bold 38px FontAwesome';
            ctx.textAlign='center';
            ctx.fillText('\uf007',cx,cy+14);

            // Name
            ctx.textAlign='left';
            ctx.fillStyle='#ffffff';
            ctx.font='bold 32px system-ui,sans-serif';
            ctx.fillText(userName||'—', 178, 140);

            // Bio
            if(bio){
                ctx.fillStyle='rgba(255,255,255,0.5)';
                ctx.font='400 15px system-ui,sans-serif';
                // Wrap bio text
                const maxW=530, words=bio.split(' ');
                let line='', y2=168;
                for(const w of words){
                    const test=line?line+' '+w:w;
                    if(ctx.measureText(test).width>maxW){ctx.fillText(line,178,y2);line=w;y2+=20;}
                    else line=test;
                }
                if(line)ctx.fillText(line,178,y2);
            }

            // Top mood
            if(topMood){
                ctx.fillStyle='rgba(255,255,255,0.35)';
                ctx.font='400 14px system-ui,sans-serif';
                ctx.fillText('Humor mais frequente: '+topMood[0], 178, bio?210:172);
            }

            // Member since
            if(memberSince){
                ctx.fillStyle='rgba(255,255,255,0.3)';
                ctx.font='400 13px system-ui,sans-serif';
                const yms = bio?(topMood?228:208):(topMood?188:168);
                ctx.fillText('Membro desde ' + memberSince, 178, yms);
            }

            // Divider
            ctx.strokeStyle='rgba(255,255,255,0.08)';
            ctx.lineWidth=1;
            ctx.beginPath();ctx.moveTo(40,250);ctx.lineTo(W-40,250);ctx.stroke();

            // Stats grid
            const stats=[
                ['\uf304','Posts',totalPosts,'#a5b4fc'],
                ['\uf005','Favoritos',totalFavs,'#fbbf24'],
                ['\uf46d','Palavras',totalWords.toLocaleString(),'#4ade80'],
                ['\uf46a','Streak',streak+'d','#fb923c'],
            ];
            const colW=(W-80)/4;
            stats.forEach(([icon,label,val,color],i)=>{
                const sx=40+i*colW+colW/2;
                // Icon
                ctx.fillStyle=color;
                ctx.font='18px FontAwesome';
                ctx.textAlign='center';
                ctx.fillText(icon,sx,300);
                // Value
                ctx.fillStyle='#ffffff';
                ctx.font='bold 26px system-ui,sans-serif';
                ctx.fillText(val,sx,336);
                // Label
                ctx.fillStyle='rgba(255,255,255,0.35)';
                ctx.font='400 12px system-ui,sans-serif';
                ctx.fillText(label,sx,356);
            });

            // Divider
            ctx.strokeStyle='rgba(255,255,255,0.06)';
            ctx.beginPath();ctx.moveTo(40,376);ctx.lineTo(W-40,376);ctx.stroke();

            // Footer
            ctx.textAlign='center';
            ctx.fillStyle='rgba(255,255,255,0.18)';
            ctx.font='400 13px system-ui,sans-serif';
            ctx.fillText('Meu Diário Digital', W/2, 410);

            // Watermark dots
            for(let i=0;i<3;i++){
                ctx.beginPath();
                ctx.arc(W/2-20+i*20, 428, 3, 0, Math.PI*2);
                ctx.fillStyle='rgba(99,102,241,0.4)';
                ctx.fill();
            }

            // Download
            const link = document.createElement('a');
            link.download = 'meu-perfil-diario.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            showNotification('Imagem do perfil baixada!', 'success');
        }

        // === SETTINGS ===
        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
            renderSettings();
        }
        function closeSettings() { document.getElementById('settingsModal').classList.remove('show'); }

        function renderSettings() {
            document.getElementById('settingsContent').innerHTML = `
                <div class="settings-section">
                    <div class="settings-section-title"><i class="fas fa-eye"></i> Aparência</div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Tamanho da fonte</div><div class="settings-row-sub">Ajusta o tamanho do texto nas publicações</div></div>
                        <select class="settings-select" onchange="updatePref('fontSize',this.value)">
                            <option value="small" ${prefs.fontSize==='small'?'selected':''}>Pequena</option>
                            <option value="normal" ${prefs.fontSize==='normal'?'selected':''}>Normal</option>
                            <option value="large" ${prefs.fontSize==='large'?'selected':''}>Grande</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Visualização compacta</div><div class="settings-row-sub">Posts com menos espaçamento entre si</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.compactView?'checked':''} onchange="updatePref('compactView',this.checked)"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Animações nos posts</div><div class="settings-row-sub">Efeitos suaves ao carregar publicações</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.animatePosts?'checked':''} onchange="updatePref('animatePosts',this.checked)"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Destacar favoritos</div><div class="settings-row-sub">Borda dourada em publicações favoritas</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.highlightFavorites?'checked':''} onchange="updatePref('highlightFavorites',this.checked)"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Colunas na Galeria</div><div class="settings-row-sub">Quantidade de fotos por linha</div></div>
                        <select class="settings-select" onchange="updatePref('galleryColumns',this.value)">
                            <option value="auto" ${prefs.galleryColumns==='auto'?'selected':''}>Automático</option>
                            <option value="2" ${prefs.galleryColumns==='2'?'selected':''}>2 colunas</option>
                            <option value="3" ${prefs.galleryColumns==='3'?'selected':''}>3 colunas</option>
                            <option value="4" ${prefs.galleryColumns==='4'?'selected':''}>4 colunas</option>
                        </select>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title"><i class="fas fa-magic"></i> Funcionalidades</div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Lixeira</div><div class="settings-row-sub">Posts excluídos ficam 7 dias na lixeira antes de sumir</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.trashEnabled?'checked':''} onchange="updatePref('trashEnabled',this.checked);updateTrashVisibility()"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Saudação personalizada</div><div class="settings-row-sub">Exibe "Bom dia/tarde/noite" com seu nome</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.autoGreeting?'checked':''} onchange="updatePref('autoGreeting',this.checked)"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Exibir emoji de humor</div><div class="settings-row-sub">Mostra o humor selecionado nas publicações</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.showMood?'checked':''} onchange="updatePref('showMood',this.checked)"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Contagem de palavras</div><div class="settings-row-sub">Mostra palavras e tempo de leitura estimado</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.showWordCount?'checked':''} onchange="updatePref('showWordCount',this.checked)"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Badge "Editado"</div><div class="settings-row-sub">Mostra etiqueta quando um post foi editado</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.showEditedBadge?'checked':''} onchange="updatePref('showEditedBadge',this.checked)"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Data completa nos posts</div><div class="settings-row-sub">Exibe dia/mês/ano em vez de "há X dias"</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.showDateFull?'checked':''} onchange="updatePref('showDateFull',this.checked)"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Confirmar exclusão</div><div class="settings-row-sub">Pede confirmação antes de deletar posts</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.confirmDelete?'checked':''} onchange="updatePref('confirmDelete',this.checked)"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Contador de hashtags</div><div class="settings-row-sub">Mostra quantos posts usam cada tag</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.showHashtagsCount?'checked':''} onchange="updatePref('showHashtagsCount',this.checked)"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Visor de hashtags</div><div class="settings-row-sub">Exibe a barra de filtro de # acima dos posts</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.showHashtagFilter?'checked':''} onchange="updatePref('showHashtagFilter',this.checked);renderFilterTags()"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Salvar rascunho ao sair</div><div class="settings-row-sub">Ao fechar o formulário com conteúdo digitado, salva como rascunho automaticamente</div></div>
                        <label class="toggle-switch"><input type="checkbox" ${prefs.autoSaveDraftOnLeave?'checked':''} onchange="updatePref('autoSaveDraftOnLeave',this.checked)"><span class="toggle-slider"></span></label>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title"><i class="fas fa-trash-alt"></i> Dados</div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Exportar diário</div><div class="settings-row-sub">Baixar todas as publicações em JSON</div></div>
                        <button class="btn" style="padding:8px 16px;font-size:0.82em;" onclick="exportData()"><i class="fas fa-download"></i> Exportar</button>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Importar diário</div><div class="settings-row-sub">Restaurar publicações de um arquivo JSON</div></div>
                        <button class="btn" style="padding:8px 16px;font-size:0.82em;" onclick="importData()"><i class="fas fa-upload"></i> Importar</button>
                    </div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Redefinir preferências</div><div class="settings-row-sub">Volta todas as configurações ao padrão</div></div>
                        <button class="btn" style="padding:8px 16px;font-size:0.82em;border-color:#3a2020;color:#aa5555;" onclick="resetPrefs()"><i class="fas fa-undo"></i> Redefinir</button>
                    </div>
                </div>
                <div style="padding:14px 16px;background:rgba(42,42,42,0.2);border-radius:12px;font-size:0.78em;color:#444;text-align:center;">
                    <i class="fas fa-shield-alt"></i> As configurações ficam salvas localmente no seu navegador.
                </div>`;
        }

        function resetPrefs() {
            if(!confirm('Redefinir todas as preferências para o padrão?')) return;
            prefs = { showWordCount:false, compactView:false, showMood:true, confirmDelete:true, autoGreeting:true, fontSize:'normal', showEditedBadge:true, animatePosts:true, showDateFull:true, autoSaveDraft:false, autoSaveDraftOnLeave:false, showHashtagFilter:false, highlightFavorites:true, showHashtagsCount:true, galleryColumns:'auto', trashEnabled:true };
            localStorage.setItem('userPrefs', JSON.stringify(prefs));
            applyPrefs(); updateGreeting(); renderPosts(); renderSettings();
            showNotification('Preferências redefinidas!', 'info');
        }

        function updatePref(key, value) {
            prefs[key] = value;
            localStorage.setItem('userPrefs', JSON.stringify(prefs));
            applyPrefs();
            updateGreeting();
            renderPosts();
        }

        function updateTrashVisibility() {
            const ddItem = document.getElementById('trashDropdownItem');
            const mmiTrash = document.getElementById('mmi-trash');
            if (ddItem) ddItem.style.display = prefs.trashEnabled ? '' : 'none';
            if (mmiTrash) mmiTrash.style.display = prefs.trashEnabled ? '' : 'none';
        }

        function setupEventListeners() {
            let searchDebounce;
            const si = document.getElementById('searchInput');
            if(si) si.addEventListener('input', e => { clearTimeout(searchDebounce); searchDebounce = setTimeout(() => filterPosts(e.target.value), 200); });
            document.getElementById('imageInput').addEventListener('change', e => handleImagesSelected(e.target.files));
            document.getElementById('audioInput').addEventListener('change', e => handleAudioSelected(e.target.files[0]));
            const hi = document.getElementById('hashtagInput');
            hi.addEventListener('input', e => handleHashtagInput(e.target.value));
            hi.addEventListener('keydown', e => {
                if (e.key === 'Enter') { e.preventDefault(); const v = e.target.value.trim(); if(v){addHashtag(v.startsWith('#')?v:'#'+v);e.target.value='';} }
            });
            document.getElementById('postTitle').addEventListener('input', e => updateCC('titleCounter', e.target.value.length, 100));
            document.getElementById('postDescription').addEventListener('input', e => updateCC('descCounter', e.target.value.length, 5000));
            document.getElementById('postForm').addEventListener('submit', e => { e.preventDefault(); savePost(false); });
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') { closeModal(); closeDropdown(); closeMobileMenu(); closePostUnlock(); closePwManager(); closeLinkPopup(); closeLightbox(); closeGalleryAction(); closeTrash(); }
                if (document.getElementById('lightbox').classList.contains('show')) {
                    if (e.key === 'ArrowLeft') lightboxNav(-1);
                    if (e.key === 'ArrowRight') lightboxNav(1);
                }
            });
            document.addEventListener('click', e => {
                if (!e.target.closest('.dropdown')) closeDropdown();
                if (!e.target.closest('.mobile-menu') && !e.target.closest('.mobile-menu-btn')) closeMobileMenu();
            });
        }

        // === LOCK SCREEN ===
        function updateLockUI() {
            const now = Date.now();
            const sub = document.getElementById('lockBoxSub');
            const err = document.getElementById('lockErrMsg');
            if (lockSt.dayLockUntil && now < lockSt.dayLockUntil) {
                const rem = Math.ceil((lockSt.dayLockUntil - now)/60000);
                const h = Math.floor(rem/60), m = rem%60;
                err.textContent = `Bloqueado por ${h>0?h+'h ':''}${m}min`;
                sub.textContent = 'Muitas tentativas incorretas';
            } else if (lockSt.lockUntil && now < lockSt.lockUntil) {
                const rem = Math.ceil((lockSt.lockUntil - now)/1000);
                err.textContent = `Aguarde ${rem}s`;
                sub.textContent = 'Muitas tentativas incorretas';
                setTimeout(updateLockUI, 1000);
            } else {
                err.textContent = lockSt.attempts > 0 ? (10-lockSt.attempts)+' tentativa(s) restante(s)' : '';
                sub.textContent = 'Digite sua senha para acessar';
            }
        }

        function saveLockSt() { localStorage.setItem('lockState', JSON.stringify(lockSt)); }

        function isLockLocked() {
            const now = Date.now();
            return (lockSt.dayLockUntil && now < lockSt.dayLockUntil) || (lockSt.lockUntil && now < lockSt.lockUntil);
        }

        function checkAppPw() {
            if (isLockLocked()) { updateLockUI(); return; }
            const v = document.getElementById('lockPwInput').value;
            if (v === appPassword) {
                lockSt = {attempts:0,lockUntil:null,cooldowns:0,dayLockUntil:null}; saveLockSt();
                appUnlocked = true;
                document.getElementById('lockScreen').classList.remove('show');
                checkNameOnLoad();
            } else {
                lockSt.attempts++;
                if (lockSt.attempts >= 10) {
                    lockSt.cooldowns++;
                    lockSt.attempts = 0;
                    if (lockSt.cooldowns >= 4) { lockSt.dayLockUntil = Date.now()+86400000; lockSt.cooldowns=0; }
                    else { lockSt.lockUntil = Date.now()+300000; }
                }
                saveLockSt();
                document.getElementById('lockPwInput').value = '';
                document.getElementById('lockPwInput').style.borderColor = '#f44336';
                setTimeout(() => { document.getElementById('lockPwInput').style.borderColor = '#2a2a2a'; }, 700);
                updateLockUI();
            }
        }

        function toggleLockVis() {
            const i = document.getElementById('lockPwInput');
            const ic = document.getElementById('lockEyeIco');
            if (i.type==='password'){i.type='text';ic.className='fas fa-eye-slash';}
            else{i.type='password';ic.className='fas fa-eye';}
        }

        async function doReset() {
            const ok = await showPopup({type:'error',title:'Redefinir Senha',message:'Isso vai apagar TODOS os seus posts e remover a senha. Ação irreversível!',confirm:true,confirmText:'Apagar tudo',cancelText:'Cancelar'});
            if (ok) {
                posts=[]; usedHashtags=[]; appPassword=null; appUnlocked=true;
                lockSt={attempts:0,lockUntil:null,cooldowns:0,dayLockUntil:null};
                ['diaryPosts','usedHashtags','appPassword','lockState'].forEach(k=>localStorage.removeItem(k));
                document.getElementById('lockScreen').classList.remove('show');
                initApp();
                showNotification('Senha removida e dados apagados', 'info');
            }
        }

        // === PASSWORD MANAGER ===
        function openPasswordManager() {
            document.getElementById('pwManagerModal').classList.add('show');
            renderPwManager();
        }
        function closePwManager() { document.getElementById('pwManagerModal').classList.remove('show'); }

        function renderPwManager() {
            const c = document.getElementById('pwManagerContent');
            if (!appPassword) {
                c.innerHTML = `
                    <p style="color:#888;margin-bottom:18px;font-size:0.9em;">Nenhuma senha configurada. Adicione uma para proteger seu diário.</p>
                    <div class="form-group"><label><i class="fas fa-lock"></i> Nova Senha</label>
                        <input type="password" id="newPw1" placeholder="Digite a senha..." style="width:100%;padding:14px;background:rgba(10,10,10,0.6);border:1px solid #2a2a2a;border-radius:12px;color:#fff;font-family:Poppins,sans-serif;font-size:1em;"></div>
                    <div class="form-group"><label><i class="fas fa-lock"></i> Confirmar Senha</label>
                        <input type="password" id="newPw2" placeholder="Confirme a senha..." style="width:100%;padding:14px;background:rgba(10,10,10,0.6);border:1px solid #2a2a2a;border-radius:12px;color:#fff;font-family:Poppins,sans-serif;font-size:1em;"></div>
                    <div class="pw-err" id="pwErrMsg"></div>
                    <button class="btn btn-primary" style="width:100%;" onclick="setPw()"><i class="fas fa-lock"></i> Definir Senha</button>`;
            } else {
                c.innerHTML = `
                    <p style="color:#888;margin-bottom:18px;font-size:0.9em;">O diário está protegido. O que deseja fazer?</p>
                    <div class="form-group"><label><i class="fas fa-key"></i> Senha Atual</label>
                        <input type="password" id="currPw" placeholder="Senha atual..." style="width:100%;padding:14px;background:rgba(10,10,10,0.6);border:1px solid #2a2a2a;border-radius:12px;color:#fff;font-family:Poppins,sans-serif;font-size:1em;"></div>
                    <div class="pw-err" id="pwErrMsg"></div>
                    <button class="pw-opt-btn" onclick="verifyAndAct('remove')"><i class="fas fa-lock-open"></i> Remover Senha</button>
                    <button class="pw-opt-btn" onclick="verifyAndAct('change')"><i class="fas fa-sync-alt"></i> Alterar Senha</button>
                    <button class="pw-opt-btn danger" onclick="closePwManager();doReset()"><i class="fas fa-trash-alt"></i> Redefinir (apaga tudo)</button>`;
            }
        }

        function setPw() {
            const p1 = document.getElementById('newPw1').value;
            const p2 = document.getElementById('newPw2').value;
            const err = document.getElementById('pwErrMsg');
            if (!p1) { err.textContent='Digite uma senha'; return; }
            if (p1 !== p2) { err.textContent='As senhas não coincidem'; return; }
            appPassword = p1; localStorage.setItem('appPassword', p1);
            closePwManager(); showNotification('Senha configurada!', 'success');
        }

        function verifyAndAct(action) {
            const curr = document.getElementById('currPw').value;
            const err = document.getElementById('pwErrMsg');
            if (curr !== appPassword) { err.textContent='Senha incorreta'; document.getElementById('currPw').value=''; return; }
            if (action === 'remove') {
                appPassword = null; localStorage.removeItem('appPassword');
                closePwManager(); showNotification('Senha removida!', 'success');
            } else {
                document.getElementById('pwManagerContent').innerHTML = `
                    <p style="color:#888;margin-bottom:18px;font-size:0.9em;">Digite e confirme a nova senha.</p>
                    <div class="form-group"><label><i class="fas fa-lock"></i> Nova Senha</label>
                        <input type="password" id="newPw1" placeholder="Nova senha..." style="width:100%;padding:14px;background:rgba(10,10,10,0.6);border:1px solid #2a2a2a;border-radius:12px;color:#fff;font-family:Poppins,sans-serif;font-size:1em;"></div>
                    <div class="form-group"><label><i class="fas fa-lock"></i> Confirmar</label>
                        <input type="password" id="newPw2" placeholder="Confirme..." style="width:100%;padding:14px;background:rgba(10,10,10,0.6);border:1px solid #2a2a2a;border-radius:12px;color:#fff;font-family:Poppins,sans-serif;font-size:1em;"></div>
                    <div class="pw-err" id="pwErrMsg"></div>
                    <button class="btn btn-primary" style="width:100%;" onclick="changePw()"><i class="fas fa-sync-alt"></i> Alterar Senha</button>`;
            }
        }

        function changePw() {
            const p1 = document.getElementById('newPw1').value;
            const p2 = document.getElementById('newPw2').value;
            const err = document.getElementById('pwErrMsg');
            if (!p1) { err.textContent='Digite a nova senha'; return; }
            if (p1 !== p2) { err.textContent='As senhas não coincidem'; return; }
            appPassword = p1; localStorage.setItem('appPassword', p1);
            closePwManager(); showNotification('Senha alterada!', 'success');
        }

        // === POST PASSWORD ===
        function togglePostPwField() {
            const cb = document.getElementById('postPwCheck');
            cb.checked = !cb.checked;
            document.getElementById('postPwField').classList.toggle('show', cb.checked);
            if (!cb.checked) document.getElementById('postPasswordInput').value = '';
        }

        function forgotPostPassword() {
            const postId = parseInt(document.getElementById('postUnlockInput').closest('.pw-modal-box').dataset.postId || document.querySelector('[data-unlock-id]')?.dataset.unlockId || _unlockingPostId);
            closePostUnlock();
            showPopup({
                type: 'warning',
                title: 'Esqueceu a senha?',
                message: 'Sem a senha, não é possível recuperar o conteúdo desta publicação. Se continuar, ela será apagada permanentemente. Isso não pode ser desfeito.',
                confirm: true,
                confirmText: 'Apagar publicação',
                cancelText: 'Cancelar'
            }).then(ok => {
                if(ok) {
                    posts = posts.filter(p=>p.id!==_unlockingPostId);
                    localStorage.setItem('diaryPosts', JSON.stringify(posts));
                    renderPosts();
                    renderFilterTags();
                    showNotification('Publicação apagada.', 'info');
                    _unlockingPostId = null;
                }
            });
        }

        function unlockPost(postId) {
            pendingPostPwId = postId;
            document.getElementById('postUnlockInput').value = '';
            document.getElementById('postUnlockErr').textContent = '';
            document.getElementById('postUnlockModal').classList.add('show');
            setTimeout(() => document.getElementById('postUnlockInput').focus(), 150);
        }

        function closePostUnlock() { document.getElementById('postUnlockModal').classList.remove('show'); pendingPostPwId = null; }

        function togglePostUnlockVis() {
            const i = document.getElementById('postUnlockInput');
            const ic = document.getElementById('postUnlockEye');
            if (i.type==='password'){i.type='text';ic.className='fas fa-eye-slash';}else{i.type='password';ic.className='fas fa-eye';}
        }

        function checkPostPw() {
            if (pendingPostPwId === null) return;
            const post = posts.find(p => p.id === pendingPostPwId);
            if (!post) return;
            const val = document.getElementById('postUnlockInput').value;
            if (val === post.postPassword) {
                unlockedPosts.add(pendingPostPwId);
                closePostUnlock();
                renderPosts();
            } else {
                document.getElementById('postUnlockErr').textContent = 'Senha incorreta, tente novamente';
                document.getElementById('postUnlockInput').value = '';
                document.getElementById('postUnlockInput').style.borderColor = '#f44336';
                setTimeout(() => { document.getElementById('postUnlockInput').style.borderColor = '#2a2a2a'; }, 700);
            }
        }

        // === LINK DETECTION ===
        function renderDescWithLinks(text) {
            const re = /(https?:\/\/[^\s<>"']+)/g;
            return text.replace(re, (url) => {
                const safe = url.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
                return `<a class="ext-link" onclick="openLinkPopup('${safe}')">${url}</a>`;
            });
        }

        function openLinkPopup(url) {
            pendingLinkUrl = url;
            const short = url.length > 70 ? url.substring(0,70)+'...' : url;
            document.getElementById('linkPopupMsg').textContent = 'Você vai sair do diário para: '+short;
            document.getElementById('linkPopup').classList.add('show');
        }
        function closeLinkPopup() { document.getElementById('linkPopup').classList.remove('show'); pendingLinkUrl=null; }
        function confirmLinkNav() { if(pendingLinkUrl) window.open(pendingLinkUrl,'_blank'); closeLinkPopup(); }

        // === POPUP ===
        function showPopup(opts) {
            return new Promise(res => {
                const p = document.getElementById('customPopup');
                const ico = document.getElementById('popupIcon');
                const ti = document.getElementById('popupTitle');
                const msg = document.getElementById('popupMessage');
                const btns = document.getElementById('popupButtons');
                const iconMap = {success:'fa-check-circle',error:'fa-exclamation-circle',warning:'fa-exclamation-triangle',info:'fa-info-circle'};
                ico.className = 'popup-icon '+(opts.type||'warning');
                ico.innerHTML = `<i class="fas ${iconMap[opts.type]||'fa-question-circle'}"></i>`;
                ti.textContent = opts.title||'Confirmar';
                msg.textContent = opts.message||'';
                if (opts.confirm) {
                    btns.innerHTML = `<button class="popup-btn popup-btn-cancel" onclick="closePopup(false)">${opts.cancelText||'Cancelar'}</button><button class="popup-btn popup-btn-confirm" onclick="closePopup(true)">${opts.confirmText||'Confirmar'}</button>`;
                } else {
                    btns.innerHTML = `<button class="popup-btn popup-btn-ok" onclick="closePopup(true)">${opts.okText||'OK'}</button>`;
                }
                p.classList.add('show');
                window._popupRes = res;
            });
        }
        function closePopup(r) { document.getElementById('customPopup').classList.remove('show'); if(window._popupRes){window._popupRes(r);window._popupRes=null;} }

        // === MOBILE MENU ===
        function toggleMobileMenu() { document.getElementById('mobileMenu').classList.toggle('show'); }
        function closeMobileMenu() { document.getElementById('mobileMenu').classList.remove('show'); }
        function toggleDropdown() { document.getElementById('moreDropdown').classList.toggle('show'); }
        function closeDropdown() { const d=document.getElementById('moreDropdown'); if(d)d.classList.remove('show'); }

        // === UTILS ===
        function updateCC(id, cur, max) {
            const el = document.getElementById(id);
            el.textContent = cur+'/'+max;
            el.classList.toggle('warning', cur > max*0.9);
        }
        function fmtDate(ts) {
            const d=new Date(ts);
            return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear()+' às '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
        }
        function fmtAgo(ts) {
            const diff=Date.now()-ts,s=Math.floor(diff/1000),m=Math.floor(s/60),h=Math.floor(m/60),d=Math.floor(h/24),mo=Math.floor(d/30),y=Math.floor(d/365);
            if(s<60)return'agora mesmo';if(m<60)return`há ${m} ${m===1?'minuto':'minutos'}`;if(h<24)return`há ${h} ${h===1?'hora':'horas'}`;if(d<30)return`há ${d} ${d===1?'dia':'dias'}`;if(mo<12)return`há ${mo} ${mo===1?'mês':'meses'}`;
            const rm=mo%12;return rm===0?`há ${y} ${y===1?'ano':'anos'}`:`há ${y} ${y===1?'ano':'anos'} e ${rm} ${rm===1?'mês':'meses'}`;
        }
        function norm(str){return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9\s]/g,'');}
        function readFile(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=rej;r.readAsDataURL(f);});}
        function fmtTime(s){const m=Math.floor(s/60),sec=Math.floor(s%60);return m+':'+String(sec).padStart(2,'0');}

        // === IMAGES ===
        function handleImagesSelected(files) {
            if (!files||!files.length) return;
            Promise.all(Array.from(files).map(f=>readFile(f).then(d=>({data:d,name:f.name})))).then(results => {
                results.forEach(r => { if(!pendingImages.find(i=>i.name===r.name)) pendingImages.push(r); });
                renderImgPreview();
            });
            document.getElementById('imageInput').value = '';
        }

        function renderImgPreview() {
            const g = document.getElementById('imagesPreviewGrid');
            const all = [...existingImages.map((d,i)=>({data:d,ex:true,i})), ...pendingImages.map((img,i)=>({data:img.data,ex:false,i}))];
            if (!all.length) { g.style.display='none'; g.innerHTML=''; return; }
            g.style.display='grid';
            g.innerHTML = all.map(item=>`
                <div class="img-preview-item">
                    <img src="${item.data}" alt="">
                    <button class="rm-img-btn" onclick="removeImg(${item.ex},${item.i})">✕</button>
                </div>`).join('');
        }

        function removeImg(isEx, idx) {
            if (isEx) existingImages.splice(idx,1); else pendingImages.splice(idx,1);
            renderImgPreview();
        }

        // === AUDIO ===
        function handleAudioSelected(file) {
            const prev = document.getElementById('audioPreview');
            if (!file) { prev.classList.remove('show'); prev.innerHTML=''; return; }
            readFile(file).then(data => {
                prev.innerHTML = buildAudioPlayer(data, file.name) + `<br><button class="remove-file-btn" onclick="removeAudio()"><i class="fas fa-times"></i> Remover áudio</button>`;
                prev.classList.add('show');
                setTimeout(initAudioPlayers, 80);
            });
        }

        function removeAudio() {
            document.getElementById('audioInput').value = '';
            const p = document.getElementById('audioPreview');
            p.innerHTML = ''; p.classList.remove('show');
        }

        function buildAudioPlayer(src, name) {
            const id = 'ap'+Math.random().toString(36).substr(2,9);
            return `<div class="audio-player" data-id="${id}">
                <button class="audio-play-btn" onclick="toggleAudio('${id}')"><i class="fas fa-play" id="pi_${id}"></i></button>
                <div class="audio-info">
                    <div class="audio-title-text">${name||'Áudio'}</div>
                    <div class="audio-progress-row">
                        <div class="audio-progress-bar-wrap" onclick="seekAudio(event,'${id}')"><div class="audio-progress-fill" id="apf_${id}" style="width:0%"></div></div>
                        <div class="audio-time-display" id="atd_${id}">0:00 / 0:00</div>
                    </div>
                </div>
                <audio id="aud_${id}" src="${src}" style="display:none;" preload="metadata"></audio>
            </div>`;
        }

        function initAudioPlayers() {
            document.querySelectorAll('.audio-player').forEach(pl => {
                const id = pl.dataset.id; if(!id) return;
                const a = document.getElementById('aud_'+id); if(!a||a._init) return;
                a._init = true;
                a.addEventListener('timeupdate', () => {
                    if(!a.duration) return;
                    const pct=(a.currentTime/a.duration)*100;
                    const fill=document.getElementById('apf_'+id),td=document.getElementById('atd_'+id);
                    if(fill)fill.style.width=pct+'%';
                    if(td)td.textContent=fmtTime(a.currentTime)+' / '+fmtTime(a.duration);
                });
                a.addEventListener('ended',()=>{ const pi=document.getElementById('pi_'+id); if(pi)pi.className='fas fa-play'; });
            });
        }

        function toggleAudio(id) {
            const a=document.getElementById('aud_'+id),pi=document.getElementById('pi_'+id);
            if(!a)return;
            if(a.paused){
                document.querySelectorAll('audio').forEach(x=>{if(x!==a&&!x.paused){x.pause();const oid=x.id.replace('aud_','');const oic=document.getElementById('pi_'+oid);if(oic)oic.className='fas fa-play';}});
                a.play(); if(pi)pi.className='fas fa-pause';
            } else { a.pause(); if(pi)pi.className='fas fa-play'; }
        }

        function seekAudio(e,id) {
            const a=document.getElementById('aud_'+id); if(!a||!a.duration)return;
            const r=e.currentTarget.getBoundingClientRect();
            a.currentTime=((e.clientX-r.left)/r.width)*a.duration;
        }

        // === HASHTAGS ===
        function handleHashtagInput(v) {
            const s=document.getElementById('hashtagSuggestions');
            // Hide if no # or empty
            if(!v || !v.includes('#')) { s.classList.remove('show'); return; }
            const pool=usedHashtags.filter(t=>!selectedHashtags.includes(t));
            const filtered=pool.filter(t=>t.toLowerCase().includes(v.toLowerCase().replace('#','')));
            if(filtered.length>0){
                s.innerHTML=filtered.map(t=>`<div class="hashtag-suggestion" onclick="addHashtagFromSug('${t}')"><i class="fas fa-hashtag"></i>${t.substring(1)}</div>`).join('');
                s.classList.add('show');
            } else s.classList.remove('show');
        }
        function addHashtagFromSug(t){addHashtag(t);document.getElementById('hashtagInput').value='';document.getElementById('hashtagSuggestions').classList.remove('show');}
        function addHashtag(t){
            if(!t.startsWith('#'))t='#'+t;t=t.toLowerCase();
            if(!selectedHashtags.includes(t)){selectedHashtags.push(t);renderTags();if(!usedHashtags.includes(t)){usedHashtags.push(t);localStorage.setItem('usedHashtags',JSON.stringify(usedHashtags));}}
        }
        function removeHashtag(t){selectedHashtags=selectedHashtags.filter(x=>x!==t);renderTags();}
        function renderTags(){
            document.getElementById('selectedHashtags').innerHTML=selectedHashtags.map(t=>`
                <div class="hashtag-chip"><i class="fas fa-hashtag"></i>${t.substring(1)}<button type="button" onclick="removeHashtag('${t}')"><i class="fas fa-times"></i></button></div>`).join('');
        }

        // === MODAL ===
        function openModal(mode, postId=null) {
            pendingImages=[]; existingImages=[];
            hideMoodLabel();
            document.getElementById('imagesPreviewGrid').style.display='none';
            document.getElementById('imagesPreviewGrid').innerHTML='';
            document.getElementById('audioPreview').classList.remove('show');
            document.getElementById('audioPreview').innerHTML='';
            document.getElementById('postPwCheck').checked=false;
            document.getElementById('postPwField').classList.remove('show');
            document.getElementById('postPasswordInput').value='';

            if (mode==='edit'&&postId) {
                const post=posts.find(p=>p.id===postId);
                if (post) {
                    document.getElementById('modalTitle').innerHTML='<span class="modal-icon"><i class="fas fa-edit"></i></span> Editar Publicação';
                    document.getElementById('postTitle').value=post.title;
                    document.getElementById('postDescription').value=post.description;
                    selectedHashtags=[...post.hashtags]; renderTags();
                    editingPostId=postId;
                    updateCC('titleCounter',post.title.length,100);
                    updateCC('descCounter',post.description.length,5000);
                    if(post.mood&&post.moodEmoji) { selectedMood=post.mood;selectedMoodEmoji=post.moodEmoji;selectedMoodText=post.moodText; document.querySelectorAll('.mood-pill').forEach(o=>o.classList.toggle('selected',o.dataset.mood===post.mood)); }

                    // Images
                    const imgs=post.images&&post.images.length>0?post.images:(post.image?[post.image]:[]);
                    existingImages=[...imgs]; renderImgPreview();

                    // Audio
                    if(post.audio){
                        const prev=document.getElementById('audioPreview');
                        prev.innerHTML=buildAudioPlayer(post.audio,post.audioName||'Áudio')+`<br><button class="remove-file-btn" onclick="removeAudio()"><i class="fas fa-times"></i> Remover áudio</button>`;
                        prev.classList.add('show');
                        setTimeout(initAudioPlayers,80);
                    }

                    // Post pw
                    if(post.postPassword){
                        document.getElementById('postPwCheck').checked=true;
                        document.getElementById('postPwField').classList.add('show');
                        document.getElementById('postPasswordInput').value=post.postPassword;
                    }
                }
            } else {
                document.getElementById('modalTitle').innerHTML='<span class="modal-icon"><i class="fas fa-plus"></i></span> Nova Publicação';
                document.getElementById('postForm').reset();
                selectedHashtags=[]; selectedMood=null; selectedMoodEmoji=null; selectedMoodText=null;
                renderTags(); updateCC('titleCounter',0,100); updateCC('descCounter',0,5000);
                document.querySelectorAll('.mood-pill').forEach(m=>m.classList.remove('selected'));
                editingPostId=null;
            }
            document.getElementById('postModal').classList.add('show');
            document.body.style.overflow='hidden';
        }

        function closeModal() {
            // Auto-save draft on leave if pref enabled
            if (prefs.autoSaveDraftOnLeave && !editingPostId) {
                const title = document.getElementById('postTitle').value.trim();
                const desc = document.getElementById('postDescription').value.trim();
                if (title || desc) {
                    saveDraft();
                    return;
                }
            }
            _doCloseModal();
        }

        function _doCloseModal() {
            document.getElementById('postModal').classList.remove('show');
            document.body.style.overflow='auto';
            document.getElementById('hashtagSuggestions').classList.remove('show');
        }

        // === MOOD ===
        function selectMood(mood,emoji,text) {
            if(selectedMood===mood){
                selectedMood=null;selectedMoodEmoji=null;selectedMoodText=null;
                document.querySelectorAll('.mood-pill').forEach(o=>o.classList.remove('selected'));
            } else {
                selectedMood=mood;selectedMoodEmoji=emoji;selectedMoodText=text;
                document.querySelectorAll('.mood-pill').forEach(o=>o.classList.toggle('selected',o.dataset.mood===mood));
            }
        }

        function showMoodLabel() {}
        function hideMoodLabel() {}

        // === VIEW MODE ===
        function setViewMode(mode) {
            viewMode=mode; localStorage.setItem('viewMode',mode);
            document.getElementById('postsContainer').classList.toggle('grid-view',mode==='grid');
            document.getElementById('listModeBtn').classList.toggle('active',mode==='list');
            document.getElementById('gridModeBtn').classList.toggle('active',mode==='grid');
        }

        // === SAVE POST ===
        async function savePost(isDraft=false) {
            const title=document.getElementById('postTitle').value.trim();
            const desc=document.getElementById('postDescription').value.trim();
            if(!title){showNotification('O título é obrigatório!','error');return;}
            if(!desc){showNotification('A descrição é obrigatória!','error');return;}

            const audioFile=document.getElementById('audioInput').files[0];
            const pwEnabled=document.getElementById('postPwCheck').checked;
            const postPw=pwEnabled?document.getElementById('postPasswordInput').value||null:null;
            const existing=editingPostId?posts.find(p=>p.id===editingPostId):null;

            const post={
                id:editingPostId||Date.now(),title,description:desc,
                hashtags:[...selectedHashtags],
                timestamp:existing?existing.timestamp:Date.now(),
                editedAt:editingPostId?Date.now():null,
                isDraft,isPinned:existing?existing.isPinned:false,
                isFavorite:existing?existing.isFavorite:false,
                mood:selectedMood,moodEmoji:selectedMoodEmoji,moodText:selectedMoodText,
                postPassword:postPw
            };

            // Compile images
            const finalImages=[...existingImages,...pendingImages.map(i=>i.data)];
            post.images=finalImages;
            post.image=finalImages[0]||null;

            // Audio
            const audioPrevShowing=document.getElementById('audioPreview').classList.contains('show');
            if(audioFile){
                try{post.audio=await readFile(audioFile);post.audioName=audioFile.name;}catch(e){console.error(e);}
            } else if(editingPostId&&existing&&audioPrevShowing){
                post.audio=existing.audio; post.audioName=existing.audioName;
            } else { post.audio=null; post.audioName=null; }

            finalizeSave(post, isDraft);
        }

        function finalizeSave(post, isDraft) {
            if(editingPostId){const idx=posts.findIndex(p=>p.id===editingPostId);posts[idx]=post;unlockedPosts.delete(editingPostId);}
            else { if(!isDraft)post.originalTimestamp=post.timestamp; posts.unshift(post); }
            localStorage.setItem('diaryPosts',JSON.stringify(posts));
            _doCloseModal(); renderPosts(); renderFilterTags();
            showNotification(isDraft?'Rascunho salvo!':(editingPostId?'Publicação atualizada!':'Publicação salva!'));
            // badge de galeria se tem imagem nova
            if(!isDraft && !editingPostId && (post.images?.length > 0 || post.image)) addMenuBadge('gallery');
        }

        function saveDraft(){savePost(true);}

        // === DELETE/PIN/FAV ===
        async function deletePost(id) {
            if (prefs.trashEnabled) {
                // Move to trash
                const idx = posts.findIndex(p => p.id === id);
                if (idx === -1) return;
                const post = posts[idx];
                post.trashedAt = Date.now();
                trash.unshift(post);
                posts.splice(idx, 1);
                unlockedPosts.delete(id);
                localStorage.setItem('diaryPosts', JSON.stringify(posts));
                localStorage.setItem('diaryTrash', JSON.stringify(trash));
                renderPosts(); renderFilterTags();
                showNotification('Movida para a lixeira', 'info');
                addMenuBadge('trash');
                updateTrashDropdownBadge();
            } else {
                const ok = await showPopup({type:'warning',title:'Excluir Publicação',message:'Tem certeza? Esta ação não pode ser desfeita.',confirm:true,confirmText:'Excluir',cancelText:'Cancelar'});
                if (ok) {
                    posts = posts.filter(p => p.id !== id);
                    unlockedPosts.delete(id);
                    localStorage.setItem('diaryPosts', JSON.stringify(posts));
                    renderPosts(); renderFilterTags();
                    showNotification('Publicação excluída!');
                }
            }
        }

        function purgeOldTrash() {
            const SEVEN_DAYS = 7 * 24 * 60 * 60 * 1000;
            const before = trash.length;
            trash = trash.filter(p => Date.now() - p.trashedAt < SEVEN_DAYS);
            if (trash.length !== before) localStorage.setItem('diaryTrash', JSON.stringify(trash));
        }

        function showTrash() {
            clearMenuBadge('trash');
            updateTrashDropdownBadge();
            document.getElementById('trashModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            renderTrashList();
        }
        function closeTrash() {
            document.getElementById('trashModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function renderTrashList() {
            const list = document.getElementById('trashList');
            const badge = document.getElementById('trashCountBadge');
            if (!trash.length) {
                badge.textContent = '0 itens';
                list.innerHTML = `<div class="trash-empty-state"><i class="fas fa-check-circle"></i><h3>Lixeira vazia</h3><p>Publicações excluídas aparecerão aqui por 7 dias</p></div>`;
                return;
            }
            badge.textContent = `${trash.length} ${trash.length === 1 ? 'item' : 'itens'}`;
            const SEVEN_DAYS = 7 * 24 * 60 * 60 * 1000;
            list.innerHTML = trash.map(post => {
                const daysLeft = Math.max(0, Math.ceil((SEVEN_DAYS - (Date.now() - post.trashedAt)) / (24*60*60*1000)));
                const mood = post.moodEmoji ? `<span>${post.moodEmoji}</span>` : '';
                const date = new Date(post.trashedAt).toLocaleDateString('pt-BR', {day:'2-digit',month:'2-digit',year:'numeric'});
                return `<div class="trash-item" id="trashItem_${post.id}">
                    <div class="trash-item-info">
                        <div class="trash-item-title">${mood} ${post.title}</div>
                        <div class="trash-item-meta">
                            <span><i class="fas fa-calendar" style="opacity:0.5;"></i> Excluído em ${date}</span>
                            <span class="trash-item-countdown"><i class="fas fa-hourglass-half"></i> Expira em ${daysLeft} dia${daysLeft!==1?'s':''}</span>
                        </div>
                    </div>
                    <div class="trash-item-actions">
                        <button class="trash-action-btn trash-restore-btn" onclick="restoreFromTrash(${post.id})" title="Restaurar"><i class="fas fa-undo"></i> Restaurar</button>
                        <button class="trash-action-btn trash-perm-btn" onclick="deleteFromTrashPermanently(${post.id})" title="Apagar definitivamente"><i class="fas fa-times"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        function restoreFromTrash(id) {
            const idx = trash.findIndex(p => p.id === id);
            if (idx === -1) return;
            const post = trash[idx];
            delete post.trashedAt;
            posts.unshift(post);
            trash.splice(idx, 1);
            localStorage.setItem('diaryPosts', JSON.stringify(posts));
            localStorage.setItem('diaryTrash', JSON.stringify(trash));
            renderPosts(); renderFilterTags();
            renderTrashList();
            showNotification('Publicação restaurada!', 'success');
        }

        async function deleteFromTrashPermanently(id) {
            const ok = await showPopup({type:'warning',title:'Apagar para sempre',message:'Esta publicação será removida permanentemente. Sem volta.',confirm:true,confirmText:'Apagar',cancelText:'Cancelar'});
            if (!ok) return;
            trash = trash.filter(p => p.id !== id);
            localStorage.setItem('diaryTrash', JSON.stringify(trash));
            renderTrashList();
            showNotification('Apagada definitivamente!');
        }

        async function emptyTrashAll() {
            if (!trash.length) return;
            const ok = await showPopup({type:'warning',title:'Esvaziar Lixeira',message:`Apagar permanentemente ${trash.length} publicaç${trash.length>1?'ões':'ão'}? Esta ação não pode ser desfeita.`,confirm:true,confirmText:'Esvaziar',cancelText:'Cancelar'});
            if (!ok) return;
            trash = [];
            localStorage.setItem('diaryTrash', JSON.stringify(trash));
            renderTrashList();
            showNotification('Lixeira esvaziada!');
        }

        function updateTrashDropdownBadge() {
            const item = document.getElementById('trashDropdownItem');
            if (!item) return;
            const existing = item.querySelector('.dd-trash-badge');
            if (existing) existing.remove();
            if (trash.length > 0) {
                const b = document.createElement('span');
                b.className = 'dd-trash-badge';
                b.style.cssText = 'margin-left:auto;background:rgba(239,83,80,0.15);color:#ef5350;border:1px solid rgba(239,83,80,0.25);padding:2px 7px;border-radius:10px;font-size:0.72em;font-weight:600;';
                b.textContent = trash.length;
                item.appendChild(b);
            }
        }

        // === MENU BADGES ===
        function addMenuBadge(key, count=1) {
            menuBadges[key] = (menuBadges[key] || 0) + count;
            localStorage.setItem('menuBadges', JSON.stringify(menuBadges));
            renderAllMenuBadges();
        }

        function clearMenuBadge(key) {
            menuBadges[key] = 0;
            localStorage.setItem('menuBadges', JSON.stringify(menuBadges));
            renderAllMenuBadges();
        }

        function renderAllMenuBadges() {
            const map = { drafts:'mmi-drafts', favorites:'mmi-favorites', gallery:'mmi-gallery', trash:'mmi-trash' };
            Object.entries(map).forEach(([key, elemId]) => {
                const el = document.getElementById(elemId);
                if (!el) return;
                const existing = el.querySelector('.menu-badge');
                if (existing) existing.remove();
                const count = menuBadges[key] || 0;
                if (count > 0) {
                    const b = document.createElement('span');
                    b.className = 'menu-badge' + (key==='trash' ? ' badge-trash' : '');
                    b.textContent = count > 9 ? '9+' : '+' + count;
                    el.appendChild(b);
                }
            });
        }
        function togglePin(id){const p=posts.find(p=>p.id===id);p.isPinned=!p.isPinned;localStorage.setItem('diaryPosts',JSON.stringify(posts));renderPosts();showNotification(p.isPinned?'Fixada!':'Desafixada!');}
        function toggleFavorite(id){const p=posts.find(p=>p.id===id);p.isFavorite=!p.isFavorite;localStorage.setItem('diaryPosts',JSON.stringify(posts));renderPosts();showNotification(p.isFavorite?'Favoritado!':'Desfavoritado!');if(p.isFavorite)addMenuBadge('favorites');}
        function publishDraft(id){const p=posts.find(x=>x.id===id);p.isDraft=false;if(!p.originalTimestamp)p.originalTimestamp=p.timestamp;p.timestamp=p.originalTimestamp;localStorage.setItem('diaryPosts',JSON.stringify(posts));renderPosts();showNotification('Publicado!');}
        function duplicatePost(id){const o=posts.find(p=>p.id===id);const np={...o,id:Date.now(),timestamp:Date.now(),title:o.title+' (cópia)',editedAt:null,isPinned:false,postPassword:null};posts.unshift(np);localStorage.setItem('diaryPosts',JSON.stringify(posts));renderPosts();showNotification('Duplicado!');}
        function copyPostDesc(id){
            const p=posts.find(x=>x.id===id);
            if(!p)return;
            navigator.clipboard.writeText(p.description).then(()=>showNotification('Descrição copiada!','success')).catch(()=>{
                const ta=document.createElement('textarea');ta.value=p.description;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();showNotification('Copiado!','success');
            });
        }
        function moveToDraft(id){const p=posts.find(x=>x.id===id);if(!p)return;p.isDraft=true;localStorage.setItem('diaryPosts',JSON.stringify(posts));renderPosts();renderFilterTags();showNotification('Movido para rascunhos!','info');addMenuBadge('drafts');}

        // === LIGHTBOX ===
        let lbImages=[], lbIdx=0;
        function openLightbox(postId, startIdx) {
            const post = posts.find(p=>p.id==postId);
            if(!post)return;
            lbImages = post.images&&post.images.length>0 ? post.images : (post.image?[post.image]:[]);
            if(!lbImages.length)return;
            lbIdx = startIdx||0;
            applyLightbox();
            document.getElementById('lightbox').classList.add('show');
            document.body.style.overflow='hidden';
        }
        function applyLightbox(){
            document.getElementById('lightboxImg').src = lbImages[lbIdx];
            const multi = lbImages.length>1;
            document.getElementById('lightboxPrev').style.display = multi?'flex':'none';
            document.getElementById('lightboxNext').style.display = multi?'flex':'none';
            document.getElementById('lightboxCounter').style.display = multi?'block':'none';
            if(multi) document.getElementById('lightboxCounter').textContent = (lbIdx+1)+' / '+lbImages.length;
        }
        function lightboxNav(dir){
            lbIdx = (lbIdx+dir+lbImages.length)%lbImages.length;
            applyLightbox();
        }
        function closeLightbox(){
            document.getElementById('lightbox').classList.remove('show');
            document.body.style.overflow='auto';
        }

        // === FILTER TAGS EXPAND ===
        let filterExpanded = false;
        function toggleFilterExpand(){
            filterExpanded=!filterExpanded;
            const ft=document.getElementById('filterTags');
            const ico=document.getElementById('filterToggleIcon');
            const txt=document.getElementById('filterToggleText');
            ft.classList.toggle('expanded',filterExpanded);
            ico.className=filterExpanded?'fas fa-chevron-up':'fas fa-chevron-down';
            txt.textContent=filterExpanded?'Recolher tags':'Ver todas as tags';
        }

        // === VIEWS ===
        function setSortOrder(order) {
            sortOrder=order; localStorage.setItem('sortOrder',order);
            monthFilter=null;
            ['newest','oldest','alpha'].forEach(o=>{ const b=document.getElementById('sort'+o.charAt(0).toUpperCase()+o.slice(1)); if(b){b.classList.toggle('active',o===order);} });
            const mb=document.getElementById('sortMonth'); if(mb)mb.classList.remove('active');
            renderPosts();
            hideActiveFilterBanner();
        }

        function toggleMonthPicker(e) {
            e.stopPropagation();
            const picker = document.getElementById('monthPicker');
            if(picker.style.display==='none' || !picker.style.display) {
                monthPickerYear = monthFilter ? monthFilter.year : new Date().getFullYear();
                renderMonthPicker();
                picker.style.display='block';
                setTimeout(()=>{ document.addEventListener('click', closeMonthPickerOutside); },10);
            } else {
                picker.style.display='none';
                document.removeEventListener('click', closeMonthPickerOutside);
            }
        }

        function closeMonthPickerOutside(e) {
            const picker=document.getElementById('monthPicker');
            const btn=document.getElementById('sortMonth');
            if(picker&&!picker.contains(e.target)&&e.target!==btn){
                picker.style.display='none';
                document.removeEventListener('click', closeMonthPickerOutside);
            }
        }

        function renderMonthPicker() {
            const picker = document.getElementById('monthPicker');
            const monthNames = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            const fullNames = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            // Count posts by year+month
            const postCounts = {};
            posts.filter(p=>!p.isDraft).forEach(p=>{
                const d=new Date(p.timestamp);
                const key=d.getFullYear()+'-'+d.getMonth();
                postCounts[key]=(postCounts[key]||0)+1;
            });
            picker.innerHTML=`
                <div class="month-picker-header">
                    <span>Selecionar mês</span>
                    <div class="month-picker-year">
                        <button class="month-picker-year-btn" onclick="changePickerYear(-1);event.stopPropagation()"><i class="fas fa-chevron-left"></i></button>
                        <span class="month-picker-year-label">${monthPickerYear}</span>
                        <button class="month-picker-year-btn" onclick="changePickerYear(1);event.stopPropagation()"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="month-picker-grid">
                    ${monthNames.map((name,i)=>{
                        const key=monthPickerYear+'-'+i;
                        const count=postCounts[key]||0;
                        const isActive=monthFilter&&monthFilter.year===monthPickerYear&&monthFilter.month===i;
                        return `<div class="month-cell${isActive?' active':''}${count>0?' has-posts':''}" onclick="selectMonth(${monthPickerYear},${i},'${fullNames[i]}');event.stopPropagation()" title="${count} publicaç${count===1?'ão':'ões'}">${name}${count>0?`<br><span style="font-size:0.75em;opacity:0.6;">${count}</span>`:''}</div>`;
                    }).join('')}
                </div>
                ${monthFilter?`<div class="month-picker-clear" onclick="clearMonthFilter();event.stopPropagation()"><i class="fas fa-times" style="margin-right:5px;"></i>Limpar filtro de mês</div>`:''}`;
        }

        function changePickerYear(dir) {
            monthPickerYear+=dir;
            renderMonthPicker();
        }

        function selectMonth(year, month, fullName) {
            monthFilter={year,month};
            document.getElementById('monthPicker').style.display='none';
            document.removeEventListener('click', closeMonthPickerOutside);
            // Deactivate other sort buttons
            ['newest','oldest','alpha'].forEach(o=>{ const b=document.getElementById('sort'+o.charAt(0).toUpperCase()+o.slice(1)); if(b) b.classList.remove('active'); });
            const mb=document.getElementById('sortMonth'); if(mb)mb.classList.add('active');
            renderPosts();
            // Show month banner
            showActiveFilterBanner(fullName+' de '+year, 'calendar-alt');
        }

        function clearMonthFilter() {
            monthFilter=null;
            document.getElementById('monthPicker').style.display='none';
            document.removeEventListener('click', closeMonthPickerOutside);
            const mb=document.getElementById('sortMonth'); if(mb)mb.classList.remove('active');
            // restore last sort
            setSortOrder(sortOrder);
        }
        function showAllPosts(){currentView='all';currentFilter=null;monthFilter=null;const mb=document.getElementById('sortMonth');if(mb)mb.classList.remove('active');['newest','oldest','alpha'].forEach(o=>{const b=document.getElementById('sort'+o.charAt(0).toUpperCase()+o.slice(1));if(b)b.classList.toggle('active',o===sortOrder);});updateSecTitle('Todas as Publicações','th-list');renderPosts();renderFilterTags();hideActiveFilterBanner();closeMobileMenu();}
        function showDrafts(){currentView='drafts';currentFilter=null;updateSecTitle('Rascunhos','file-alt');renderPosts();clearMenuBadge('drafts');closeMobileMenu();}
        function showFavorites(){currentView='favorites';currentFilter=null;updateSecTitle('Favoritos','star');renderPosts();clearMenuBadge('favorites');closeMobileMenu();}
        function showAll(){showAllPosts();}
        function updateSecTitle(t,ic){document.getElementById('sectionIcon').className='fas fa-'+ic;document.getElementById('sectionTitleText').textContent=t;}
        function filterByHashtag(h){
            currentView='all';currentFilter=h;
            updateSecTitle('Posts com '+h,'hashtag');
            renderPosts();
            renderFilterTags();
            showActiveFilterBanner(h, 'hashtag');
        }

        function showActiveFilterBanner(tag, icon='filter') {
            let banner = document.getElementById('activeFilterBanner');
            if(!banner) {
                banner = document.createElement('div');
                banner.id = 'activeFilterBanner';
                banner.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:rgba(42,42,42,0.5);border:1px solid #2a2a2a;border-radius:12px;margin-bottom:14px;font-size:0.88em;color:#ccc;gap:12px;animation:slideDown 0.2s ease;';
                const sortBar = document.getElementById('sortBar');
                sortBar.parentNode.insertBefore(banner, sortBar.nextSibling);
            }
            banner.style.display = 'flex';
            banner.innerHTML = `<span><i class="fas fa-${icon}" style="color:#666;margin-right:8px;"></i>Filtrando por <strong style="color:#fff;">${tag}</strong></span><button onclick="showAllPosts()" style="background:rgba(60,60,60,0.7);border:1px solid #3a3a3a;color:#ccc;padding:6px 14px;border-radius:8px;cursor:pointer;font-family:Poppins,sans-serif;font-size:0.88em;display:flex;align-items:center;gap:6px;white-space:nowrap;"><i class="fas fa-times"></i> Limpar</button>`;
        }

        function hideActiveFilterBanner() {
            const b = document.getElementById('activeFilterBanner');
            if(b) b.style.display='none';
        }
        function filterPosts(s){const ns=norm(s);let f=getFiltered();if(ns)f=f.filter(p=>norm(p.title).includes(ns)||norm(p.description).includes(ns));renderList(f);}
        function getFiltered(){
            let f=[...posts];
            if(currentView==='drafts')f=f.filter(p=>p.isDraft);
            else if(currentView==='favorites')f=f.filter(p=>p.isFavorite&&!p.isDraft);
            else f=f.filter(p=>!p.isDraft);
            if(currentFilter)f=f.filter(p=>p.hashtags.includes(currentFilter));
            if(monthFilter){f=f.filter(p=>{const d=new Date(p.timestamp);return d.getFullYear()===monthFilter.year&&d.getMonth()===monthFilter.month;});}
            f.sort((a,b)=>{
                if(a.isPinned&&!b.isPinned)return -1;
                if(!a.isPinned&&b.isPinned)return 1;
                if(sortOrder==='oldest')return a.timestamp-b.timestamp;
                if(sortOrder==='alpha')return a.title.localeCompare(b.title,'pt');
                return b.timestamp-a.timestamp;
            });
            return f;
        }
        function renderPosts(){renderList(getFiltered());}

        // === CAROUSEL ===
        function carMove(cid,dir){
            const tr=document.getElementById('ctr_'+cid); if(!tr)return;
            const tot=tr.children.length;
            if(!carouselIdx[cid])carouselIdx[cid]=0;
            carouselIdx[cid]=Math.max(0,Math.min(tot-1,carouselIdx[cid]+dir));
            applyCarousel(cid,tot);
        }
        function carGoto(cid,idx){const tr=document.getElementById('ctr_'+cid);if(!tr)return;carouselIdx[cid]=idx;applyCarousel(cid,tr.children.length);}
        function applyCarousel(cid,tot){
            const tr=document.getElementById('ctr_'+cid),dots=document.getElementById('cdots_'+cid),cnt=document.getElementById('ccnt_'+cid);
            const idx=carouselIdx[cid]||0;
            if(tr)tr.style.transform=`translateX(-${idx*100}%)`;
            if(dots)dots.querySelectorAll('.carousel-dot').forEach((d,i)=>d.classList.toggle('active',i===idx));
            if(cnt)cnt.textContent=(idx+1)+' / '+tot;
        }
        function initCarouselTouch(){
            document.querySelectorAll('.carousel-wrapper').forEach(w=>{
                if(w._ti)return; w._ti=true;
                let sx=0;
                w.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;},{passive:true});
                w.addEventListener('touchend',e=>{
                    const diff=sx-e.changedTouches[0].clientX;
                    const tr=w.querySelector('.carousel-track');
                    if(!tr||Math.abs(diff)<40)return;
                    carMove(tr.id.replace('ctr_',''),diff>0?1:-1);
                },{passive:true});
            });
        }

        // === RENDER LIST ===
        function renderList(filtered) {
            const container=document.getElementById('postsContainer');
            if(!filtered.length){
                let msg='Nenhuma publicação encontrada',ico='fas fa-pen-fancy';
                if(currentView==='drafts'){msg='Nenhum rascunho';ico='fas fa-file-alt';}
                else if(currentView==='favorites'){msg='Nenhum favorito';ico='fas fa-star';}
                else if(currentFilter){msg='Nenhuma publicação com '+currentFilter;ico='fas fa-hashtag';}
                container.innerHTML=`<div class="empty-state"><i class="${ico}"></i><h3>${msg}</h3>${currentView!=='all'||currentFilter?'<button class="btn" onclick="showAllPosts()" style="margin-top:20px;"><i class="fas fa-th-list"></i> Ver todas</button>':''}</div>`;
                return;
            }

            container.innerHTML=filtered.map(post=>{
                const badges=[];
                if(post.isPinned)badges.push('<span class="badge badge-pinned"><i class="fas fa-thumbtack"></i> Fixado</span>');
                if(post.isDraft)badges.push('<span class="badge badge-draft"><i class="fas fa-file-alt"></i> Rascunho</span>');
                if(post.isFavorite)badges.push('<span class="badge badge-favorite"><i class="fas fa-star"></i> Favorito</span>');
                if(post.editedAt&&prefs.showEditedBadge)badges.push('<span class="badge badge-edited"><i class="fas fa-pencil-alt"></i> Editado</span>');
                if(post.postPassword)badges.push('<span class="badge badge-locked"><i class="fas fa-lock"></i> Protegido</span>');

                const timeInfo=prefs.showDateFull?[`<span title="${fmtDate(post.timestamp)}"><i class="far fa-clock"></i> ${fmtAgo(post.timestamp)}</span>`,`<span class="separator">•</span><span style="color:#777">${fmtDate(post.timestamp)}</span>`]:[`<span title="${fmtDate(post.timestamp)}"><i class="far fa-clock"></i> ${fmtAgo(post.timestamp)}</span>`];
                if(post.editedAt)timeInfo.push(`<span class="separator">•</span><span class="edited-info" title="${fmtDate(post.editedAt)}"><i class="fas fa-pencil-alt" style="font-size:0.85em;"></i> editado em ${fmtDate(post.editedAt)}</span>`);

                const locked=post.postPassword&&!unlockedPosts.has(post.id);
                const imgs=post.images&&post.images.length>0?post.images:(post.image?[post.image]:[]);
                const cid='c'+post.id;

                let media='';
                if(!locked&&imgs.length>1){
                    media=`<div class="carousel-wrapper">
                        <div class="carousel-track" id="ctr_${cid}">${imgs.map((img,ii)=>`<div class="carousel-slide"><img src="${img}" alt="${post.title}" style="cursor:zoom-in;" onclick="openLightbox('${post.id}',${ii})"></div>`).join('')}</div>
                        <button class="carousel-btn carousel-prev" onclick="carMove('${cid}',-1)"><i class="fas fa-chevron-left"></i></button>
                        <button class="carousel-btn carousel-next" onclick="carMove('${cid}',1)"><i class="fas fa-chevron-right"></i></button>
                        <div class="carousel-counter" id="ccnt_${cid}">1 / ${imgs.length}</div>
                    </div><div class="carousel-dots" id="cdots_${cid}">${imgs.map((_,i)=>`<button class="carousel-dot${i===0?' active':''}" onclick="carGoto('${cid}',${i})"></button>`).join('')}</div>`;
                } else if(!locked&&imgs.length===1){
                    media=`<div class="post-media"><img src="${imgs[0]}" alt="${post.title}" style="cursor:zoom-in;" onclick="openLightbox('${post.id}',0)"></div>`;
                }

                const audioHtml = post.audio ? buildAudioPlayer(post.audio, post.audioName||'Áudio') : '';
                const desc = renderDescWithLinks(post.description);

                if(locked) {
                    return `<div class="post${post.isPinned?' pinned':''}${post.isFavorite?' favorite-post':''}">
                        <div class="post-inner">
                            <div class="post-header">
                                <div class="post-title-section">
                                    ${badges.length?`<div class="post-badges">${badges.join('')}</div>`:''}
                                    <h2 class="post-title"><i class="fas fa-lock" style="font-size:0.7em;color:#555;margin-right:6px;"></i>${post.title}</h2>
                                    <div class="post-time">${timeInfo.join(' ')}</div>
                                </div>
                                <div class="post-actions">
                                    <button class="post-action-btn" onclick="deletePost(${post.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="post-lock-overlay" onclick="unlockPost(${post.id})" style="margin:0 24px 20px;display:flex;flex-direction:column;align-items:center;padding:22px 0;gap:8px;cursor:pointer;border-radius:12px;background:rgba(10,10,10,0.4);border:1px dashed rgba(255,255,255,0.08);transition:background 0.2s;">
                            <i class="fas fa-lock" style="font-size:1.8em;color:#444;"></i>
                            <div style="color:#666;font-size:0.85em;font-weight:500;">Conteúdo protegido</div>
                            <div style="color:#444;font-size:0.75em;">Clique para digitar a senha</div>
                        </div>
                    </div>`;
                }

                return `<div class="post${post.isPinned?' pinned':''}${post.isDraft?' draft':''}${post.isFavorite?' favorite-post':''}">
                    <div class="post-inner">
                        <div class="post-header">
                            <div class="post-title-section">
                                ${badges.length?`<div class="post-badges">${badges.join('')}</div>`:''}
                                ${prefs.showMood&&post.moodEmoji&&post.moodText?`<div class="post-mood-display"><span class="mood-emoji">${post.moodEmoji}</span><span style="color:#555;font-size:0.9em;">${post.moodText}</span></div>`:''}
                                <h2 class="post-title">${post.title}</h2>
                                <div class="post-time">${timeInfo.join(' ')}</div>
                            </div>
                            <div class="post-actions">
                                ${post.isDraft?`<button class="post-action-btn" onclick="publishDraft(${post.id})" title="Publicar"><i class="fas fa-paper-plane"></i></button>`:`<button class="post-action-btn" onclick="moveToDraft(${post.id})" title="Mover para rascunho"><i class="fas fa-archive"></i></button>`}
                                <button class="post-action-btn${post.isFavorite?' active':''}" onclick="toggleFavorite(${post.id})" title="Favorito"><i class="fas fa-star"></i></button>
                                <button class="post-action-btn${post.isPinned?' active':''}" onclick="togglePin(${post.id})" title="Fixar"><i class="fas fa-thumbtack"></i></button>
                                <button class="post-action-btn" onclick="duplicatePost(${post.id})" title="Duplicar"><i class="fas fa-copy"></i></button>
                                <button class="post-action-btn" onclick="openModal('edit',${post.id})" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="post-action-btn" onclick="deletePost(${post.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    ${media}
                    <div class="post-body">
                        <div class="post-description">${desc}</div>
                        ${prefs.showWordCount?`<div class="post-wordcount"><i class="fas fa-font"></i> ${post.description.trim().split(/\s+/).filter(w=>w).length} palavras &middot; <i class="fas fa-clock"></i> ~${Math.ceil(post.description.trim().split(/\s+/).filter(w=>w).length/200)} min de leitura</div>`:''}
                        ${audioHtml}
                    </div>
                    <div class="post-footer-bar">
                        <div class="post-hashtags-row">${post.hashtags.map(t=>`<span class="post-hashtag" onclick="filterByHashtag('${t}')"><i class="fas fa-hashtag" style="font-size:0.75em;opacity:0.5;"></i>${t.substring(1)}</span>`).join('')}</div>
                        <button class="post-copy-btn" onclick="copyPostDesc(${post.id})" title="Copiar texto"><i class="fas fa-copy"></i> Copiar</button>
                    </div>
                </div>`;
            }).join('');

            setTimeout(()=>{ initAudioPlayers(); initCarouselTouch(); }, 80);
        }

        // === FILTER TAGS ===
        function renderFilterTags() {
            const c=document.getElementById('filterTags');
            const wrap=document.getElementById('filterTagsWrap');
            if (!prefs.showHashtagFilter) { wrap.style.display='none'; return; }
            const all=[...new Set(posts.flatMap(p=>p.hashtags))];
            const hasFilter=currentView!=='all'||currentFilter;
            if(!all.length&&!hasFilter){wrap.style.display='none';return;}
            wrap.style.display='block';
            let html='';
            if(hasFilter)html+=`<div class="filter-tag active" onclick="showAll()"><i class="fas fa-list"></i> Todas</div>`;
            const hashCount = {}; posts.forEach(p=>p.hashtags.forEach(t=>{hashCount[t]=(hashCount[t]||0)+1;}));
            html+=all.map(t=>`<div class="filter-tag${currentFilter===t?' active':''}" onclick="filterByHashtag('${t}')"><i class="fas fa-hashtag"></i>${t.substring(1)}${prefs.showHashtagsCount?`<span style='opacity:0.4;font-size:0.8em;margin-left:4px;'>${hashCount[t]}</span>`:''}</div>`).join('');
            c.innerHTML=html;
            // Show/hide toggle button based on whether tags overflow
            const toggle=document.getElementById('filterTagsToggle');
            setTimeout(()=>{ toggle.style.display = c.scrollWidth > c.clientWidth || filterExpanded ? 'inline-flex' : 'none'; },50);
        }

        // === STATS ===
        function showStats(){
            closeDropdown();closeMobileMenu();
            const pub=posts.filter(p=>!p.isDraft),dr=posts.filter(p=>p.isDraft),fav=posts.filter(p=>p.isFavorite);
            const words=pub.reduce((s,p)=>s+(p.description?p.description.split(/\s+/).filter(w=>w).length:0),0);
            const imgs=posts.filter(p=>p.images?p.images.length>0:p.image).length;
            const auds=posts.filter(p=>p.audio).length;
            const prot=posts.filter(p=>p.postPassword).length;
            const udays=new Set(pub.map(p=>new Date(p.timestamp).toDateString())).size;
            const mh=getMostHashtag();
            const fp=posts.length?new Date(Math.min(...posts.map(p=>p.timestamp))):null;
            const ds=fp?Math.floor((Date.now()-fp.getTime())/86400000):0;
            const sb=(v,l,col='#fff')=>`<div style="text-align:center;padding:18px;background:rgba(42,42,42,0.5);border-radius:12px;"><div style="font-size:2.2em;font-weight:700;color:${col};">${v}</div><div style="color:#888;margin-top:4px;font-size:0.85em;">${l}</div></div>`;
            document.body.insertAdjacentHTML('beforeend',`
                <div class="modal show" onclick="if(event.target===this)this.remove()">
                    <div class="modal-content" style="max-width:700px;" onclick="event.stopPropagation()">
                        <div class="modal-header"><h2><i class="fas fa-chart-bar"></i> Estatísticas</h2><button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button></div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;">
                            ${sb(pub.length,'Publicações')}${sb(words.toLocaleString(),'Palavras')}${sb(udays,'Dias ativos')}${sb(dr.length,'Rascunhos')}${sb(fav.length,'Favoritos','#ffaa00')}${sb(imgs,'Com imagens')}${sb(auds,'Com áudios')}${sb(prot,'Protegidas','#ce93d8')}
                        </div>
                        <div style="margin-top:18px;padding:18px;background:rgba(42,42,42,0.5);border-radius:12px;"><div style="color:#aaa;margin-bottom:8px;font-size:0.85em;"><i class="fas fa-hashtag"></i> Tag mais usada</div><div style="font-size:1.2em;">${mh||'Nenhuma'}</div></div>
                        ${ds>0?`<div style="margin-top:12px;padding:18px;background:rgba(42,42,42,0.5);border-radius:12px;"><div style="color:#aaa;margin-bottom:8px;font-size:0.85em;"><i class="fas fa-calendar"></i> Dias desde a primeira publicação</div><div style="font-size:1.2em;">${ds} dias</div></div>`:''}
                    </div>
                </div>`);
        }

        function getMostHashtag(){
            const c={};posts.forEach(p=>p.hashtags.forEach(t=>{c[t]=(c[t]||0)+1;}));
            return Object.entries(c).sort((a,b)=>b[1]-a[1])[0]?.[0]||null;
        }

        // === EXPORT/IMPORT ===
        function exportData(){
            closeDropdown();closeMobileMenu();
            const blob=new Blob([JSON.stringify({posts,hashtags:usedHashtags,exportDate:new Date().toISOString()},null,2)],{type:'application/json'});
            const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`diario-backup-${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(url);
            showNotification('Exportado!','success');
        }
        function importData(){closeDropdown();closeMobileMenu();document.getElementById('importFileInput').click();}
        async function handleImportFile(e){
            const f=e.target.files[0];if(!f)return;
            const reader=new FileReader();reader.onload=async ev=>{
                try{const data=JSON.parse(ev.target.result);
                const ok=await showPopup({type:'warning',title:'Importar',message:'Isso vai substituir todos os dados atuais. Continuar?',confirm:true,confirmText:'Importar',cancelText:'Cancelar'});
                if(ok){posts=data.posts||[];usedHashtags=data.hashtags||[];localStorage.setItem('diaryPosts',JSON.stringify(posts));localStorage.setItem('usedHashtags',JSON.stringify(usedHashtags));renderPosts();renderFilterTags();showNotification('Importado!','success');}}
                catch{await showPopup({type:'error',title:'Erro',message:'Arquivo inválido.'});}
            };reader.readAsText(f);e.target.value='';
        }

        // === GALLERY ===
        let galleryModalEl = null;
        function showGallery(){
            clearMenuBadge('gallery');
            closeDropdown();closeMobileMenu();
            const ps=posts.filter(p=>!p.isDraft&&(p.images&&p.images.length>0||p.image));
            if(!ps.length){showNotification('Nenhuma imagem no diário','info');return;}
            const colSize = prefs.galleryColumns==='auto'?'170px':`${Math.floor(860/parseInt(prefs.galleryColumns))}px`;
            const el = document.createElement('div');
            el.className='modal show';
            el.id='galleryModal';
            el.onclick=e=>{if(e.target===el)el.remove();};
            el.innerHTML=`
                <div class="modal-content" style="max-width:900px;" onclick="event.stopPropagation()">
                    <div class="modal-header"><h2><i class="fas fa-images"></i> Galeria</h2><button class="close-btn" onclick="document.getElementById('galleryModal').remove()"><i class="fas fa-times"></i></button></div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(${colSize},1fr));gap:12px;">
                        ${ps.map(p=>{const imgs=p.images&&p.images.length>0?p.images:[p.image];return imgs.map((img,ii)=>`
                            <div class="gallery-thumb" onclick="showGalleryPhotoMenu(${p.id},${ii})" style="position:relative;cursor:pointer;border-radius:12px;overflow:hidden;aspect-ratio:1;transition:transform 0.2s,box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.03)';this.style.boxShadow='0 8px 25px rgba(0,0,0,0.6)';" onmouseout="this.style.transform='';this.style.boxShadow='';">
                                <img src="${img}" style="width:100%;height:100%;object-fit:cover;" loading="lazy">
                                <div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.85));padding:10px 8px 8px;font-size:0.78em;line-height:1.3;">
                                    <div style="font-weight:500;">${p.title}</div>
                                    <div style="opacity:0.5;font-size:0.85em;">${imgs.length>1?`${ii+1}/${imgs.length} fotos`:''}</div>
                                </div>
                                <div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.5);border-radius:6px;width:26px;height:26px;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s;" class="gallery-thumb-icon"><i class="fas fa-expand" style="font-size:0.75em;color:#fff;"></i></div>
                            </div>`).join('');}).join('')}
                    </div>
                </div>`;
            // Show hover icon
            el.querySelectorAll('.gallery-thumb').forEach(t=>{
                t.addEventListener('mouseenter',()=>{const ic=t.querySelector('.gallery-thumb-icon');if(ic)ic.style.opacity='1';});
                t.addEventListener('mouseleave',()=>{const ic=t.querySelector('.gallery-thumb-icon');if(ic)ic.style.opacity='0';});
            });
            document.body.appendChild(el);
        }

        function showGalleryPhotoMenu(postId, imgIdx) {
            const post = posts.find(p=>p.id===postId);
            if(!post) return;
            const overlay = document.getElementById('galleryActionOverlay');
            const title = document.getElementById('galleryActionTitle');
            title.textContent = post.title;
            document.getElementById('galleryActionView').onclick = () => {
                closeGalleryAction();
                const gm = document.getElementById('galleryModal');
                if(gm) gm.remove();
                showPostById(postId);
            };
            document.getElementById('galleryActionPhoto').onclick = () => {
                closeGalleryAction();
                openLightboxDirect(postId, imgIdx);
            };
            overlay.classList.add('show');
        }

        function closeGalleryAction() {
            document.getElementById('galleryActionOverlay').classList.remove('show');
        }

        function showPostById(postId) {
            // Close gallery if open
            const gm = document.getElementById('galleryModal');
            if(gm) gm.remove();
            // Scroll to post
            showAllPosts();
            setTimeout(()=>{
                const els = document.querySelectorAll('.post');
                // Find by post id via re-render with highlight
                const post = posts.find(p=>p.id===postId);
                if(!post) return;
                // Temporarily highlight
                renderPosts();
                setTimeout(()=>{
                    const allPosts = document.querySelectorAll('.post');
                    const rendered = Array.from(allPosts);
                    // Find index in filtered list
                    const idx = posts.filter(p=>!p.isDraft).findIndex(p=>p.id===postId);
                    if(rendered[idx]) {
                        rendered[idx].scrollIntoView({behavior:'smooth',block:'center'});
                        rendered[idx].style.outline='2px solid #555';
                        rendered[idx].style.outlineOffset='4px';
                        setTimeout(()=>{rendered[idx].style.outline='';rendered[idx].style.outlineOffset='';},2000);
                    }
                },100);
            },50);
        }

        function openLightboxDirect(postId, imgIdx) {
            openLightbox(postId, imgIdx);
        }

        // === NOTIFICATION ===
        function showNotification(msg,type='success'){
            const n=document.createElement('div');
            const cols={success:'linear-gradient(135deg,#4caf50,#388e3c)',error:'linear-gradient(135deg,#f44336,#d32f2f)',warning:'linear-gradient(135deg,#ff9800,#f57c00)',info:'linear-gradient(135deg,#2196f3,#1976d2)'};
            const icos={success:'fa-check-circle',error:'fa-exclamation-circle',warning:'fa-exclamation-triangle',info:'fa-info-circle'};
            n.style.cssText=`position:fixed;top:20px;right:20px;background:${cols[type]||cols.success};color:#fff;padding:16px 24px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.5);z-index:200000;font-weight:500;display:flex;align-items:center;gap:10px;max-width:340px;font-family:Poppins,sans-serif;font-size:0.93em;animation:sni 0.3s ease;`;
            n.innerHTML=`<i class="fas ${icos[type]||icos.success}"></i> ${msg}`;
            const st=document.createElement('style');st.textContent='@keyframes sni{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes sno{from{transform:translateX(0);opacity:1}to{transform:translateX(400px);opacity:0}}';
            document.head.appendChild(st);document.body.appendChild(n);
            setTimeout(()=>{n.style.animation='sno 0.3s ease';setTimeout(()=>{n.remove();st.remove();},300);},3000);
        }

        // === STREAK DE ESCRITA ===
        function calculateStreak() {
            const pub = posts.filter(p => !p.isDraft);
            if (!pub.length) return { streak: 0, longest: 0, total: 0 };
            const days = [...new Set(pub.map(p => {
                const d = new Date(p.timestamp);
                return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
            }))].sort().reverse();
            const today = new Date();
            const todayKey = `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
            const yest = new Date(today); yest.setDate(yest.getDate() - 1);
            const yesterKey = `${yest.getFullYear()}-${yest.getMonth()}-${yest.getDate()}`;
            let streak = 0;
            if (days[0] === todayKey || days[0] === yesterKey) {
                let checkDate = days[0] === todayKey ? new Date(today) : new Date(yest);
                for (let i = 0; i < days.length; i++) {
                    const key = `${checkDate.getFullYear()}-${checkDate.getMonth()}-${checkDate.getDate()}`;
                    if (days[i] === key) { streak++; checkDate.setDate(checkDate.getDate() - 1); }
                    else break;
                }
            }
            let longest = 1, cur = 1;
            for (let i = 1; i < days.length; i++) {
                const a = new Date(days[i-1].split('-').map((v,j)=>j===1?+v:+v)[0], days[i-1].split('-')[1], days[i-1].split('-')[2]);
                const b = new Date(days[i].split('-').map((v,j)=>j===1?+v:+v)[0], days[i].split('-')[1], days[i].split('-')[2]);
                const diff = Math.round((a - b) / 86400000);
                if (diff === 1) { cur++; longest = Math.max(longest, cur); } else cur = 1;
            }
            return { streak, longest, total: days.length };
        }

        // === STAT CARDS (Streak) ===
        function renderStreakBadge() {
            const wrap = document.getElementById('streakBadgeWrap');
            if (!wrap) return;
            const pub = posts.filter(p => !p.isDraft);
            if (!pub.length) { wrap.innerHTML = ''; return; }

            const { streak, longest, total } = calculateStreak();

            const today = new Date();
            const writtenToday = pub.some(p => {
                const d = new Date(p.timestamp);
                return d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth() && d.getDate()===today.getDate();
            });

            const streakIcon = streak >= 14 ? '<i class="fas fa-fire" style="color:#ff8200;font-size:0.9em;"></i>' : streak >= 7 ? '<i class="fas fa-bolt" style="color:#fbbf24;font-size:0.9em;"></i>' : streak >= 3 ? '<i class="fas fa-pen" style="font-size:0.9em;"></i>' : streak >= 1 ? '<i class="fas fa-pencil-alt" style="font-size:0.9em;"></i>' : '<i class="fas fa-minus" style="font-size:0.9em;color:#444;"></i>';
            const streakClass = streak > 0 ? 'streak-active' : '';
            const todayClass = writtenToday ? 'today-done' : '';

            wrap.innerHTML = `
                <div class="stat-card ${streakClass}" onclick="showStreakDetails()" title="Dias consecutivos de escrita">
                    <div class="stat-card-icon">${streakIcon}</div>
                    <div class="stat-card-value">${streak}</div>
                    <div class="stat-card-label">Dias Seguidos</div>
                </div>
                <div class="stat-card days-total" onclick="showStreakDetails()" title="Total de dias que você escreveu">
                    <div class="stat-card-icon"><i class="fas fa-calendar-check" style="font-size:0.9em;color:#60a5fa;"></i></div>
                    <div class="stat-card-value">${total}</div>
                    <div class="stat-card-label">Dias de Escrita</div>
                </div>
                <div class="stat-card ${todayClass}" onclick="showStreakDetails()" title="${writtenToday?'Você já escreveu hoje!':'Ainda não escreveu hoje'}">
                    <div class="stat-card-icon">${writtenToday?'<i class="fas fa-check-circle" style="color:#4ade80;font-size:0.9em;"></i>':'<i class="fas fa-circle" style="color:#333;font-size:0.9em;"></i>'}</div>
                    <div class="stat-card-value" style="font-size:${writtenToday?'1.3em':'1.6em'}">${writtenToday?'Sim!':'—'}</div>
                    <div class="stat-card-label">Escreveu Hoje</div>
                </div>`;
        }

        function showStreakDetails() {
            const { streak, longest, total } = calculateStreak();
            const sb = (v,l,col='#fff') => `<div style="text-align:center;padding:16px;background:rgba(42,42,42,0.5);border-radius:12px;"><div style="font-size:2em;font-weight:700;color:${col};">${v}</div><div style="color:#666;margin-top:4px;font-size:0.82em;">${l}</div></div>`;
            const el = document.createElement('div');
            el.className = 'modal show';
            el.onclick = e => { if(e.target===el) el.remove(); };
            el.innerHTML = `<div class="modal-content" style="max-width:480px;" onclick="event.stopPropagation()">
                <div class="modal-header"><h2><i class="fas fa-fire" style="color:#ff8200;margin-right:8px;"></i> Streak de Escrita</h2><button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button></div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;">
                    ${sb(streak,'Dias seguidos','#ff8200')}${sb(longest,'Recorde pessoal','#fbbf24')}${sb(total,'Total de dias','#60a5fa')}
                </div>
                <div style="padding:16px;background:rgba(42,42,42,0.3);border-radius:12px;font-size:0.85em;color:#666;line-height:1.7;">
                    ${streak===0?'Você ainda não escreveu hoje. Que tal criar uma publicação agora?':streak===1?'Você começou! Escreva amanhã para manter o streak.':streak<7?`${streak} dias! Continue assim, você está no caminho certo!`:`Incrível! ${streak} dias seguidos de escrita! Você é dedicado!`}
                </div>
            </div>`;
            document.body.appendChild(el);
        }

        // === PROMPT DE REFLEXÃO DIÁRIA ===
        const journalPrompts = [
            { emoji:'🌅', text:'O que você está esperando com ansiedade nos próximos dias?', cat:'Expectativas' },
            { emoji:'💭', text:'Que pensamento ficou na sua cabeça hoje que você não consegue tirar?', cat:'Reflexão' },
            { emoji:'🙏', text:'Liste 3 coisas pelas quais você é grato hoje, por menores que sejam.', cat:'Gratidão' },
            { emoji:'😤', text:'O que te incomodou hoje? Como você poderia lidar melhor com isso?', cat:'Emoções' },
            { emoji:'🌟', text:'Qual foi o melhor momento do seu dia, mesmo que pequeno?', cat:'Positividade' },
            { emoji:'🤔', text:'Se você pudesse mudar uma decisão de hoje, qual seria e por quê?', cat:'Reflexão' },
            { emoji:'💪', text:'Qual foi sua maior conquista desta semana, mesmo que pareça insignificante?', cat:'Conquistas' },
            { emoji:'🎯', text:'Qual é o seu objetivo mais importante agora? O que você fez hoje para se aproximar dele?', cat:'Metas' },
            { emoji:'❤️', text:'Quem você não vê há tempo que você sente saudades? Escreva sobre essa pessoa.', cat:'Relações' },
            { emoji:'🔮', text:'Daqui a 5 anos, o que você espera que esteja diferente na sua vida?', cat:'Futuro' },
            { emoji:'😌', text:'O que te faz sentir em paz? Descreva esse momento ou lugar com detalhes.', cat:'Bem-estar' },
            { emoji:'🌱', text:'Em que aspecto da sua vida você percebeu crescimento nos últimos meses?', cat:'Crescimento' },
            { emoji:'🧩', text:'Qual problema você está enfrentando agora? Escreva sobre possíveis soluções.', cat:'Desafios' },
            { emoji:'💌', text:'Escreva uma carta para seu eu de 10 anos atrás. O que você diria?', cat:'Criatividade' },
            { emoji:'🌊', text:'Como está sendo se deixar fluir com a vida, sem controlar tudo?', cat:'Aceitação' },
            { emoji:'⭐', text:'Quais são seus 3 valores mais importantes? Você está vivendo de acordo com eles?', cat:'Valores' },
            { emoji:'😂', text:'Escreva sobre algo que te fez rir de verdade recentemente.', cat:'Alegria' },
            { emoji:'🛏️', text:'Como foi sua noite de sono? O que está afetando seu descanso?', cat:'Saúde' },
            { emoji:'🎵', text:'Qual música representa exatamente como você está se sentindo agora? Por quê?', cat:'Arte' },
            { emoji:'🌙', text:'O que você deseja realizar antes de dormir hoje?', cat:'Intenções' },
            { emoji:'💔', text:'Tem algo ou alguém com quem você precisa se reconciliar, mesmo que só internamente?', cat:'Cura' },
            { emoji:'🚀', text:'Se o medo não existisse, o que você tentaria fazer agora?', cat:'Coragem' },
            { emoji:'📚', text:'O que você aprendeu de importante nos últimos 30 dias?', cat:'Aprendizado' },
            { emoji:'🏡', text:'Como você está se sentindo em relação ao seu espaço e rotina atual?', cat:'Cotidiano' },
            { emoji:'🤝', text:'Quem na sua vida merece um reconhecimento especial? Escreva sobre isso.', cat:'Relações' },
            { emoji:'✨', text:'Qual é a coisa mais bonita que você viu ou sentiu nesta semana?', cat:'Beleza' },
            { emoji:'🎭', text:'Em que situação você se sentiu "mais você mesmo" recentemente?', cat:'Identidade' },
            { emoji:'⚡', text:'O que te dá energia e motivação nos dias difíceis?', cat:'Motivação' },
            { emoji:'🌍', text:'Algo no mundo que te preocupa. Como isso te afeta pessoalmente?', cat:'Mundo' },
            { emoji:'🧘', text:'Como está seu equilíbrio entre trabalho, descanso e lazer?', cat:'Equilíbrio' },
        ];
        let lastPromptIndex = -1;

        function showDailyPrompt() {
            closeDropdown(); closeMobileMenu();
            let idx;
            do { idx = Math.floor(Math.random() * journalPrompts.length); } while (idx === lastPromptIndex);
            lastPromptIndex = idx;
            _showPrompt(idx);
        }

        function _showPrompt(idx) {
            const p = journalPrompts[idx];
            const existing = document.getElementById('promptModal');
            if (existing) existing.remove();
            const el = document.createElement('div');
            el.className = 'modal show';
            el.id = 'promptModal';
            el.onclick = e => { if(e.target===el) el.remove(); };
            el.innerHTML = `<div class="modal-content" style="max-width:520px;" onclick="event.stopPropagation()">
                <div class="modal-header"><h2><i class="fas fa-lightbulb"></i> Inspiração para Escrever</h2><button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button></div>
                <div class="prompt-card">
                    <span class="prompt-emoji">${p.emoji}</span>
                    <div class="prompt-text">"${p.text}"</div>
                    <span class="prompt-category"><i class="fas fa-tag"></i> ${p.cat}</span>
                </div>
                <div class="prompt-btn-row">
                    <button class="btn" onclick="let n=(lastPromptIndex+1)%${journalPrompts.length};lastPromptIndex=n-1;_showPrompt(n)"><i class="fas fa-random"></i> Outra</button>
                    <button class="btn btn-primary" onclick="usePromptAsPost('${p.text.replace(/'/g,"\\'")}');this.closest('.modal').remove()"><i class="fas fa-pen"></i> Escrever sobre isso</button>
                </div>
            </div>`;
            document.body.appendChild(el);
        }

        function usePromptAsPost(promptText) {
            openModal('new');
            setTimeout(() => {
                const desc = document.getElementById('postDescription');
                if (desc && !desc.value) { desc.value = `Reflexão: "${promptText}"\n\n`; desc.dispatchEvent(new Event('input')); desc.focus(); desc.setSelectionRange(desc.value.length, desc.value.length); }
            }, 200);
        }

        // === LINHA DO TEMPO ===
        function showTimeline() {
            closeDropdown(); closeMobileMenu();
            const pub = posts.filter(p => !p.isDraft).sort((a,b) => b.timestamp - a.timestamp);
            if (!pub.length) { showNotification('Nenhuma publicação para mostrar na linha do tempo','info'); return; }
            // Group by year and month
            const grouped = {};
            pub.forEach(p => {
                const d = new Date(p.timestamp);
                const yr = d.getFullYear();
                const mo = d.getMonth();
                if (!grouped[yr]) grouped[yr] = {};
                if (!grouped[yr][mo]) grouped[yr][mo] = [];
                grouped[yr][mo].push(p);
            });
            const monthNames = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            const fullMonthNames = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            let html = '<div class="timeline-wrap">';
            const years = Object.keys(grouped).sort((a,b) => b-a);
            years.forEach(yr => {
                html += `<div class="timeline-year-group"><div class="timeline-year-label">${yr}</div>`;
                const months = Object.keys(grouped[yr]).sort((a,b) => b-a);
                months.forEach(mo => {
                    const ps = grouped[yr][mo];
                    html += `<div class="timeline-month-group">
                        <div class="timeline-month-label">${monthNames[mo]}</div>
                        <div class="timeline-line"><div class="timeline-dot"></div><div class="timeline-vert"></div></div>
                        <div class="timeline-posts">
                            ${ps.map(p => {
                                const d = new Date(p.timestamp);
                                const mood = p.moodEmoji ? `${p.moodEmoji} ` : '';
                                const day = d.getDate().toString().padStart(2,'0');
                                return `<div class="timeline-post-card" onclick="this.closest('.modal').remove();showPostById(${p.id})">
                                    <div class="timeline-post-title">${p.title}</div>
                                    <div class="timeline-post-meta"><span>${day} ${fullMonthNames[mo]}</span>${mood?`<span>${mood}</span>`:''}${p.isFavorite?'<span>⭐</span>':''}${p.hashtags.length?`<span style="color:#555">${p.hashtags.slice(0,2).join(' ')}</span>`:''}</div>
                                    ${p.description?`<div class="timeline-post-preview">${p.description.replace(/<[^>]*>/g,'')}</div>`:''}
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
                });
                html += '</div>';
            });
            html += '</div>';
            const el = document.createElement('div');
            el.className = 'modal show';
            el.onclick = e => { if(e.target===el) el.remove(); };
            el.innerHTML = `<div class="modal-content" style="max-width:680px;" onclick="event.stopPropagation()">
                <div class="modal-header"><h2><i class="fas fa-stream"></i> Linha do Tempo</h2><button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button></div>
                <p style="color:#555;font-size:0.85em;margin-bottom:16px;">${pub.length} publicaç${pub.length===1?'ão':'ões'} · Clique em um item para ver o post</p>
                ${html}
            </div>`;
            document.body.appendChild(el);
        }

        // === NOTA RÁPIDA ===
        let quickNoteSaveTimer = null;
        function toggleQuickNote() {
            const panel = document.getElementById('quickNotePanel');
            panel.classList.toggle('show');
            if (panel.classList.contains('show')) {
                const saved = localStorage.getItem('quickNote') || '';
                document.getElementById('quickNoteText').value = saved;
                document.getElementById('quickNoteSaved').textContent = saved ? 'Nota salva' : '';
                setTimeout(() => document.getElementById('quickNoteText').focus(), 100);
            }
        }
        function autoSaveQuickNote() {
            clearTimeout(quickNoteSaveTimer);
            quickNoteSaveTimer = setTimeout(() => {
                const val = document.getElementById('quickNoteText').value;
                localStorage.setItem('quickNote', val);
                document.getElementById('quickNoteSaved').textContent = val ? '✓ Salvo' : '';
            }, 600);
        }
        function clearQuickNote() {
            document.getElementById('quickNoteText').value = '';
            localStorage.removeItem('quickNote');
            document.getElementById('quickNoteSaved').textContent = '';
        }
        function useQuickNoteAsPost() {
            const val = document.getElementById('quickNoteText').value.trim();
            if (!val) { showNotification('A nota está vazia','warning'); return; }
            toggleQuickNote();
            openModal('new');
            setTimeout(() => {
                const desc = document.getElementById('postDescription');
                if (desc) { desc.value = val; desc.dispatchEvent(new Event('input')); }
            }, 200);
        }

        // === FILTRO POR HUMOR ===
        let moodFilter = null;
        function renderMoodFilter() {
            const moods = [...new Set(posts.filter(p=>!p.isDraft&&p.moodEmoji).map(p=>JSON.stringify({emoji:p.moodEmoji,text:p.moodText,mood:p.mood})))].map(s=>JSON.parse(s));
            const wrap = document.getElementById('moodFilterWrap');
            const row = document.getElementById('moodFilterRow');
            if (!moods.length) { wrap.style.display='none'; return; }
            wrap.style.display = 'block';
            let html = '<span class="mood-filter-label"><i class="fas fa-smile"></i> Humor:</span>';
            if (moodFilter) html += `<div class="mood-filter-chip active" onclick="clearMoodFilter()">✕ Limpar</div>`;
            html += moods.map(m => `<div class="mood-filter-chip${moodFilter===m.mood?' active':''}" onclick="setMoodFilter('${m.mood}')" title="${m.text}">${m.emoji}</div>`).join('');
            row.innerHTML = html;
        }
        function setMoodFilter(mood) {
            moodFilter = moodFilter === mood ? null : mood;
            renderMoodFilter();
            renderPosts();
            if (moodFilter) { const p = posts.find(x=>x.mood===mood); showActiveFilterBanner(p?p.moodEmoji+' '+p.moodText:'Humor', 'smile'); }
            else hideActiveFilterBanner();
        }
        function clearMoodFilter() { moodFilter = null; renderMoodFilter(); renderPosts(); hideActiveFilterBanner(); }

        // === EXPORTAR OPÇÕES ===
        function showExportOptions() {
            closeDropdown(); closeMobileMenu();
            const el = document.createElement('div');
            el.className = 'modal show';
            el.onclick = e => { if(e.target===el) el.remove(); };
            el.innerHTML = `<div class="modal-content" style="max-width:480px;" onclick="event.stopPropagation()">
                <div class="modal-header"><h2><i class="fas fa-download"></i> Exportar Diário</h2><button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button></div>
                <p style="color:#666;font-size:0.87em;margin-bottom:16px;">Escolha o formato de exportação:</p>
                <div class="export-options">
                    <div class="export-opt-card" onclick="exportData();this.closest('.modal').remove()">
                        <div class="export-opt-icon"><i class="fas fa-archive" style="font-size:0.7em;"></i></div>
                        <div class="export-opt-label">JSON (Backup)</div>
                        <div class="export-opt-sub">Backup completo para importar depois</div>
                    </div>
                    <div class="export-opt-card" onclick="exportAsTxt();this.closest('.modal').remove()">
                        <div class="export-opt-icon"><i class="fas fa-file-alt" style="font-size:0.7em;"></i></div>
                        <div class="export-opt-label">Texto (.txt)</div>
                        <div class="export-opt-sub">Versão legível para leitura e impressão</div>
                    </div>
                </div>
                <div style="margin-top:14px;padding:14px;background:rgba(42,42,42,0.3);border-radius:10px;font-size:0.78em;color:#555;">
                    <i class="fas fa-info-circle"></i> As imagens e áudios não são incluídos na exportação TXT. Use o JSON para backup completo.
                </div>
            </div>`;
            document.body.appendChild(el);
        }

        function exportAsTxt() {
            const pub = posts.filter(p=>!p.isDraft).sort((a,b)=>a.timestamp-b.timestamp);
            if (!pub.length) { showNotification('Nenhuma publicação para exportar','warning'); return; }
            const header = `MEIN DIÁRIO DIGITAL\nExportado em: ${new Date().toLocaleString('pt-BR')}\nTotal de publicações: ${pub.length}\n${'='.repeat(60)}\n\n`;
            const body = pub.map((p,i) => {
                const d = new Date(p.timestamp);
                const dateStr = d.toLocaleDateString('pt-BR', {weekday:'long',year:'numeric',month:'long',day:'numeric'});
                const timeStr = d.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
                let txt = `[${i+1}] ${p.title.toUpperCase()}\n`;
                txt += `📅 ${dateStr} às ${timeStr}\n`;
                if (p.moodEmoji) txt += `${p.moodEmoji} ${p.moodText}\n`;
                if (p.hashtags.length) txt += `🏷️ ${p.hashtags.join(' ')}\n`;
                txt += `${'-'.repeat(50)}\n`;
                txt += `${p.description}\n`;
                if (p.isFavorite) txt += `\n⭐ (Favorito)\n`;
                txt += `\n${'='.repeat(60)}\n\n`;
                return txt;
            }).join('');
            const content = header + body;
            const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download=`diario-${new Date().toISOString().split('T')[0]}.txt`; a.click();
            URL.revokeObjectURL(url);
            showNotification('Exportado como TXT!','success');
        }

        // === TEMAS DE COR ===
        const colorThemes = [
            { id:'theme-white', color:'#888', label:'Padrão' },
            { id:'theme-purple', color:'#c084fc', label:'Roxo' },
            { id:'theme-blue', color:'#60a5fa', label:'Azul' },
            { id:'theme-green', color:'#4ade80', label:'Verde' },
            { id:'theme-rose', color:'#fb7185', label:'Rosa' },
            { id:'theme-amber', color:'#fbbf24', label:'Âmbar' },
            { id:'theme-cyan', color:'#22d3ee', label:'Ciano' },
        ];
        function applyTheme(themeId) {
            colorThemes.forEach(t => document.body.classList.remove(t.id));
            if (themeId !== 'theme-white') document.body.classList.add(themeId);
            localStorage.setItem('colorTheme', themeId);
            prefs.colorTheme = themeId;
            localStorage.setItem('userPrefs', JSON.stringify(prefs));
        }
        function loadTheme() {
            const saved = localStorage.getItem('colorTheme') || 'theme-white';
            applyTheme(saved);
        }
        function renderThemePicker() {
            const cur = localStorage.getItem('colorTheme') || 'theme-white';
            return `<div class="theme-picker">${colorThemes.map(t=>`<div class="theme-dot${cur===t.id?' active':''}" style="background:${t.color};" onclick="applyTheme('${t.id}');document.querySelectorAll('.theme-dot').forEach(d=>d.classList.remove('active'));this.classList.add('active');" title="${t.label}"><i class="fas fa-check"></i></div>`).join('')}</div>`;
        }

        // === ESTATÍSTICAS MELHORADAS ===
        function buildHeatmap() {
            const pub = posts.filter(p=>!p.isDraft);
            if (!pub.length) return '';
            const counts = {};
            pub.forEach(p => {
                const d = new Date(p.timestamp);
                const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                counts[key] = (counts[key]||0)+1;
            });
            // Last 84 days (12 weeks)
            const cells = [];
            const today = new Date(); today.setHours(23,59,59,0);
            for (let i = 83; i >= 0; i--) {
                const d = new Date(today); d.setDate(d.getDate()-i);
                const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                const c = counts[key]||0;
                const lvl = c===0?'':c===1?'l1':c===2?'l2':c<=4?'l3':'l4';
                const dateStr = d.toLocaleDateString('pt-BR');
                cells.push(`<div class="heatmap-cell ${lvl}" title="${dateStr}: ${c} post${c!==1?'s':''}"></div>`);
            }
            return `<div class="heatmap-wrap">
                <div class="heatmap-title"><i class="fas fa-fire"></i> Atividade dos últimos 84 dias <span style="margin-left:auto;display:flex;gap:4px;align-items:center;font-size:0.9em;">Menos <div class="heatmap-cell"></div><div class="heatmap-cell l1"></div><div class="heatmap-cell l2"></div><div class="heatmap-cell l3"></div><div class="heatmap-cell l4"></div> Mais</span></div>
                <div class="heatmap-grid">${cells.join('')}</div>
            </div>`;
        }

        // === PATCH showStats COM MELHORIAS ===
        const _origShowStats = showStats;
        showStats = function() {
            closeDropdown(); closeMobileMenu();
            const pub=posts.filter(p=>!p.isDraft),dr=posts.filter(p=>p.isDraft),fav=posts.filter(p=>p.isFavorite);
            const words=pub.reduce((s,p)=>s+(p.description?p.description.split(/\s+/).filter(w=>w).length:0),0);
            const imgs=posts.filter(p=>p.images?p.images.length>0:p.image).length;
            const auds=posts.filter(p=>p.audio).length;
            const prot=posts.filter(p=>p.postPassword).length;
            const udays=new Set(pub.map(p=>new Date(p.timestamp).toDateString())).size;
            const mh=getMostHashtag();
            const fp=posts.length?new Date(Math.min(...posts.map(p=>p.timestamp))):null;
            const ds=fp?Math.floor((Date.now()-fp.getTime())/86400000):0;
            const { streak, longest } = calculateStreak();
            // Mood distribution
            const moodCount = {}; pub.forEach(p=>{ if(p.moodEmoji){moodCount[p.moodEmoji]=(moodCount[p.moodEmoji]||0)+1;} });
            const topMoods = Object.entries(moodCount).sort((a,b)=>b[1]-a[1]).slice(0,5);
            const sb=(v,l,col='#fff')=>`<div style="text-align:center;padding:18px;background:rgba(42,42,42,0.5);border-radius:12px;"><div style="font-size:2.2em;font-weight:700;color:${col};">${v}</div><div style="color:#888;margin-top:4px;font-size:0.85em;">${l}</div></div>`;
            document.body.insertAdjacentHTML('beforeend',`
                <div class="modal show" onclick="if(event.target===this)this.remove()">
                    <div class="modal-content" style="max-width:720px;" onclick="event.stopPropagation()">
                        <div class="modal-header"><h2><i class="fas fa-chart-bar"></i> Estatísticas</h2><button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button></div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-bottom:14px;">
                            ${sb(pub.length,'Publicações')}${sb(words.toLocaleString(),'Palavras')}${sb(udays,'Dias ativos')}${sb(streak,'Streak','#ff8200')}${sb(longest,'Recorde','#fbbf24')}${sb(dr.length,'Rascunhos')}${sb(fav.length,'Favoritos','#ffaa00')}${sb(imgs,'Com fotos')}
                        </div>
                        ${topMoods.length?`<div style="margin-bottom:14px;padding:16px;background:rgba(42,42,42,0.5);border-radius:12px;"><div style="color:#aaa;margin-bottom:10px;font-size:0.82em;font-weight:600;text-transform:uppercase;letter-spacing:1px;"><i class="fas fa-smile"></i> Humores mais frequentes</div><div style="display:flex;gap:12px;flex-wrap:wrap;">${topMoods.map(([e,c])=>`<div style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(30,30,30,0.8);border-radius:20px;font-size:0.9em;">${e} <span style="color:#666;font-size:0.85em;">×${c}</span></div>`).join('')}</div></div>`:''}
                        <div style="margin-bottom:14px;padding:16px;background:rgba(42,42,42,0.5);border-radius:12px;display:flex;gap:16px;flex-wrap:wrap;">
                            <div style="flex:1;min-width:150px;"><div style="color:#aaa;font-size:0.82em;margin-bottom:6px;"><i class="fas fa-hashtag"></i> Tag mais usada</div><div style="font-size:1.1em;">${mh||'Nenhuma'}</div></div>
                            ${ds>0?`<div style="flex:1;min-width:150px;"><div style="color:#aaa;font-size:0.82em;margin-bottom:6px;"><i class="fas fa-calendar"></i> Diário criado há</div><div style="font-size:1.1em;">${ds} dias</div></div>`:''}
                            ${words>0?`<div style="flex:1;min-width:150px;"><div style="color:#aaa;font-size:0.82em;margin-bottom:6px;"><i class="fas fa-book-open"></i> Média por post</div><div style="font-size:1.1em;">${Math.round(words/pub.length)} palavras</div></div>`:''}
                        </div>
                        ${buildHeatmap()}
                    </div>
                </div>`);
        };

        // === PATCH getFiltered PARA SUPORTAR MOOD FILTER ===
        const _origGetFiltered = getFiltered;
        getFiltered = function() {
            let f = _origGetFiltered();
            if (moodFilter) f = f.filter(p => p.mood === moodFilter);
            return f;
        };

        // === PATCH initApp ===
        const _origInitApp = initApp;
        initApp = function() {
            _origInitApp();
            renderStreakBadge();
            renderMoodFilter();
            loadTheme();
        };

        // === PATCH renderPosts para atualizar mood filter ===
        const _origRenderPosts = renderPosts;
        renderPosts = function() {
            _origRenderPosts();
            renderMoodFilter();
        };

        // === SETTINGS: Adicionar seção de tema ===
        const _origOpenSettings = openSettings;
        openSettings = function() {
            _origOpenSettings();
            // Inject theme section into settings
            setTimeout(() => {
                const content = document.getElementById('settingsContent');
                if (!content) return;
                const themeSection = document.createElement('div');
                themeSection.className = 'settings-section';
                themeSection.style.cssText = 'margin-bottom:28px;padding-top:4px;';
                themeSection.innerHTML = `<div class="settings-section-title"><i class="fas fa-palette"></i> Tema de Cores</div>
                    <div class="settings-row">
                        <div><div class="settings-row-label">Cor de destaque</div><div class="settings-row-sub">Personaliza bordas, badges e acentos do diário</div></div>
                    </div>
                    ${renderThemePicker()}`;
                content.insertBefore(themeSection, content.firstChild);
            }, 50);
        };

        // === FIREBASE BRIDGE (expose state to module script) ===
        window.getAppPosts   = () => posts;
        window.getAppTrash   = () => trash;
        window.getPostById   = (id) => posts.find(p => p.id === id);
        window.loadStateFromStorage = function() {
            posts        = JSON.parse(localStorage.getItem('diaryPosts'))   || [];
            trash        = JSON.parse(localStorage.getItem('diaryTrash'))   || [];
            userName     = localStorage.getItem('userName') || '';
            sortOrder    = localStorage.getItem('sortOrder') || 'newest';
            viewMode     = localStorage.getItem('viewMode') || 'list';
            menuBadges   = JSON.parse(localStorage.getItem('menuBadges'))   || { drafts:0, favorites:0, gallery:0, trash:0 };
            usedHashtags = JSON.parse(localStorage.getItem('usedHashtags')) || [];
            appPassword  = localStorage.getItem('appPassword') || null;
            appUnlocked  = !appPassword;
            const savedPrefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
            Object.assign(prefs, savedPrefs);
        };

    </script>

    <!-- Firebase Integration (v4 – Realtime Database) -->
    <script type="module">
        import { initializeApp }                                          from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup,
                 signInWithRedirect, getRedirectResult,
                 signOut, onAuthStateChanged }                            from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getDatabase, ref, set, get, remove, child, update }     from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
        import { getStorage, ref as sRef,
                 uploadString, getDownloadURL }                           from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

        // ── Config ────────────────────────────────────────────────
        const firebaseConfig = {
            apiKey:            "AIzaSyAfFu0ZJldAF_eYWQ4KKXMmeaz0LK1xvAk",
            authDomain:        "meudiariodigital-3108a.firebaseapp.com",
            projectId:         "meudiariodigital-3108a",
            storageBucket:     "meudiariodigital-3108a.firebasestorage.app",
            messagingSenderId: "478403433306",
            appId:             "1:478403433306:web:0c1b617fb21a20ae681963",
            databaseURL:       "https://meudiariodigital-3108a-default-rtdb.firebaseio.com"
        };

        const app      = initializeApp(firebaseConfig);
        const auth     = getAuth(app);
        const db       = getDatabase(app);
        const stor     = getStorage(app);
        const provider = new GoogleAuthProvider();
        provider.addScope('profile');
        provider.addScope('email');
        provider.setCustomParameters({ prompt: 'select_account' });

        // ── Enable login button once module is ready ──────────────
        const GSVG = `<svg width="22" height="22" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.1H42V20H24v8h11.3C33.7 32.3 29.3 35 24 35c-6.1 0-11-4.9-11-11s4.9-11 11-11c2.8 0 5.3 1 7.2 2.7l5.7-5.7C33.5 7.3 29 5 24 5 13 5 4 14 4 25s9 20 20 20 20-9 20-20c0-1.3-.1-2.7-.4-4z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.6 15.6 19 13 24 13c2.8 0 5.3 1 7.2 2.7l5.7-5.7C33.5 7.3 29 5 24 5 16.3 5 9.7 9.2 6.3 14.7z"/><path fill="#4CAF50" d="M24 45c5.2 0 9.9-1.9 13.5-5L31.6 34c-1.9 1.4-4.3 2.2-7.6 2.2-5.2 0-9.6-3.5-11.2-8.3L6.2 33C9.5 39.6 16.2 45 24 45z"/><path fill="#1976D2" d="M43.6 20.1H42V20H24v8h11.3c-.8 2.3-2.3 4.2-4.3 5.6l.1-.1 5.9 5.1C36.5 38 44 32 44 25c0-1.3-.1-2.7-.4-4z"/></svg>`;
        (function() {
            const btn = document.getElementById('googleSignInBtn');
            if (btn) { btn.disabled = false; btn.classList.remove('loading'); btn.innerHTML = GSVG + ' Entrar com o Google'; }
        })();

        // ── Sync UI ───────────────────────────────────────────────
        let syncTimer = null;
        function showSync(msg) {
            clearTimeout(syncTimer);
            const el = document.getElementById('syncIndicator');
            const m  = document.getElementById('syncMsg');
            if (el) { el.classList.add('show'); el.classList.remove('error'); }
            if (m)    m.textContent = msg || 'Salvando...';
        }
        function hideSync() {
            syncTimer = setTimeout(() => {
                const el = document.getElementById('syncIndicator');
                if (el) el.classList.remove('show');
            }, 1500);
        }
        function showSyncError(msg) {
            const el = document.getElementById('syncIndicator');
            const m  = document.getElementById('syncMsg');
            if (el) { el.classList.add('show', 'error'); }
            if (m)    m.textContent = '⚠ ' + msg;
            setTimeout(() => { if (el) el.classList.remove('show', 'error'); }, 5000);
        }

        // ── UI helpers para o botão de login ──────────────────────
        function setLoginBtnLoading(msg) {
            const btn = document.getElementById('googleSignInBtn');
            if (btn) { btn.disabled = true; btn.classList.add('loading'); btn.innerHTML = '<span class="sync-spin">↻</span> ' + (msg || 'Entrando...'); }
        }
        function resetLoginBtn() {
            const btn = document.getElementById('googleSignInBtn');
            if (btn) { btn.disabled = false; btn.classList.remove('loading'); btn.innerHTML = GSVG + ' Entrar com o Google'; }
        }
        function showLoginError(msg) {
            const box = document.querySelector('.login-box');
            let err = document.getElementById('loginErrorMsg');
            if (!err) {
                err = document.createElement('div');
                err.id = 'loginErrorMsg';
                err.style.cssText = 'margin-top:14px;padding:10px 14px;background:rgba(239,83,80,0.1);border:1px solid rgba(239,83,80,0.25);border-radius:10px;color:#ef5350;font-size:0.82em;line-height:1.5;';
                if (box) box.appendChild(err);
            }
            err.textContent = msg;
            err.style.display = 'block';
            setTimeout(() => { if (err) err.style.display = 'none'; }, 7000);
        }

        // ── Strip base64 (RTDB tem limite de 10 MB por nó) ───────
        function stripMedia(post) {
            const p = { ...post };
            if (Array.isArray(p.images))
                p.images = p.images.map(i => (i && i.startsWith('data:')) ? null : i).filter(Boolean);
            if (p.image && p.image.startsWith('data:')) p.image = null;
            if (p.audio && p.audio.startsWith('data:')) p.audio = null;
            // Remove undefined values (RTDB não aceita undefined)
            return JSON.parse(JSON.stringify(p));
        }

        // ── Upload mídia para Storage e atualiza RTDB ─────────────
        async function uploadMediaBg(post, uid) {
            let changed = false;
            const p = { ...post };
            if (Array.isArray(p.images)) {
                const urls = [];
                for (let i = 0; i < p.images.length; i++) {
                    const img = p.images[i];
                    if (img && img.startsWith('data:')) {
                        try {
                            const r = sRef(stor, `u/${uid}/img/${p.id}/${i}`);
                            await uploadString(r, img, 'data_url');
                            urls.push(await getDownloadURL(r));
                            changed = true;
                        } catch(e) { console.error('uploadImg error', e); urls.push(null); }
                    } else { urls.push(img); }
                }
                p.images = urls.filter(Boolean);
                p.image  = p.images[0] || null;
            }
            if (post.audio && post.audio.startsWith('data:')) {
                try {
                    const r = sRef(stor, `u/${uid}/audio/${p.id}`);
                    await uploadString(r, post.audio, 'data_url');
                    p.audio = await getDownloadURL(r);
                    changed = true;
                } catch(e) { console.error('uploadAudio error', e); p.audio = null; }
            }
            if (changed) {
                // Atualiza só os campos de mídia no RTDB
                await update(ref(db, `users/${uid}/posts/${p.id}`), {
                    images: p.images || [],
                    image:  p.image  || null,
                    audio:  p.audio  || null
                });
                // Atualiza localStorage
                try {
                    const arr = JSON.parse(localStorage.getItem('diaryPosts') || '[]');
                    const idx = arr.findIndex(x => x.id === p.id);
                    if (idx !== -1) {
                        arr[idx] = { ...arr[idx], images: p.images, image: p.image, audio: p.audio };
                        localStorage.setItem('diaryPosts', JSON.stringify(arr));
                        if (typeof window.loadStateFromStorage === 'function') window.loadStateFromStorage();
                    }
                } catch {}
            }
        }

        // ── Helpers de escrita no RTDB ────────────────────────────
        function rtPost(post, uid) {
            const lean = stripMedia(post);
            set(ref(db, `users/${uid}/posts/${post.id}`), lean).catch(e => {
                console.error('[RTDB] rtPost error:', e.code, e.message);
                showSyncError('Erro ao salvar post: ' + (e.code || e.message));
            });
            uploadMediaBg(post, uid).catch(console.error);
        }

        function rtDelPost(id, uid) {
            remove(ref(db, `users/${uid}/posts/${id}`)).catch(console.error);
        }

        function rtTrash(post, uid) {
            const lean = stripMedia(post);
            set(ref(db, `users/${uid}/trash/${post.id}`), lean).catch(console.error);
        }

        function rtDelTrash(id, uid) {
            remove(ref(db, `users/${uid}/trash/${id}`)).catch(console.error);
        }

        function rtProfile(uid) {
            const profile = {
                userName:     localStorage.getItem('userName')     || '',
                userBio:      localStorage.getItem('userBio')      || '',
                writingGoal:  localStorage.getItem('writingGoal')  || '',
                prefs:        JSON.parse(localStorage.getItem('userPrefs')    || '{}'),
                usedHashtags: JSON.parse(localStorage.getItem('usedHashtags') || '[]'),
                sortOrder:    localStorage.getItem('sortOrder')    || 'newest',
                viewMode:     localStorage.getItem('viewMode')     || 'list',
                menuBadges:   JSON.parse(localStorage.getItem('menuBadges')   || '{}'),
                appPassword:  localStorage.getItem('appPassword')  || null,
                theme:        localStorage.getItem('theme')        || null,
            };
            return set(ref(db, `users/${uid}/profile`), profile);
        }

        // ── Carrega dados da nuvem → localStorage ─────────────────
        async function loadCloud(uid) {
            showSync('Carregando seu diário...');
            try {
                const snap = await get(child(ref(db), `users/${uid}`));
                if (snap.exists()) {
                    const data = snap.val();

                    // Perfil
                    const prof = data.profile || {};
                    if (prof.userName)    localStorage.setItem('userName',     prof.userName);
                    if (prof.userBio)     localStorage.setItem('userBio',      prof.userBio);
                    if (prof.writingGoal) localStorage.setItem('writingGoal',  prof.writingGoal);
                    if (prof.prefs && Object.keys(prof.prefs).length)
                        localStorage.setItem('userPrefs', JSON.stringify(prof.prefs));
                    if (prof.usedHashtags && prof.usedHashtags.length)
                        localStorage.setItem('usedHashtags', JSON.stringify(prof.usedHashtags));
                    if (prof.sortOrder)   localStorage.setItem('sortOrder',    prof.sortOrder);
                    if (prof.viewMode)    localStorage.setItem('viewMode',      prof.viewMode);
                    if (prof.menuBadges)  localStorage.setItem('menuBadges',   JSON.stringify(prof.menuBadges));
                    if (prof.appPassword) localStorage.setItem('appPassword',  prof.appPassword);
                    if (prof.theme)       localStorage.setItem('theme',        prof.theme);

                    // Posts
                    if (data.posts) {
                        const cloud = Object.values(data.posts);
                        // Preserva mídia base64 local que ainda não foi enviada
                        const local    = JSON.parse(localStorage.getItem('diaryPosts') || '[]');
                        const localMap = Object.fromEntries(local.map(p => [String(p.id), p]));
                        const merged   = cloud.map(cp => {
                            const lp = localMap[String(cp.id)];
                            if (lp) {
                                if ((!cp.images || !cp.images.length) && lp.images && lp.images.length) cp.images = lp.images;
                                if (!cp.image && lp.image) cp.image = lp.image;
                                if (!cp.audio && lp.audio) cp.audio = lp.audio;
                            }
                            return cp;
                        });
                        localStorage.setItem('diaryPosts', JSON.stringify(merged));
                    }

                    // Lixeira
                    if (data.trash) {
                        localStorage.setItem('diaryTrash', JSON.stringify(Object.values(data.trash)));
                    }
                }
                hideSync();
            } catch (e) {
                console.error('[RTDB] loadCloud error:', e.code, e.message, e);
                let msg = 'Erro ao carregar dados da nuvem. Usando dados locais.';
                if (e.code === 'PERMISSION_DENIED' || (e.message && e.message.includes('permission'))) {
                    msg = 'Permissão negada no banco de dados. Verifique as Rules no Firebase Console.';
                } else if (e.code) {
                    msg = 'Erro RTDB [' + e.code + ']. Usando dados locais.';
                }
                showSyncError(msg);
            }
        }

        // ── Aplica patches nas funções do app ─────────────────────
        function applyPatches(uid) {

            // finalizeSave — salva local imediatamente + nuvem assíncrono
            const _fin = window.finalizeSave;
            window.finalizeSave = async function(post, isDraft) {
                _fin(post, isDraft);
                showSync('Salvando...');
                try {
                    await Promise.all([
                        set(ref(db, `users/${uid}/posts/${post.id}`), stripMedia(post)),
                        rtProfile(uid)
                    ]);
                    hideSync();
                    uploadMediaBg(post, uid).catch(console.error);
                } catch (e) {
                    console.error('[RTDB] finalizeSave error:', e.code, e.message);
                    showSyncError('Erro ao salvar: ' + (e.code || e.message || 'desconhecido'));
                }
            };

            // saveNameFromPopup
            const _namePopup = window.saveNameFromPopup;
            window.saveNameFromPopup = function() {
                _namePopup();
                rtProfile(uid).catch(console.error);
            };

            // saveProfile
            const _savePro = window.saveProfile;
            window.saveProfile = function() {
                _savePro();
                rtProfile(uid).catch(console.error);
            };

            // deletePost
            const _del = window.deletePost;
            window.deletePost = async function(id) {
                await _del(id);
                rtDelPost(id, uid);
                const trashArr = JSON.parse(localStorage.getItem('diaryTrash') || '[]');
                const moved = trashArr.find(p => p.id === id);
                if (moved) rtTrash(moved, uid);
            };

            // restoreFromTrash
            const _restore = window.restoreFromTrash;
            window.restoreFromTrash = function(id) {
                _restore(id);
                const p = (window.getPostById || (() => null))(id);
                if (p) rtPost(p, uid);
                rtDelTrash(id, uid);
            };

            // deleteFromTrashPermanently
            const _delPerm = window.deleteFromTrashPermanently;
            window.deleteFromTrashPermanently = async function(id) {
                await _delPerm(id);
                rtDelTrash(id, uid);
            };

            // emptyTrashAll
            const _emptyTrash = window.emptyTrashAll;
            window.emptyTrashAll = async function() {
                await _emptyTrash();
                remove(ref(db, `users/${uid}/trash`)).catch(console.error);
            };

            // togglePin / toggleFavorite / publishDraft / moveToDraft
            const wrap = (orig) => function(id) {
                orig(id);
                const p = (window.getPostById || (() => null))(id);
                if (p) rtPost(p, uid);
            };
            window.togglePin      = wrap(window.togglePin);
            window.toggleFavorite = wrap(window.toggleFavorite);
            window.publishDraft   = wrap(window.publishDraft);
            window.moveToDraft    = wrap(window.moveToDraft);

            // duplicatePost
            const _dup = window.duplicatePost;
            window.duplicatePost = function(id) {
                _dup(id);
                const posts = (window.getAppPosts || (() => []))();
                if (posts.length) rtPost(posts[0], uid);
            };

            // Mudanças só de perfil
            const wrapPro = (orig) => function(...args) {
                orig(...args);
                rtProfile(uid).catch(console.error);
            };
            window.updatePref     = wrapPro(window.updatePref);
            window.addHashtag     = wrapPro(window.addHashtag);
            window.setSortOrder   = wrapPro(window.setSortOrder);
            window.setViewMode    = wrapPro(window.setViewMode);
            window.addMenuBadge   = wrapPro(window.addMenuBadge);
            window.clearMenuBadge = wrapPro(window.clearMenuBadge);

            // doReset — apaga tudo na nuvem também
            const _reset = window.doReset;
            window.doReset = async function() {
                await _reset();
                showSync('Limpando dados na nuvem...');
                try {
                    await remove(ref(db, `users/${uid}`));
                    hideSync();
                } catch (e) { showSyncError('Erro ao limpar dados na nuvem'); }
            };
        }

        // ── Login com Google ──────────────────────────────────────
        window.signInWithGoogle = async function() {
            const btn = document.getElementById('googleSignInBtn');
            if (btn && btn.disabled) return;
            setLoginBtnLoading('Entrando...');
            try {
                await signInWithPopup(auth, provider);
            } catch (e) {
                console.error('[Auth] signInWithPopup error:', e.code, e.message);
                const popupErros = ['auth/popup-blocked', 'auth/popup-closed-by-user', 'auth/cancelled-popup-request'];
                if (popupErros.includes(e.code)) {
                    setLoginBtnLoading('Redirecionando...');
                    try {
                        await signInWithRedirect(auth, provider);
                    } catch (e2) {
                        resetLoginBtn();
                        showLoginError('Não foi possível iniciar o login. Verifique sua conexão.');
                    }
                } else if (e.code === 'auth/network-request-failed') {
                    resetLoginBtn();
                    showLoginError('Sem conexão com a internet. Tente novamente.');
                } else if (e.code === 'auth/unauthorized-domain') {
                    resetLoginBtn();
                    showLoginError('Domínio não autorizado. Adicione este domínio no Firebase Console → Authentication → Settings.');
                } else {
                    resetLoginBtn();
                    showLoginError('Erro ao fazer login: ' + (e.message || e.code || 'erro desconhecido'));
                }
            }
        };

        window.signOutUser = async function() {
            if (!confirm('Sair da sua conta?')) return;
            try { await signOut(auth); } catch (e) { alert('Erro ao sair. Tente novamente.'); }
        };

        // Captura resultado do login via redirect (quando popup é bloqueado)
        getRedirectResult(auth).then(result => {
            if (result && result.user) console.log('[Auth] Login via redirect OK:', result.user.displayName);
        }).catch(e => {
            if (e.code && e.code !== 'auth/no-auth-event') {
                console.error('[Auth] getRedirectResult error:', e.code);
                resetLoginBtn();
                showLoginError('Erro ao completar login: ' + (e.code || e.message));
            }
        });

        // ── Observador de autenticação ────────────────────────────
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const bar    = document.getElementById('userBar');
                const avatar = document.getElementById('userAvatar');
                const nameEl = document.getElementById('userBarName');
                if (bar)    bar.classList.add('show');
                if (avatar && user.photoURL) avatar.src = user.photoURL;
                if (nameEl) nameEl.textContent = user.displayName || user.email;

                if (!localStorage.getItem('userName') && user.displayName) {
                    localStorage.setItem('userName', user.displayName);
                }

                // 1. Carrega dados da nuvem
                await loadCloud(user.uid);

                // 2. Atualiza estado em memória
                if (typeof window.loadStateFromStorage === 'function') {
                    window.loadStateFromStorage();
                }

                // 3. Aplica patches antes de lançar o app
                applyPatches(user.uid);

                // 4. Esconde overlay e inicia o app
                const overlay = document.getElementById('loginOverlay');
                if (overlay) overlay.classList.add('hide');
                if (typeof window.launchApp === 'function') window.launchApp();

                // 5. Salva perfil inicial
                rtProfile(user.uid).catch(console.error);

            } else {
                const bar = document.getElementById('userBar');
                if (bar) bar.classList.remove('show');
                const overlay = document.getElementById('loginOverlay');
                if (overlay) overlay.classList.remove('hide');
                resetLoginBtn();
            }
        });
    </script>
</body>